# STM32 Build Workflow

## Overview

The STM32 Build workflow provides a comprehensive CI/CD solution for STM32 microcontroller projects using the ARM GCC toolchain (`arm-none-eabi-gcc`) and supports multiple build systems including Makefile, CMake, and STM32CubeIDE projects.

## Features

- **ARM GCC Toolchain**: Official `arm-none-eabi-gcc` toolchain support
- **Multiple Build Systems**: Makefile, CMake, and STM32CubeIDE
- **Multi-Family Support**: STM32F0/F1/F2/F3/F4/F7, STM32G0/G4, STM32H5/H7, STM32L0/L1/L4/L5, STM32U5, STM32WB/WL
- **Firmware Versioning**: Semantic versioning with automatic version embedding
- **Release Management**: Automated firmware releases with checksums
- **Static Analysis**: Integration with cppcheck, clang-tidy, and PC-lint
- **Unit Testing**: Support for Unity, CppUTest, and GoogleTest
- **Hardware Testing**: ST-Link integration for HIL testing

## Supported STM32 Families

| Family | Core | Description |
|--------|------|-------------|
| STM32F0 | Cortex-M0 | Entry-level, cost-optimized |
| STM32F1 | Cortex-M3 | Mainstream |
| STM32F2 | Cortex-M3 | High-performance |
| STM32F3 | Cortex-M4F | Mixed-signal with DSP |
| STM32F4 | Cortex-M4F | High-performance with DSP/FPU |
| STM32F7 | Cortex-M7 | High-performance |
| STM32G0 | Cortex-M0+ | Mainstream, low-power |
| STM32G4 | Cortex-M4F | Mixed-signal, motor control |
| STM32H5 | Cortex-M33 | High-performance with security |
| STM32H7 | Cortex-M7 | Highest performance |
| STM32L0 | Cortex-M0+ | Ultra-low-power |
| STM32L1 | Cortex-M3 | Ultra-low-power |
| STM32L4 | Cortex-M4F | Ultra-low-power with performance |
| STM32L5 | Cortex-M33 | Ultra-low-power with security |
| STM32U5 | Cortex-M33 | Ultra-low-power, next-gen |
| STM32WB | Cortex-M4/M0+ | Wireless (BLE, Zigbee, Thread) |
| STM32WL | Cortex-M4/M0+ | Wireless (LoRa, Sigfox) |

## Quick Start

### Basic Makefile Project

```yaml
name: STM32 Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build:
    uses: bauer-group/automation-templates/.github/workflows/stm32-build.yml@main
    with:
      build-system: makefile
      project-path: '.'
```

### CMake Project

```yaml
jobs:
  build:
    uses: bauer-group/automation-templates/.github/workflows/stm32-build.yml@main
    with:
      build-system: cmake
      target-mcu: STM32F407VG
      build-types: '["Release", "Debug"]'
```

### STM32CubeIDE Project

```yaml
jobs:
  build:
    uses: bauer-group/automation-templates/.github/workflows/stm32-build.yml@main
    with:
      build-system: cubeide
      cubeide-version: 1.16.0
      cubeide-project: MyProject
      cubeide-config: Release
```

**Supported CubeIDE Versions:**

| Version | Status | Notes |
|---------|--------|-------|
| `1.16.0` | Current (Default) | Latest stable |
| `1.15.1` | Stable | Previous release |
| `1.15.0` | Stable | |
| `1.14.1` | Stable | |
| `1.14.0` | Stable | |
| `1.13.2` | Stable | |
| `1.13.1` | Stable | |
| `1.13.0` | Stable | |
| `latest` | Rolling | Always newest |

Docker images provided by [xanderhendriks/stm32cubeide](https://hub.docker.com/r/xanderhendriks/stm32cubeide/tags).

## Configuration

### Input Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `config-file` | string | `default` | Configuration template to use |
| `build-system` | string | `makefile` | Build system: `makefile`, `cmake`, `cubeide` |
| `target-mcu` | string | - | Target MCU (e.g., STM32F407VG) |
| `target-mcus` | string | - | JSON array for matrix builds |
| `project-path` | string | `.` | Path to project directory |
| `build-types` | string | `["Release"]` | Build configurations |
| `toolchain-version` | string | `13.3.rel1` | ARM GCC toolchain version |
| `run-tests` | boolean | `true` | Run unit tests |
| `enable-analysis` | boolean | `false` | Run static analysis |
| `create-release` | boolean | `false` | Create GitHub release |
| `upload-artifacts` | boolean | `true` | Upload build artifacts |

### Configuration Templates

#### `default.yml` - Standard Projects

```yaml
build-system: makefile
toolchain-version: 13.3.rel1
build-type: Release
optimization: -O2
tests: true
analysis: false
```

#### `industrial.yml` - Safety-Critical

```yaml
build-system: cmake
toolchain-version: 13.3.rel1
build-types:
  - Release
  - Debug
optimization: -O2
warnings: -Wall -Wextra -Werror
tests: true
analysis: true
misra-check: true
static-analysis:
  - cppcheck
  - pc-lint
```

#### `prototype.yml` - Fast Development

```yaml
build-system: makefile
toolchain-version: 13.3.rel1
build-type: Debug
optimization: -Og
tests: false
analysis: false
```

## Build Systems

### Makefile (STM32CubeMX Generated)

The workflow automatically detects and uses Makefiles generated by STM32CubeMX:

```
project/
├── Makefile              # Main Makefile
├── Core/
│   ├── Inc/
│   └── Src/
├── Drivers/
└── startup_stm32*.s
```

**Required Makefile variables:**
```makefile
TARGET = firmware
BUILD_DIR = build
C_SOURCES = ...
ASM_SOURCES = ...
PREFIX = arm-none-eabi-
```

### CMake

For CMake projects, provide a toolchain file:

```cmake
# cmake/arm-none-eabi.cmake
set(CMAKE_SYSTEM_NAME Generic)
set(CMAKE_SYSTEM_PROCESSOR ARM)

set(CMAKE_C_COMPILER arm-none-eabi-gcc)
set(CMAKE_CXX_COMPILER arm-none-eabi-g++)
set(CMAKE_ASM_COMPILER arm-none-eabi-gcc)

set(CMAKE_C_FLAGS_INIT "-mcpu=cortex-m4 -mthumb -mfpu=fpv4-sp-d16 -mfloat-abi=hard")
```

### STM32CubeIDE

The workflow uses the headless build feature of STM32CubeIDE:

```yaml
with:
  build-system: cubeide
  cubeide-project: MyProject
  cubeide-config: Release
```

## Firmware Release Process

### Version Management

```
┌─────────────────────────────────────────────────────────────────┐
│                    STM32 Release Pipeline                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────────┐  │
│  │  Build  │───►│  Test   │───►│ Analyze │───►│   Release   │  │
│  │         │    │         │    │         │    │             │  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────────┘  │
│       │              │              │               │           │
│       ▼              ▼              ▼               ▼           │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────────┐  │
│  │ .bin    │    │ Unity   │    │ MISRA   │    │ GitHub      │  │
│  │ .hex    │    │ Tests   │    │ Check   │    │ Release     │  │
│  │ .elf    │    │ HIL     │    │ cppcheck│    │ Changelog   │  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Release Artifacts

| Artifact | Description |
|----------|-------------|
| `firmware-{mcu}-{version}.bin` | Raw binary for flashing |
| `firmware-{mcu}-{version}.hex` | Intel HEX format |
| `firmware-{mcu}-{version}.elf` | ELF with debug symbols |
| `firmware-{mcu}-{version}.map` | Memory map file |
| `checksums.sha256` | SHA256 checksums |
| `build-info.json` | Build metadata |

### Build Metadata

```json
{
  "version": "1.2.3",
  "target_mcu": "STM32F407VG",
  "toolchain": "arm-none-eabi-gcc 13.3.1",
  "build_type": "Release",
  "build_date": "2026-01-22T10:30:00Z",
  "git_commit": "a1b2c3d4",
  "git_branch": "main",
  "flash_size": 524288,
  "ram_usage": 131072
}
```

## Programming & Deployment

### ST-Link Programming

```yaml
# Enable programming after build
with:
  program-device: true
  programmer: stlink
```

### J-Link Programming

```yaml
with:
  program-device: true
  programmer: jlink
  jlink-device: STM32F407VG
```

### DFU (USB Bootloader)

```yaml
with:
  create-dfu: true
  dfu-vid: 0x0483
  dfu-pid: 0xDF11
```

## Static Analysis

### MISRA Compliance

```yaml
analysis:
  misra:
    enabled: true
    standard: MISRA-C:2012
    required-rules: true
    advisory-rules: false
```

### cppcheck Integration

```yaml
analysis:
  cppcheck:
    enabled: true
    standard: c11
    platform: arm32-wchar_t2
    enable: warning,style,performance
```

## Unit Testing

### Unity Framework

```yaml
tests:
  framework: unity
  test-path: tests/
  coverage: true
```

### Native Testing (Host)

For logic that doesn't depend on hardware:

```yaml
tests:
  native-tests: true
  native-compiler: gcc
  test-path: tests/unit/
```

## Examples

### Multi-MCU Matrix Build

```yaml
name: Multi-MCU Build

on:
  push:
    branches: [main]

jobs:
  build:
    uses: bauer-group/automation-templates/.github/workflows/stm32-build.yml@main
    with:
      target-mcus: '["STM32F103C8", "STM32F407VG", "STM32H743ZI"]'
      build-types: '["Release", "Debug"]'
      run-tests: true
```

### Industrial Release Pipeline

```yaml
name: Industrial Release

on:
  push:
    tags: ['v*']

jobs:
  release:
    uses: bauer-group/automation-templates/.github/workflows/stm32-build.yml@main
    with:
      config-file: industrial
      target-mcu: STM32F407VG
      enable-analysis: true
      create-release: true
    secrets: inherit
```

## Troubleshooting

### Common Issues

**"arm-none-eabi-gcc not found"**
```
The toolchain is installed automatically. Check the toolchain-version parameter.
```

**"Makefile not found"**
```
Ensure project-path points to the directory containing the Makefile.
For STM32CubeIDE projects, use build-system: cubeide instead.
```

**"Linker script not found"**
```
Check that your linker script (.ld file) is in the expected location.
STM32CubeMX projects usually have it in the project root.
```

## Resources

- [STM32 GNU Toolchain](https://github.com/STMicroelectronics/gnu-tools-for-stm32)
- [ARM GNU Toolchain Downloads](https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads)
- [STM32CubeMX](https://www.st.com/en/development-tools/stm32cubemx.html)
- [GitHub Actions for STM32CubeIDE](https://interrupt.memfault.com/blog/github-actions-for-stm32cubeide)
- [xPack ARM Toolchain](https://xpack.github.io/arm-none-eabi-gcc/)

## Support

For issues specific to this workflow, please open an issue in the automation-templates repository.

For STM32 related questions, refer to the [STMicroelectronics Community](https://community.st.com/).
