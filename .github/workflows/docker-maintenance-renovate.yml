# =============================================================================
# Docker Maintenance with Renovate
# =============================================================================
# Automatically merges Renovate PRs when all checks pass.
# This enables fully automated Docker base image updates.
#
# Uses GitHub's native auto-merge: the PR is approved and auto-merge is
# enabled immediately. GitHub waits for all required status checks to pass
# before actually merging.
#
# Usage in your repository:
#   name: Docker Maintenance
#   on:
#     pull_request:
#       types: [opened, synchronize, reopened, ready_for_review]
#
#   jobs:
#     maintenance:
#       uses: bauer-group/automation-templates/.github/workflows/docker-maintenance-renovate.yml@main
#       secrets: inherit
#
# Requirements:
# - Renovate GitHub App must be installed on the repository
# - Repository setting "Allow auto-merge" must be enabled
# - Branch protection with required status checks configured
# =============================================================================

name: ðŸ³ Docker Maintenance (Renovate)

on:
  workflow_call:
    inputs:
      merge-method:
        description: 'Merge method: squash, merge, or rebase'
        type: string
        required: false
        default: 'squash'

      auto-approve:
        description: 'Automatically approve Renovate PRs'
        type: boolean
        required: false
        default: true

      allowed-actors:
        description: 'Comma-separated list of allowed bot actors'
        type: string
        required: false
        default: 'renovate[bot],renovate'

      runs-on:
        description: 'Runner to use. Use string for GitHub-hosted (e.g., "ubuntu-latest") or JSON array for self-hosted (e.g., ["self-hosted", "linux"])'
        type: string
        required: false
        default: 'ubuntu-latest'

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    name: Auto-merge Renovate PRs
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJSON(inputs.runs-on) || inputs.runs-on }}
    if: contains(inputs.allowed-actors, github.actor)

    steps:
      - name: ðŸ” Check Actor
        id: check-actor
        shell: bash
        run: |
          echo "ðŸ¤– PR opened by: ${{ github.actor }}"
          echo "âœ… Actor is in allowed list: ${{ inputs.allowed-actors }}"

      - name: âœ… Auto-approve Renovate PR
        if: inputs.auto-approve
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”€ Enable auto-merge
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: ${{ inputs.merge-method }}

      - name: ðŸ“Š Summary
        shell: bash
        run: |
          echo "## ðŸ¤– Renovate Auto-Merge" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **PR** | #${{ github.event.pull_request.number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Actor** | \`${{ github.actor }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Merge Method** | ${{ inputs.merge-method }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Auto-Approve** | ${{ inputs.auto-approve && 'âœ… Yes' || 'âŒ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Auto-merge enabled. GitHub will merge once all required checks pass." >> $GITHUB_STEP_SUMMARY
