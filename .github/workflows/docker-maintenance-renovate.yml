# =============================================================================
# Docker Maintenance with Renovate
# =============================================================================
# Automatically merges Renovate PRs when all checks pass.
# This enables fully automated Docker base image updates.
#
# Usage in your repository:
#   name: Docker Maintenance
#   on:
#     pull_request:
#       types: [opened, synchronize, reopened, ready_for_review]
#
#   jobs:
#     maintenance:
#       uses: bauer-group/automation-templates/.github/workflows/docker-maintenance-renovate.yml@main
#       secrets: inherit
#
# Requirements:
# - Renovate GitHub App must be installed on the repository
# - Branch protection rules should allow auto-merge
# - Repository setting "Allow auto-merge" must be enabled
# =============================================================================

name: ðŸ³ Docker Maintenance (Renovate)

on:
  workflow_call:
    inputs:
      merge-method:
        description: 'Merge method: squash, merge, or rebase'
        type: string
        required: false
        default: 'squash'

      auto-approve:
        description: 'Automatically approve Renovate PRs'
        type: boolean
        required: false
        default: true

      wait-interval:
        description: 'Seconds to wait between check status polls'
        type: number
        required: false
        default: 30

      allowed-actors:
        description: 'Comma-separated list of allowed bot actors'
        type: string
        required: false
        default: 'renovate[bot],renovate'

      runs-on:
        description: 'Runner to use. Use string for GitHub-hosted (e.g., "ubuntu-latest") or JSON array for self-hosted (e.g., ["self-hosted", "linux"])'
        type: string
        required: false
        default: 'ubuntu-latest'

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    name: Auto-merge Renovate PRs
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJSON(inputs.runs-on) || inputs.runs-on }}
    if: contains(inputs.allowed-actors, github.actor)

    steps:
      - name: ðŸ” Check Actor
        id: check-actor
        shell: bash
        run: |
          echo "ðŸ¤– PR opened by: ${{ github.actor }}"
          echo "âœ… Actor is in allowed list: ${{ inputs.allowed-actors }}"

      - name: ðŸ”Ž Detect own check name
        id: detect-self
        shell: bash
        run: |
          OWN_NAME=$(gh api "repos/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}/jobs" \
            --jq '[.jobs[] | select(.name | endswith("/ Auto-merge Renovate PRs"))][0].name // empty')
          if [ -z "$OWN_NAME" ]; then
            echo "::warning::Could not detect compound check name, falling back to job name"
            OWN_NAME="Auto-merge Renovate PRs"
          fi
          echo "check-name=$OWN_NAME" >> "$GITHUB_OUTPUT"
          echo "â„¹ï¸ Own check name: $OWN_NAME"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: â³ Wait for checks to complete
        uses: lewagon/wait-on-check-action@v1.5.0
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: ${{ inputs.wait-interval }}
          running-workflow-name: ${{ steps.detect-self.outputs.check-name }}
          allowed-conclusions: success,skipped

      - name: ðŸ”€ Enable auto-merge
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: ${{ inputs.merge-method }}

      - name: âœ… Auto-approve Renovate PR
        if: inputs.auto-approve
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Summary
        shell: bash
        run: |
          echo "## ðŸ¤– Renovate Auto-Merge" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **PR** | #${{ github.event.pull_request.number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Actor** | \`${{ github.actor }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Merge Method** | ${{ inputs.merge-method }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Auto-Approve** | ${{ inputs.auto-approve && 'âœ… Yes' || 'âŒ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… PR will be automatically merged once all checks pass." >> $GITHUB_STEP_SUMMARY
