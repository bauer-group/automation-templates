name: ðŸ“¦ Module | Semantic Release

on:
  workflow_call:
    inputs:
      target-branch:
        description: 'Target branch for releases'
        required: false
        type: string
        default: 'main'
      dry-run:
        description: 'Perform dry run without creating release'
        required: false
        type: boolean
        default: false
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '20'
      force-release:
        description: 'Force create release even without conventional commits'
        required: false
        type: boolean
        default: false
      extra-plugins:
        description: 'Additional semantic-release plugins to install (space-separated)'
        required: false
        type: string
        default: ''
    outputs:
      release-created:
        description: 'Whether a release was created'
        value: ${{ jobs.semantic-release.outputs.release-created }}
      version:
        description: 'Release version'
        value: ${{ jobs.semantic-release.outputs.version }}
      tag-name:
        description: 'Git tag name'
        value: ${{ jobs.semantic-release.outputs.tag }}

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  semantic-release:
    name: ðŸ“¦ Semantic Release
    runs-on: ubuntu-latest
    outputs:
      release-created: ${{ steps.release.outputs.release-created }}
      version: ${{ steps.release.outputs.version }}
      tag: ${{ steps.release.outputs.tag }}
    
    steps:
      - name: ðŸš€ Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false
          
      - name: ðŸ“¥ Sync with Remote
        run: |
          echo "ðŸ”„ Fetching latest changes to ensure branch is up-to-date"
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Actions"
          git fetch origin
          git reset --hard origin/${{ inputs.target-branch }}
          git clean -fd
          echo "âœ… Branch synchronized with remote"
          
      - name: ðŸš€ Semantic Release
        id: semantic
        uses: bauer-group/automation-templates/.github/actions/semantic-release@main
        with:
          dry-run: ${{ inputs.dry-run }}
          branches: ${{ inputs.target-branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
          force-release: ${{ inputs.force-release }}
          extra-plugins: ${{ inputs.extra-plugins }}
          
      - name: ðŸ“Š Process Results
        id: release
        run: |
          # Map outputs from action
          if [ "${{ steps.semantic.outputs.release-created }}" = "true" ]; then
            echo "release-created=true" >> $GITHUB_OUTPUT
            echo "version=${{ steps.semantic.outputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ steps.semantic.outputs.tag }}" >> $GITHUB_OUTPUT
            echo "âœ… Released version: ${{ steps.semantic.outputs.tag }}"
          else
            echo "release-created=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No release created (no releasable changes)"
          fi
          
      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "### ðŸš€ Semantic Release Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.release.outputs.release-created }}" = "true" ]; then
            echo "âœ… **Release Created Successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Version** | ${{ steps.release.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Tag** | ${{ steps.release.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Branch** | ${{ inputs.target-branch }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No Release Created**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No releasable changes found since the last release." >> $GITHUB_STEP_SUMMARY
          fi