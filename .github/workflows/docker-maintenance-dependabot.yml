# =============================================================================
# Docker Maintenance with Dependabot
# =============================================================================
# Automatically merges Dependabot PRs when all checks pass.
# This enables fully automated Docker base image updates using GitHub's
# native Dependabot - no external app installation required.
#
# Uses GitHub's native auto-merge: the PR is approved and auto-merge is
# enabled immediately. GitHub waits for all required status checks to pass
# before actually merging.
#
# Usage in your repository:
#   name: Docker Maintenance
#   on:
#     pull_request:
#       types: [opened, synchronize, reopened, ready_for_review]
#
#   jobs:
#     maintenance:
#       uses: bauer-group/automation-templates/.github/workflows/docker-maintenance-dependabot.yml@main
#       secrets: inherit
#
# Requirements:
# - Dependabot must be enabled in repository settings
# - .github/dependabot.yml must include docker ecosystem
# - Repository setting "Allow auto-merge" must be enabled
# - Branch protection with required status checks configured
# =============================================================================

name: ðŸ³ Docker Maintenance (Dependabot)

on:
  workflow_call:
    inputs:
      merge-method:
        description: 'Merge method: squash, merge, or rebase'
        type: string
        required: false
        default: 'squash'

      auto-approve:
        description: 'Automatically approve Dependabot PRs'
        type: boolean
        required: false
        default: true

      runs-on:
        description: 'Runner to use. Use string for GitHub-hosted (e.g., "ubuntu-latest") or JSON array for self-hosted (e.g., ["self-hosted", "linux"])'
        type: string
        required: false
        default: 'ubuntu-latest'

permissions:
  contents: write
  pull-requests: write

jobs:
  maintenance:
    name: Docker Maintenance
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJSON(inputs.runs-on) || inputs.runs-on }}
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: ðŸ” Check Actor
        id: check-actor
        shell: bash
        run: |
          echo "ðŸ¤– PR opened by: ${{ github.actor }}"
          echo "âœ… Actor is dependabot[bot]"

      - name: ðŸ“¦ Fetch Dependabot Metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Auto-approve Dependabot PR
        if: inputs.auto-approve
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”€ Enable auto-merge
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: ${{ inputs.merge-method }}

      - name: ðŸ“Š Summary
        shell: bash
        run: |
          echo "## ðŸ³ Docker Maintenance (Dependabot)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **PR** | #${{ github.event.pull_request.number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Dependency** | \`${{ steps.metadata.outputs.dependency-names }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Update Type** | ${{ steps.metadata.outputs.update-type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **From** | \`${{ steps.metadata.outputs.previous-version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **To** | \`${{ steps.metadata.outputs.new-version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Merge Method** | ${{ inputs.merge-method }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Auto-Approve** | ${{ inputs.auto-approve && 'âœ… Yes' || 'âŒ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Auto-merge enabled. GitHub will merge once all required checks pass." >> $GITHUB_STEP_SUMMARY
