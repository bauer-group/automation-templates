# =============================================================================
# Docker Maintenance with Dependabot
# =============================================================================
# Automatically merges Dependabot PRs when all checks pass.
# This enables fully automated Docker base image updates using GitHub's
# native Dependabot - no external app installation required.
#
# Usage in your repository:
#   name: Docker Maintenance
#   on:
#     pull_request:
#       types: [opened, synchronize, reopened, ready_for_review]
#
#   jobs:
#     maintenance:
#       uses: bauer-group/automation-templates/.github/workflows/docker-maintenance-dependabot.yml@main
#       secrets: inherit
#
# Requirements:
# - Dependabot must be enabled in repository settings
# - .github/dependabot.yml must include docker ecosystem
# - Repository setting "Allow auto-merge" must be enabled
# =============================================================================

name: ðŸ³ Docker Maintenance (Dependabot)

on:
  workflow_call:
    inputs:
      merge-method:
        description: 'Merge method: squash, merge, or rebase'
        type: string
        required: false
        default: 'squash'

      auto-approve:
        description: 'Automatically approve Dependabot PRs'
        type: boolean
        required: false
        default: true

      wait-interval:
        description: 'Seconds to wait between check status polls'
        type: number
        required: false
        default: 30

      runs-on:
        description: 'Runner to use. Use string for GitHub-hosted (e.g., "ubuntu-latest") or JSON array for self-hosted (e.g., ["self-hosted", "linux"])'
        type: string
        required: false
        default: 'ubuntu-latest'

permissions:
  contents: write
  pull-requests: write

jobs:
  maintenance:
    name: Docker Maintenance
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJSON(inputs.runs-on) || inputs.runs-on }}
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: ðŸ” Check Actor
        id: check-actor
        shell: bash
        run: |
          echo "ðŸ¤– PR opened by: ${{ github.actor }}"
          echo "âœ… Actor is dependabot[bot]"

      - name: ðŸ“¦ Fetch Dependabot Metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”Ž Detect own check name
        id: detect-self
        shell: bash
        run: |
          OWN_NAME=$(gh api "repos/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}/jobs" \
            --jq '[.jobs[] | select(.name | endswith("/ Docker Maintenance"))][0].name // empty')
          if [ -z "$OWN_NAME" ]; then
            echo "::warning::Could not detect compound check name, falling back to job name"
            OWN_NAME="Docker Maintenance"
          fi
          echo "check-name=$OWN_NAME" >> "$GITHUB_OUTPUT"
          echo "â„¹ï¸ Own check name: $OWN_NAME"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: â³ Wait for checks to complete
        uses: lewagon/wait-on-check-action@v1.4.1
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: ${{ inputs.wait-interval }}
          running-workflow-name: ${{ steps.detect-self.outputs.check-name }}
          allowed-conclusions: success,skipped

      - name: âœ… Auto-approve Dependabot PR
        if: inputs.auto-approve
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”€ Enable auto-merge
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: ${{ inputs.merge-method }}

      - name: ðŸ“Š Summary
        shell: bash
        run: |
          echo "## ðŸ³ Docker Maintenance (Dependabot)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **PR** | #${{ github.event.pull_request.number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Dependency** | \`${{ steps.metadata.outputs.dependency-names }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Update Type** | ${{ steps.metadata.outputs.update-type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **From** | \`${{ steps.metadata.outputs.previous-version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **To** | \`${{ steps.metadata.outputs.new-version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Merge Method** | ${{ inputs.merge-method }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Auto-Approve** | ${{ inputs.auto-approve && 'âœ… Yes' || 'âŒ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… PR will be automatically merged once all checks pass." >> $GITHUB_STEP_SUMMARY
