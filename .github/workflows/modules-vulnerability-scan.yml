name: ðŸ›¡ï¸ Module | Vulnerability Scanning

on:
  workflow_call:
    inputs:
      scan-engine:
        description: 'Vulnerability scan engine (osv-scanner, trivy, both)'
        required: false
        type: string
        default: 'both'
      trivy-severity:
        description: 'Trivy severity filter (comma-separated: CRITICAL,HIGH,MEDIUM,LOW)'
        required: false
        type: string
        default: 'CRITICAL,HIGH'
      trivy-scanners:
        description: 'Trivy scanner types (comma-separated: vuln,secret,misconfig)'
        required: false
        type: string
        default: 'vuln'
      trivy-ignore-unfixed:
        description: 'Ignore unfixed vulnerabilities in Trivy scan'
        required: false
        type: boolean
        default: true
      osv-scan-args:
        description: 'OSV-Scanner CLI arguments (one per line)'
        required: false
        type: string
        default: |-
          --recursive
          ./
      container-images:
        description: 'Container images for Anchore/Grype scanning (one per line, empty = skip)'
        required: false
        type: string
        default: ''
      container-severity:
        description: 'Anchore/Grype severity cutoff (negligible, low, medium, high, critical)'
        required: false
        type: string
        default: 'medium'
      fail-on-findings:
        description: 'Fail the workflow if vulnerabilities are found'
        required: false
        type: boolean
        default: true
      upload-sarif:
        description: 'Upload SARIF results to GitHub Security tab'
        required: false
        type: boolean
        default: true
      runs-on:
        description: 'Runner to use. Use string for GitHub-hosted (e.g., "ubuntu-latest") or JSON array for self-hosted (e.g., ["self-hosted", "linux"])'
        required: false
        type: string
        default: 'ubuntu-latest'
    outputs:
      vulnerabilities-found:
        description: 'Whether any engine found vulnerabilities'
        value: ${{ jobs.summary.outputs.vulnerabilities-found }}
      trivy-result:
        description: 'Trivy scan result (pass/fail/skipped)'
        value: ${{ jobs.summary.outputs.trivy-result }}
      osv-result:
        description: 'OSV-Scanner scan result (pass/fail/skipped)'
        value: ${{ jobs.summary.outputs.osv-result }}
      container-result:
        description: 'Container scan result (pass/fail/skipped)'
        value: ${{ jobs.summary.outputs.container-result }}
      security-score:
        description: 'Overall security score (0-100)'
        value: ${{ jobs.summary.outputs.security-score }}
      scan-results:
        description: 'Summary of scan results'
        value: ${{ jobs.summary.outputs.scan-results }}

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Trivy Filesystem Scan
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  trivy-scan:
    name: ðŸ” Trivy Filesystem Scan
    if: inputs.scan-engine == 'trivy' || inputs.scan-engine == 'both'
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJSON(inputs.runs-on) || inputs.runs-on }}
    outputs:
      result: ${{ steps.evaluate.outputs.result }}
      critical-count: ${{ steps.evaluate.outputs.critical-count }}
      high-count: ${{ steps.evaluate.outputs.high-count }}
      medium-count: ${{ steps.evaluate.outputs.medium-count }}
      low-count: ${{ steps.evaluate.outputs.low-count }}
      security-score: ${{ steps.evaluate.outputs.security-score }}

    steps:
      - name: ðŸš€ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Trivy Vulnerability Scan (JSON)
        uses: aquasecurity/trivy-action@0.34.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-results.json'
          severity: ${{ inputs.trivy-severity }}
          scanners: ${{ inputs.trivy-scanners }}
          ignore-unfixed: ${{ inputs.trivy-ignore-unfixed }}
          exit-code: '0'

      - name: ðŸ” Trivy Vulnerability Scan (SARIF)
        uses: aquasecurity/trivy-action@0.34.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: ${{ inputs.trivy-severity }}
          scanners: ${{ inputs.trivy-scanners }}
          ignore-unfixed: ${{ inputs.trivy-ignore-unfixed }}
          exit-code: '0'
          skip-setup-trivy: true

      - name: ðŸ“¤ Upload Trivy SARIF
        if: inputs.upload-sarif && always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
          category: trivy-filesystem
        continue-on-error: true

      - name: ðŸ“Š Evaluate Trivy Results
        id: evaluate
        shell: bash
        run: |
          echo "ðŸ“Š Evaluating Trivy scan results..."

          CRITICAL=0
          HIGH=0
          MEDIUM=0
          LOW=0

          if [ -f "trivy-results.json" ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-results.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length' trivy-results.json 2>/dev/null || echo "0")
            LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "LOW")] | length' trivy-results.json 2>/dev/null || echo "0")
          fi

          TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))

          # Score: 100 - penalties, min 0
          SCORE=$((100 - CRITICAL * 30 - HIGH * 15 - MEDIUM * 5))
          if [ $SCORE -lt 0 ]; then
            SCORE=0
          fi

          RESULT="pass"
          if [ $CRITICAL -gt 0 ] || [ $HIGH -gt 0 ]; then
            RESULT="fail"
          elif [ $MEDIUM -gt 0 ]; then
            RESULT="warning"
          fi

          echo "critical-count=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high-count=$HIGH" >> $GITHUB_OUTPUT
          echo "medium-count=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low-count=$LOW" >> $GITHUB_OUTPUT
          echo "security-score=$SCORE" >> $GITHUB_OUTPUT
          echo "result=$RESULT" >> $GITHUB_OUTPUT

          echo ""
          echo "ðŸ” Trivy Scan Results:"
          echo "  â€¢ Critical: $CRITICAL"
          echo "  â€¢ High: $HIGH"
          echo "  â€¢ Medium: $MEDIUM"
          echo "  â€¢ Low: $LOW"
          echo "  â€¢ Total: $TOTAL"
          echo "  â€¢ Score: $SCORE/100"
          echo "  â€¢ Result: $RESULT"

      - name: ðŸ“‹ Trivy Step Summary
        if: always()
        shell: bash
        run: |
          CRITICAL="${{ steps.evaluate.outputs.critical-count }}"
          HIGH="${{ steps.evaluate.outputs.high-count }}"
          MEDIUM="${{ steps.evaluate.outputs.medium-count }}"
          LOW="${{ steps.evaluate.outputs.low-count }}"
          SCORE="${{ steps.evaluate.outputs.security-score }}"
          RESULT="${{ steps.evaluate.outputs.result }}"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ### ðŸ” Trivy Filesystem Scan

          | Severity | Count |
          |----------|-------|
          | ðŸ”´ Critical | $CRITICAL |
          | ðŸŸ  High | $HIGH |
          | ðŸŸ¡ Medium | $MEDIUM |
          | ðŸ”µ Low | $LOW |

          **Score:** $SCORE/100 | **Result:** $RESULT
          EOF

      - name: ðŸ“¤ Upload Trivy Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-vulnerability-reports
          path: trivy-results.*
          retention-days: 30
          if-no-files-found: ignore

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: OSV-Scanner Dependency Scan
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  osv-scan:
    name: ðŸ›¡ï¸ OSV-Scanner Dependency Scan
    if: inputs.scan-engine == 'osv-scanner' || inputs.scan-engine == 'both'
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJSON(inputs.runs-on) || inputs.runs-on }}
    outputs:
      result: ${{ steps.evaluate.outputs.result }}
      vulnerabilities-found: ${{ steps.evaluate.outputs.vulnerabilities-found }}

    steps:
      - name: ðŸš€ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ›¡ï¸ Run OSV-Scanner
        id: scan
        uses: google/osv-scanner-action@v2.3.2
        with:
          scan-args: ${{ inputs.osv-scan-args }}
        continue-on-error: true

      - name: ðŸ“Š Evaluate OSV Results
        id: evaluate
        shell: bash
        run: |
          if [ "${{ steps.scan.outcome }}" = "failure" ]; then
            echo "result=fail" >> $GITHUB_OUTPUT
            echo "vulnerabilities-found=true" >> $GITHUB_OUTPUT
            echo "âŒ OSV-Scanner found vulnerabilities"
          else
            echo "result=pass" >> $GITHUB_OUTPUT
            echo "vulnerabilities-found=false" >> $GITHUB_OUTPUT
            echo "âœ… No vulnerabilities found by OSV-Scanner"
          fi

      - name: ðŸ“¤ Upload OSV SARIF
        if: inputs.upload-sarif && always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: osv-scanner
        continue-on-error: true

      - name: ðŸ“‹ OSV Step Summary
        if: always()
        shell: bash
        run: |
          RESULT="${{ steps.evaluate.outputs.result }}"
          ICON=$( [ "$RESULT" = "pass" ] && echo "âœ…" || echo "âŒ" )

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ### ðŸ›¡ï¸ OSV-Scanner Dependency Scan

          **Result:** $ICON $RESULT
          **Database:** OSV.dev (20+ vulnerability sources)
          **Scanner:** google/osv-scanner-action@v2.3.2
          EOF

      - name: ðŸ“¤ Upload OSV Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: osv-scanner-reports
          path: results.sarif
          retention-days: 30
          if-no-files-found: ignore

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Container Image Scan (Anchore/Grype)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  prepare-matrix:
    name: ðŸ“‹ Prepare Container Matrix
    if: inputs.container-images != ''
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJSON(inputs.runs-on) || inputs.runs-on }}
    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}
      has-images: ${{ steps.parse.outputs.has-images }}
    steps:
      - name: ðŸ“‹ Parse Container Images
        id: parse
        shell: bash
        run: |
          IMAGES='${{ inputs.container-images }}'

          # Parse multiline input into JSON array
          JSON_ARRAY=$(echo "$IMAGES" | grep -v '^\s*$' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R -s -c 'split("\n") | map(select(length > 0))')

          IMAGE_COUNT=$(echo "$JSON_ARRAY" | jq 'length')

          if [ "$IMAGE_COUNT" -gt 0 ]; then
            echo "matrix={\"image\":$JSON_ARRAY}" >> $GITHUB_OUTPUT
            echo "has-images=true" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Found $IMAGE_COUNT container image(s) to scan"
            echo "$JSON_ARRAY" | jq -r '.[]' | while read img; do
              echo "  â€¢ $img"
            done
          else
            echo "matrix={\"image\":[]}" >> $GITHUB_OUTPUT
            echo "has-images=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No container images to scan"
          fi

  container-scan:
    name: ðŸ³ Scan ${{ matrix.image }}
    needs: prepare-matrix
    if: needs.prepare-matrix.outputs.has-images == 'true'
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJSON(inputs.runs-on) || inputs.runs-on }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.prepare-matrix.outputs.matrix) }}
    outputs:
      result: ${{ steps.evaluate.outputs.result }}

    steps:
      - name: ðŸ” Scan Container Image
        id: scan
        uses: anchore/scan-action@v7
        with:
          image: ${{ matrix.image }}
          severity-cutoff: ${{ inputs.container-severity }}
          output-format: sarif
          fail-build: false

      - name: ðŸ“¤ Upload Container SARIF
        if: inputs.upload-sarif && always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}
          category: "anchore-grype-${{ strategy.job-index }}"
        continue-on-error: true

      - name: ðŸ“Š Evaluate Container Scan
        id: evaluate
        shell: bash
        run: |
          if [ "${{ steps.scan.outcome }}" = "failure" ]; then
            echo "result=fail" >> $GITHUB_OUTPUT
            echo "âŒ Vulnerabilities found in ${{ matrix.image }}"
          else
            echo "result=pass" >> $GITHUB_OUTPUT
            echo "âœ… No critical vulnerabilities in ${{ matrix.image }}"
          fi

      - name: ðŸ“‹ Container Step Summary
        if: always()
        shell: bash
        run: |
          RESULT="${{ steps.evaluate.outputs.result }}"
          ICON=$( [ "$RESULT" = "pass" ] && echo "âœ…" || echo "âŒ" )

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ### ðŸ³ Container Scan: \`${{ matrix.image }}\`

          **Result:** $ICON $RESULT
          **Severity Cutoff:** ${{ inputs.container-severity }}
          **Scanner:** Anchore Grype
          EOF

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 4: Summary & Evaluation
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  summary:
    name: ðŸ“Š Vulnerability Scan Summary
    if: always()
    needs: [trivy-scan, osv-scan, prepare-matrix, container-scan]
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJSON(inputs.runs-on) || inputs.runs-on }}
    outputs:
      vulnerabilities-found: ${{ steps.evaluate.outputs.vulnerabilities-found }}
      trivy-result: ${{ steps.evaluate.outputs.trivy-result }}
      osv-result: ${{ steps.evaluate.outputs.osv-result }}
      container-result: ${{ steps.evaluate.outputs.container-result }}
      security-score: ${{ steps.evaluate.outputs.security-score }}
      scan-results: ${{ steps.evaluate.outputs.scan-results }}

    steps:
      - name: ðŸ“Š Evaluate Combined Results
        id: evaluate
        shell: bash
        run: |
          echo "ðŸ“Š Evaluating combined vulnerability scan results..."

          # â”€â”€ Trivy Result â”€â”€
          TRIVY_RESULT="skipped"
          TRIVY_SCORE=100
          if [[ "${{ inputs.scan-engine }}" == "trivy" || "${{ inputs.scan-engine }}" == "both" ]]; then
            if [ "${{ needs.trivy-scan.result }}" = "success" ]; then
              TRIVY_RESULT="${{ needs.trivy-scan.outputs.result || 'pass' }}"
              TRIVY_SCORE="${{ needs.trivy-scan.outputs.security-score || '100' }}"
            else
              TRIVY_RESULT="fail"
              TRIVY_SCORE=0
            fi
          fi

          # â”€â”€ OSV-Scanner Result â”€â”€
          OSV_RESULT="skipped"
          OSV_SCORE=100
          if [[ "${{ inputs.scan-engine }}" == "osv-scanner" || "${{ inputs.scan-engine }}" == "both" ]]; then
            OSV_VULNS="${{ needs.osv-scan.outputs.vulnerabilities-found || 'false' }}"
            OSV_JOB_RESULT="${{ needs.osv-scan.outputs.result || 'pass' }}"
            if [ "$OSV_VULNS" = "true" ] || [ "$OSV_JOB_RESULT" = "fail" ]; then
              OSV_RESULT="fail"
              OSV_SCORE=50
            elif [ "${{ needs.osv-scan.result }}" = "success" ]; then
              OSV_RESULT="pass"
              OSV_SCORE=100
            else
              OSV_RESULT="fail"
              OSV_SCORE=50
            fi
          fi

          # â”€â”€ Container Result â”€â”€
          CONTAINER_RESULT="skipped"
          CONTAINER_SCORE=100
          if [ -n "${{ inputs.container-images }}" ]; then
            if [ "${{ needs.container-scan.result }}" = "success" ]; then
              CONTAINER_RESULT="pass"
              CONTAINER_SCORE=100
            elif [ "${{ needs.container-scan.result }}" = "failure" ]; then
              CONTAINER_RESULT="fail"
              CONTAINER_SCORE=40
            else
              CONTAINER_RESULT="skipped"
            fi
          fi

          # â”€â”€ Combined Score (weighted average of active engines) â”€â”€
          TOTAL_SCORE=0
          ENGINE_COUNT=0

          if [ "$TRIVY_RESULT" != "skipped" ]; then
            TOTAL_SCORE=$((TOTAL_SCORE + TRIVY_SCORE))
            ENGINE_COUNT=$((ENGINE_COUNT + 1))
          fi

          if [ "$OSV_RESULT" != "skipped" ]; then
            TOTAL_SCORE=$((TOTAL_SCORE + OSV_SCORE))
            ENGINE_COUNT=$((ENGINE_COUNT + 1))
          fi

          if [ "$CONTAINER_RESULT" != "skipped" ]; then
            TOTAL_SCORE=$((TOTAL_SCORE + CONTAINER_SCORE))
            ENGINE_COUNT=$((ENGINE_COUNT + 1))
          fi

          if [ $ENGINE_COUNT -gt 0 ]; then
            SECURITY_SCORE=$((TOTAL_SCORE / ENGINE_COUNT))
          else
            SECURITY_SCORE=100
          fi

          # â”€â”€ Determine overall result â”€â”€
          VULNS_FOUND="false"
          if [[ "$TRIVY_RESULT" == "fail" || "$OSV_RESULT" == "fail" || "$CONTAINER_RESULT" == "fail" ]]; then
            VULNS_FOUND="true"
          fi

          SUMMARY="Vulnerability Scan Complete"
          if [ "$VULNS_FOUND" = "true" ]; then
            SUMMARY="Vulnerabilities Found"
          fi

          echo "vulnerabilities-found=$VULNS_FOUND" >> $GITHUB_OUTPUT
          echo "trivy-result=$TRIVY_RESULT" >> $GITHUB_OUTPUT
          echo "osv-result=$OSV_RESULT" >> $GITHUB_OUTPUT
          echo "container-result=$CONTAINER_RESULT" >> $GITHUB_OUTPUT
          echo "security-score=$SECURITY_SCORE" >> $GITHUB_OUTPUT
          echo "scan-results=$SUMMARY" >> $GITHUB_OUTPUT

          echo ""
          echo "ðŸ›¡ï¸ Combined Vulnerability Scan Results:"
          echo "  â€¢ Trivy: $TRIVY_RESULT (Score: $TRIVY_SCORE)"
          echo "  â€¢ OSV-Scanner: $OSV_RESULT (Score: $OSV_SCORE)"
          echo "  â€¢ Container: $CONTAINER_RESULT (Score: $CONTAINER_SCORE)"
          echo "  â€¢ Combined Score: $SECURITY_SCORE/100"
          echo "  â€¢ Vulnerabilities Found: $VULNS_FOUND"

      - name: ðŸ“‹ Generate Summary Report
        if: always()
        shell: bash
        run: |
          TRIVY_RESULT="${{ steps.evaluate.outputs.trivy-result }}"
          OSV_RESULT="${{ steps.evaluate.outputs.osv-result }}"
          CONTAINER_RESULT="${{ steps.evaluate.outputs.container-result }}"
          SCORE="${{ steps.evaluate.outputs.security-score }}"
          VULNS="${{ steps.evaluate.outputs.vulnerabilities-found }}"

          TRIVY_ICON=$( [ "$TRIVY_RESULT" = "pass" ] && echo "âœ…" || ( [ "$TRIVY_RESULT" = "skipped" ] && echo "â­ï¸" || echo "âŒ" ) )
          OSV_ICON=$( [ "$OSV_RESULT" = "pass" ] && echo "âœ…" || ( [ "$OSV_RESULT" = "skipped" ] && echo "â­ï¸" || echo "âŒ" ) )
          CONTAINER_ICON=$( [ "$CONTAINER_RESULT" = "pass" ] && echo "âœ…" || ( [ "$CONTAINER_RESULT" = "skipped" ] && echo "â­ï¸" || echo "âŒ" ) )

          OVERALL_ICON="âœ…"
          if [ "$VULNS" = "true" ]; then
            OVERALL_ICON="âŒ"
          fi

          # Score badge
          SCORE_LABEL="Excellent"
          if [ "$SCORE" -lt 95 ]; then SCORE_LABEL="Good"; fi
          if [ "$SCORE" -lt 80 ]; then SCORE_LABEL="Needs Attention"; fi
          if [ "$SCORE" -lt 60 ]; then SCORE_LABEL="Critical"; fi

          cat >> $GITHUB_STEP_SUMMARY << 'HEADER'
          ## ðŸ›¡ï¸ Vulnerability Scan Summary

          HEADER

          cat >> $GITHUB_STEP_SUMMARY << EOF
          | Engine | Status | Details |
          |--------|--------|---------|
          | **Trivy** (Filesystem) | $TRIVY_ICON $TRIVY_RESULT | Severity: ${{ inputs.trivy-severity }}, Scanners: ${{ inputs.trivy-scanners }} |
          | **OSV-Scanner** (Dependencies) | $OSV_ICON $OSV_RESULT | OSV.dev Database (20+ sources) |
          | **Anchore/Grype** (Container) | $CONTAINER_ICON $CONTAINER_RESULT | Cutoff: ${{ inputs.container-severity }} |

          **Overall:** $OVERALL_ICON | **Score:** $SCORE/100 ($SCORE_LABEL) | **Engine:** ${{ inputs.scan-engine }}
          EOF

          if [ "$VULNS" = "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          ### âš ï¸ Action Required

          Vulnerabilities were detected. Review the findings in:
          1. **Security tab** â†’ Code Scanning (SARIF results from each engine)
          2. **Artifacts** â†’ Download detailed JSON/SARIF reports
          3. **Individual job logs** â†’ Detailed per-engine output

          EOF
          fi

      - name: ðŸš¨ Fail on Findings
        if: inputs.fail-on-findings && steps.evaluate.outputs.vulnerabilities-found == 'true'
        shell: bash
        run: |
          echo "âŒ Vulnerability scan failed - vulnerabilities detected"
          echo ""
          echo "  â€¢ Trivy: ${{ steps.evaluate.outputs.trivy-result }}"
          echo "  â€¢ OSV-Scanner: ${{ steps.evaluate.outputs.osv-result }}"
          echo "  â€¢ Container: ${{ steps.evaluate.outputs.container-result }}"
          echo "  â€¢ Score: ${{ steps.evaluate.outputs.security-score }}/100"
          echo ""
          echo "Review the Security tab and scan artifacts for details."
          exit 1
