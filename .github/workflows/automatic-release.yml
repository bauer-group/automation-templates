name: 🔄 CI/CD Pipeline (Automatic Release)

# Main CI/CD pipeline using modular workflow components
# This demonstrates the new modular approach for this repository

on:
  push:
    branches: [main]
    paths-ignore:
      - '.github/**'
      - 'docs/**'
      - '*.md'
      - '*.MD'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      security-engine:
        description: 'Security scan engine'
        type: choice
        default: 'both'
        options: ['gitleaks', 'gitguardian', 'both']
      force-release:
        description: 'Force create release'
        type: boolean
        default: false
      artifact-types:
        description: 'Artifact types to generate'
        type: choice
        default: 'source'
        options: ['source', 'binaries', 'docker', 'all']

jobs:
  # PR validation for pull requests
  pr-validation:
    name: PR Quality Gate
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/modules-pr-validation.yml
    with:
      enable-security-scan: true
      enable-license-check: true
      enable-commit-lint: true
      security-scan-engine: 'gitleaks'
      fail-on-security-issues: true
      fail-on-license-issues: false
    secrets: inherit

  # Comprehensive security scan for main branch
  security-scan:
    name: Security Analysis
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/modules-security-scan.yml
    with:
      scan-engine: ${{ inputs.security-engine || 'both' }}
      scan-type: 'all'
      fail-on-findings: false
      minimum-severity: 'medium'
    secrets: inherit

  # License compliance check
  license-compliance:
    name: License Compliance
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/modules-license-compliance.yml
    with:
      fail-on-forbidden: false
      fail-on-unknown: false
      scan-dependencies: true
      generate-sbom: true
    secrets: inherit

  # Release management
  release-management:
    name: Release Management
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    needs: [security-scan, license-compliance]
    uses: ./.github/workflows/modules-semantic-release.yml
    with:
      target-branch: 'main'
      dry-run: false
    secrets: inherit

  # Artifact generation for releases
  artifact-generation:
    name: Generate Artifacts
    if: needs.release-management.outputs.release-created == 'true'
    needs: release-management
    uses: ./.github/workflows/modules-artifact-generation.yml
    with:
      artifact-types: ${{ inputs.artifact-types || 'source' }}
      tag-name: ${{ needs.release-management.outputs.tag-name }}
      version: ${{ needs.release-management.outputs.version }}

  # Pipeline summary
  pipeline-summary:
    name: Pipeline Summary
    if: always() && ((github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch')
    needs: [security-scan, license-compliance, release-management, artifact-generation]
    runs-on: ubuntu-latest
    
    steps:
      - name: 📊 Generate Pipeline Summary
        run: |
          echo "### 🔄 Modular CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** automation-templates" >> $GITHUB_STEP_SUMMARY
          echo "**Architecture:** Modular Workflow Components" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "| Module | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Security Scan** | ${{ needs.security-scan.result == 'success' && '✅ PASS' || '❌ FAIL' }} | Score: ${{ needs.security-scan.outputs.security-score || 'N/A' }}/100 |" >> $GITHUB_STEP_SUMMARY
          echo "| **License Compliance** | ${{ needs.license-compliance.result == 'success' && '✅ PASS' || '❌ FAIL' }} | Status: ${{ needs.license-compliance.outputs.compliance-status || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Release Management** | ${{ needs.release-management.result == 'success' && '✅ PASS' || '❌ FAIL' }} | Created: ${{ needs.release-management.outputs.release-created || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Artifact Generation** | ${{ needs.artifact-generation.result == 'success' && '✅ PASS' || needs.artifact-generation.result == 'skipped' && '⏭️ SKIP' || '❌ FAIL' }} | Generated: ${{ needs.artifact-generation.outputs.artifacts-generated || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.release-management.outputs.release-created }}" = "true" ]; then
            echo "🎉 **Release ${{ needs.release-management.outputs.version }} created successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Release Information:**" >> $GITHUB_STEP_SUMMARY
            echo "- Version: ${{ needs.release-management.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- Tag: ${{ needs.release-management.outputs.tag-name }}" >> $GITHUB_STEP_SUMMARY
            echo "- URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.release-management.outputs.tag-name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ **No release created.** Pipeline completed successfully." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Powered by **BAUER GROUP** modular workflow components* 🧩" >> $GITHUB_STEP_SUMMARY

  # 📄 Documentation Update (explicit call)
  # Explicitly trigger documentation updates after successful releases
  
  # Verify tag availability before documentation updates
  verify-tag-availability:
    name: Verify Tag Availability
    if: needs.release-management.outputs.release-created == 'true'
    needs: [release-management, artifact-generation]
    runs-on: ubuntu-latest
    outputs:
      tag-verified: ${{ steps.verify.outputs.tag-verified }}
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          fetch-tags: true

      - name: 🔍 Verify Tag Availability
        id: verify
        run: |
          TAG="${{ needs.release-management.outputs.tag-name }}"
          echo "🔍 Verifying availability of tag: $TAG"
          
          # Retry logic for tag verification
          MAX_RETRIES=10  # 10 retries = 15 seconds max
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            # Fetch latest tags from remote
            git fetch --tags origin
            
            # Check if tag exists
            if git rev-parse "refs/tags/$TAG" >/dev/null 2>&1; then
              echo "✅ Tag $TAG is available"
              echo "tag-verified=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "⏳ Tag not yet available, attempt $RETRY_COUNT/$MAX_RETRIES"
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              # Progressive delay: 1s, 2s, 3s...
              DELAY=$RETRY_COUNT
              echo "⏳ Waiting ${DELAY}s before retry..."
              sleep $DELAY
            fi
          done
          
          echo "❌ Tag $TAG not available after $MAX_RETRIES attempts"
          echo "tag-verified=false" >> $GITHUB_OUTPUT
          exit 1

  # Step 1: Update documentation in the release tag
  update-documentation-in-tag:
    name: Update Documentation in Release Tag
    if: needs.release-management.outputs.release-created == 'true'
    needs: [verify-tag-availability]
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout Release Tag
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ needs.release-management.outputs.tag-name }}

      - name: 📝 Update Documentation in Tag
        uses: bauer-group/automation-templates/.github/actions/readme-generate@main
        with:
          force-update: true
          custom-version: ${{ needs.release-management.outputs.version }}
          tag-name: ${{ needs.release-management.outputs.tag-name }}
          
      - name: 💾 Commit Documentation to Release Tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add README.MD SECURITY.MD || true
            git commit -m "docs: update documentation for release ${{ needs.release-management.outputs.tag-name }}

            🤖 Generated with Claude Code
            
            Co-Authored-By: Claude <noreply@anthropic.com>" || true
            
            # Force update the tag
            git tag -d ${{ needs.release-management.outputs.tag-name }} || true
            git tag ${{ needs.release-management.outputs.tag-name }}
            git push origin ${{ needs.release-management.outputs.tag-name }} --force
          fi

  # Step 2: Update documentation in main branch  
  update-documentation:
    name: Update Documentation in Main
    if: needs.release-management.outputs.release-created == 'true'
    needs: [update-documentation-in-tag]
    uses: ./.github/workflows/documentation.yml
    with:
      tag-name: ${{ needs.release-management.outputs.tag-name }}
      custom-version: ${{ needs.release-management.outputs.version }}
      force-update: true
    permissions:
      contents: write
      pull-requests: write

  # 🛡️ Security Management Update (explicit call)
  # Explicitly trigger security policy updates after successful releases

  # Step 1: Update security in the release tag
  update-security-in-tag:
    name: Update Security in Release Tag
    if: needs.release-management.outputs.release-created == 'true'
    needs: [update-documentation-in-tag]
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout Release Tag
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ needs.release-management.outputs.tag-name }}

      - name: 🛡️ Update Security Policy in Tag
        uses: bauer-group/automation-templates/.github/actions/security-generate@main
        with:
          force-update: true
          custom-version: ${{ needs.release-management.outputs.version }}
          tag-name: ${{ needs.release-management.outputs.tag-name }}
          
      - name: 💾 Commit Security Policy to Release Tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add SECURITY.MD || true
            git commit -m "security: update security policy for release ${{ needs.release-management.outputs.tag-name }}

            🤖 Generated with Claude Code
            
            Co-Authored-By: Claude <noreply@anthropic.com>" || true
            
            # Force update the tag
            git tag -d ${{ needs.release-management.outputs.tag-name }} || true
            git tag ${{ needs.release-management.outputs.tag-name }}
            git push origin ${{ needs.release-management.outputs.tag-name }} --force
          fi

  # Step 2: Update security in main branch
  update-security-management:
    name: Update Security Management in Main
    if: needs.release-management.outputs.release-created == 'true'
    needs: [update-security-in-tag]
    uses: ./.github/workflows/security-management.yml
    with:
      tag-name: ${{ needs.release-management.outputs.tag-name }}
      custom-version: ${{ needs.release-management.outputs.version }}
      force-update: true
    permissions:
      contents: write
      pull-requests: write
  