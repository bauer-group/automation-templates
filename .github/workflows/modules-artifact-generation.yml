name: ðŸ“¦ Module | Artifact Generation

on:
  workflow_call:
    inputs:
      artifact-types:
        description: 'Types of artifacts to generate (source, binaries, docker, all)'
        required: false
        type: string
        default: 'source'
      tag-name:
        description: 'Git tag name for the artifacts'
        required: true
        type: string
      version:
        description: 'Version string for the artifacts'
        required: true
        type: string
      release-url:
        description: 'Release URL to upload artifacts to'
        required: false
        type: string
        default: ''
      build-command:
        description: 'Custom build command for binaries'
        required: false
        type: string
        default: ''
      docker-registry:
        description: 'Docker registry for image publishing'
        required: false
        type: string
        default: 'ghcr.io'
    secrets:
      DOCKER_USERNAME:
        description: 'Docker registry username'
        required: false
      DOCKER_PASSWORD:
        description: 'Docker registry password/token'
        required: false
    outputs:
      artifacts-generated:
        description: 'Whether artifacts were generated successfully'
        value: ${{ jobs.generate-artifacts.outputs.artifacts-generated }}
      source-archive-created:
        description: 'Whether source archive was created'
        value: ${{ jobs.generate-artifacts.outputs.source-archive-created }}
      binaries-created:
        description: 'Whether binaries were created'
        value: ${{ jobs.generate-artifacts.outputs.binaries-created }}
      docker-image-pushed:
        description: 'Whether Docker image was pushed'
        value: ${{ jobs.generate-artifacts.outputs.docker-image-pushed }}

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  generate-artifacts:
    name: ðŸ”§ Artifact Creation
    runs-on: ubuntu-latest
    outputs:
      artifacts-generated: ${{ steps.summary.outputs.artifacts-generated }}
      source-archive-created: ${{ steps.artifacts.outputs.source-archive-created }}
      binaries-created: ${{ steps.artifacts.outputs.binaries-created }}
      docker-image-pushed: ${{ steps.artifacts.outputs.docker-image-pushed }}
    
    steps:
      - name: ðŸš€ Checkout Repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ”¨ Generate Artifacts
        id: artifacts
        uses: bauer-group/automation-templates/.github/actions/artifact-generator@main
        with:
          artifact-types: ${{ inputs.artifact-types }}
          tag-name: ${{ inputs.tag-name }}
          version: ${{ inputs.version }}
          upload-url: ${{ inputs.release-url }}
          build-command: ${{ inputs.build-command }}
          docker-registry: ${{ inputs.docker-registry }}
          docker-username: ${{ secrets.DOCKER_USERNAME || github.actor }}
          docker-password: ${{ secrets.DOCKER_PASSWORD || secrets.GITHUB_TOKEN }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Artifact Generation Summary
        id: summary
        if: always()
        run: |
          # Determine if artifacts were successfully generated
          SOURCE_OK="${{ steps.artifacts.outputs.source-archive-created }}"
          BINARIES_OK="${{ steps.artifacts.outputs.binaries-created }}"
          DOCKER_OK="${{ steps.artifacts.outputs.docker-image-pushed }}"
          
          # Consider successful if at least one artifact type was requested and created
          ARTIFACTS_GENERATED="false"
          
          case "${{ inputs.artifact-types }}" in
            "source")
              if [ "$SOURCE_OK" = "true" ]; then
                ARTIFACTS_GENERATED="true"
              fi
              ;;
            "binaries")
              if [ "$BINARIES_OK" = "true" ]; then
                ARTIFACTS_GENERATED="true"
              fi
              ;;
            "docker")
              if [ "$DOCKER_OK" = "true" ]; then
                ARTIFACTS_GENERATED="true"
              fi
              ;;
            "all")
              if [ "$SOURCE_OK" = "true" ] || [ "$BINARIES_OK" = "true" ] || [ "$DOCKER_OK" = "true" ]; then
                ARTIFACTS_GENERATED="true"
              fi
              ;;
          esac
          
          echo "artifacts-generated=$ARTIFACTS_GENERATED" >> $GITHUB_OUTPUT
          
          # Generate summary report
          echo "### ðŸ”¨ Artifact Generation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Artifact Types** | ${{ inputs.artifact-types }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ inputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag** | ${{ inputs.tag-name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Docker Registry** | ${{ inputs.docker-registry }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“‹ Generation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          # Source Archive Status
          if [[ '${{ inputs.artifact-types }}' =~ (source|all) ]]; then
            if [ "$SOURCE_OK" = "true" ]; then
              echo "| **Source Archive** | âœ… Created |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| **Source Archive** | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| **Source Archive** | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Binaries Status
          if [[ '${{ inputs.artifact-types }}' =~ (binaries|all) ]]; then
            if [ "$BINARIES_OK" = "true" ]; then
              echo "| **Binaries** | âœ… Created |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| **Binaries** | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| **Binaries** | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Docker Image Status
          if [[ '${{ inputs.artifact-types }}' =~ (docker|all) ]]; then
            if [ "$DOCKER_OK" = "true" ]; then
              echo "| **Docker Image** | âœ… Pushed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| **Docker Image** | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| **Docker Image** | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$ARTIFACTS_GENERATED" = "true" ]; then
            echo "âœ… **Artifact generation completed successfully!**" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ inputs.release-url }}" != "" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ“¦ **Artifacts uploaded to release:** [View Release](${{ inputs.release-url }})" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [[ "${{ inputs.artifact-types }}" =~ (docker|all) ]] && [ "$DOCKER_OK" = "true" ]; then
              IMAGE_NAME="${{ github.repository }}"
              echo "ðŸ³ **Docker Image:** \`${{ inputs.docker-registry }}/${IMAGE_NAME}:${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Artifact generation failed or no artifacts were created.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
            echo "- Check build commands and dependencies" >> $GITHUB_STEP_SUMMARY
            echo "- Verify Docker registry credentials" >> $GITHUB_STEP_SUMMARY
            echo "- Review artifact generation logs" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¤ Upload Additional Build Artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: additional-artifacts-${{ inputs.version }}
          path: |
            dist/
            build/
            target/
            out/
            *.vsix
            *.nupkg
            *.apk
            *.ipa
          if-no-files-found: ignore
          retention-days: 90