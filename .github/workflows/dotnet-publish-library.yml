name: .NET Library Publish

on:
  workflow_call:
    inputs:
      # =======================================================================
      # Build Configuration
      # =======================================================================
      working-directory:
        description: 'Working directory for all commands'
        type: string
        required: false
        default: '.'

      project-path:
        description: 'Path to .csproj or .sln file'
        type: string
        required: true

      configuration:
        description: 'Build configuration (Debug/Release)'
        type: string
        required: false
        default: 'Release'

      dotnet-version:
        description: '.NET SDK version(s) to use (comma-separated for multiple, e.g., "8.0.x,9.0.x")'
        type: string
        required: false
        default: '9.0.x'

      # =======================================================================
      # Testing
      # =======================================================================
      run-tests:
        description: 'Run tests if test projects exist (graceful skip if none found)'
        type: boolean
        required: false
        default: true

      test-project-path:
        description: 'Path to test project (auto-detected if not specified)'
        type: string
        required: false
        default: ''

      test-filter:
        description: 'Test filter expression'
        type: string
        required: false
        default: ''

      collect-coverage:
        description: 'Enable code coverage collection'
        type: boolean
        required: false
        default: true

      coverage-threshold:
        description: 'Minimum coverage percentage (0 to disable threshold check)'
        type: number
        required: false
        default: 0

      # =======================================================================
      # Versioning
      # =======================================================================
      package-version:
        description: 'Explicit package version (overrides all other version sources)'
        type: string
        required: false
        default: ''

      release-version:
        description: 'Version from release workflow (e.g., 1.2.3). Use this when calling from semantic-release.'
        type: string
        required: false
        default: ''

      version-suffix:
        description: 'Pre-release version suffix (e.g., preview, beta, alpha)'
        type: string
        required: false
        default: ''

      update-project-version:
        description: 'Update version in project files and commit changes'
        type: boolean
        required: false
        default: false

      # =======================================================================
      # Assembly Signing
      # =======================================================================
      sign-assembly:
        description: 'Enable strong name signing with SNK key'
        type: boolean
        required: false
        default: false

      delay-sign:
        description: 'Use delay signing (public key only)'
        type: boolean
        required: false
        default: false

      # =======================================================================
      # Packaging
      # =======================================================================
      create-package:
        description: 'Create NuGet package'
        type: boolean
        required: false
        default: true

      include-symbols:
        description: 'Include symbol package (.snupkg)'
        type: boolean
        required: false
        default: true

      include-source:
        description: 'Include source files in symbol package'
        type: boolean
        required: false
        default: true

      deterministic-build:
        description: 'Enable deterministic builds for reproducibility'
        type: boolean
        required: false
        default: true

      # =======================================================================
      # Publishing
      # =======================================================================
      push-to-nuget:
        description: 'Push package to NuGet.org'
        type: boolean
        required: false
        default: false

      push-to-github:
        description: 'Push package to GitHub Packages'
        type: boolean
        required: false
        default: false

      skip-duplicate:
        description: 'Skip push if package version already exists'
        type: boolean
        required: false
        default: true

      nuget-auth-method:
        description: 'NuGet authentication method (trusted-publishing or api-key)'
        type: string
        required: false
        default: 'trusted-publishing'

      # =======================================================================
      # Caching
      # =======================================================================
      cache-enabled:
        description: 'Enable NuGet package caching'
        type: boolean
        required: false
        default: true

      # =======================================================================
      # Runner Configuration
      # =======================================================================
      runs-on:
        description: 'Primary runner for builds. Default: ubuntu-latest. Windows TFMs are built using EnableWindowsTargeting on Linux.'
        type: string
        required: false
        default: 'ubuntu-latest'

      runs-on-windows:
        description: 'Windows runner for validation builds (only used when enable-platform-matrix is true)'
        type: string
        required: false
        default: 'windows-latest'

      enable-platform-matrix:
        description: 'Enable parallel validation builds on BOTH Linux AND Windows. Both build ALL TFMs. Package is produced from primary runner only. Use for cross-platform build verification.'
        type: boolean
        required: false
        default: false

      timeout-minutes:
        description: 'Job timeout in minutes'
        type: number
        required: false
        default: 30

    secrets:
      NUGET_API_KEY:
        description: 'NuGet.org API key (fallback if Trusted Publishing not configured)'
        required: false

      DOTNET_SIGNKEY_BASE64:
        description: 'Base64-encoded .snk file for assembly signing'
        required: false

      CODECOV_TOKEN:
        description: 'Codecov token for coverage upload (optional)'
        required: false

    outputs:
      version:
        description: 'Package version'
        value: ${{ jobs.build.outputs.version }}

      package-path:
        description: 'Path to main .nupkg file'
        value: ${{ jobs.build.outputs.package-path }}

      symbols-path:
        description: 'Path to .snupkg file'
        value: ${{ jobs.build.outputs.symbols-path }}

      package-name:
        description: 'Full package name with version'
        value: ${{ jobs.build.outputs.package-name }}

      build-succeeded:
        description: 'Whether build succeeded'
        value: ${{ jobs.build.outputs.build-succeeded }}

      test-passed:
        description: 'Whether tests passed'
        value: ${{ jobs.build.outputs.test-passed }}

      test-skipped:
        description: 'Whether tests were skipped (no test projects found)'
        value: ${{ jobs.build.outputs.test-skipped }}

      coverage-percentage:
        description: 'Code coverage percentage'
        value: ${{ jobs.build.outputs.coverage-percentage }}

      pushed-to-nuget:
        description: 'Whether package was pushed to NuGet.org'
        value: ${{ jobs.publish-nuget.outputs.pushed || 'false' }}

      pushed-to-github:
        description: 'Whether package was pushed to GitHub Packages'
        value: ${{ jobs.publish-github.outputs.pushed || 'false' }}

      windows-build-succeeded:
        description: 'Whether Windows validation build succeeded (only when enable-platform-matrix is true)'
        value: ${{ jobs.build-windows.outputs.build-succeeded || 'skipped' }}

permissions:
  contents: write
  packages: write
  id-token: write
  security-events: write

jobs:
  # ===========================================================================
  # Primary Build Job (produces the package)
  # ===========================================================================
  build:
    name: Build & Pack
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJSON(inputs.runs-on) || inputs.runs-on }}
    timeout-minutes: ${{ inputs.timeout-minutes }}

    outputs:
      version: ${{ steps.dotnet-build.outputs.version }}
      package-path: ${{ steps.dotnet-build.outputs.package-path }}
      symbols-path: ${{ steps.dotnet-build.outputs.symbols-path }}
      package-name: ${{ steps.dotnet-build.outputs.package-name }}
      build-succeeded: ${{ steps.dotnet-build.outputs.build-succeeded }}
      test-passed: ${{ steps.dotnet-build.outputs.test-passed }}
      test-skipped: ${{ steps.dotnet-build.outputs.test-skipped }}
      coverage-percentage: ${{ steps.dotnet-build.outputs.coverage-percentage }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: .NET Build & Pack
        id: dotnet-build
        uses: bauer-group/automation-templates/.github/actions/dotnet-nuget@main
        with:
          working-directory: ${{ inputs.working-directory }}
          project-path: ${{ inputs.project-path }}
          configuration: ${{ inputs.configuration }}
          dotnet-version: ${{ inputs.dotnet-version }}
          run-tests: ${{ inputs.run-tests }}
          test-project-path: ${{ inputs.test-project-path }}
          test-filter: ${{ inputs.test-filter }}
          collect-coverage: ${{ inputs.collect-coverage }}
          coverage-threshold: ${{ inputs.coverage-threshold }}
          package-version: ${{ inputs.package-version }}
          release-version: ${{ inputs.release-version }}
          version-suffix: ${{ inputs.version-suffix }}
          update-project-version: ${{ inputs.update-project-version }}
          sign-assembly: ${{ inputs.sign-assembly }}
          snk-base64: ${{ secrets.DOTNET_SIGNKEY_BASE64 }}
          delay-sign: ${{ inputs.delay-sign }}
          create-package: ${{ inputs.create-package }}
          include-symbols: ${{ inputs.include-symbols }}
          include-source: ${{ inputs.include-source }}
          deterministic-build: ${{ inputs.deterministic-build }}
          push-to-nuget: 'false'
          push-to-github: 'false'
          cache-enabled: ${{ inputs.cache-enabled }}

      - name: Upload Coverage to Codecov
        if: inputs.collect-coverage == true && steps.dotnet-build.outputs.test-skipped != 'true'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ${{ inputs.working-directory }}/TestResults
          fail_ci_if_error: false
        continue-on-error: true

  # ===========================================================================
  # Windows Validation Build (optional, for cross-platform verification)
  # ===========================================================================
  build-windows:
    name: Build (Windows Validation)
    if: inputs.enable-platform-matrix == true
    runs-on: ${{ startsWith(inputs.runs-on-windows, '[') && fromJSON(inputs.runs-on-windows) || inputs.runs-on-windows }}
    timeout-minutes: ${{ inputs.timeout-minutes }}

    outputs:
      build-succeeded: ${{ steps.dotnet-build.outputs.build-succeeded }}
      test-passed: ${{ steps.dotnet-build.outputs.test-passed }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: .NET Build (Validation Only)
        id: dotnet-build
        uses: bauer-group/automation-templates/.github/actions/dotnet-nuget@main
        with:
          working-directory: ${{ inputs.working-directory }}
          project-path: ${{ inputs.project-path }}
          configuration: ${{ inputs.configuration }}
          dotnet-version: ${{ inputs.dotnet-version }}
          run-tests: ${{ inputs.run-tests }}
          test-project-path: ${{ inputs.test-project-path }}
          test-filter: ${{ inputs.test-filter }}
          collect-coverage: false
          package-version: ${{ inputs.package-version }}
          release-version: ${{ inputs.release-version }}
          version-suffix: ${{ inputs.version-suffix }}
          sign-assembly: ${{ inputs.sign-assembly }}
          snk-base64: ${{ secrets.DOTNET_SIGNKEY_BASE64 }}
          delay-sign: ${{ inputs.delay-sign }}
          # Don't create package - just validate build
          create-package: false
          push-to-nuget: 'false'
          push-to-github: 'false'
          cache-enabled: ${{ inputs.cache-enabled }}

  # ===========================================================================
  # Publish to NuGet.org
  # ===========================================================================
  publish-nuget:
    name: Publish to NuGet.org
    needs: [build, build-windows]
    if: |
      always() &&
      inputs.push-to-nuget == true &&
      needs.build.outputs.build-succeeded == 'true' &&
      (needs.build-windows.result == 'success' || needs.build-windows.result == 'skipped')
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJSON(inputs.runs-on) || inputs.runs-on }}
    timeout-minutes: 10

    outputs:
      pushed: ${{ steps.push.outputs.pushed }}

    steps:
      - name: Download NuGet Packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: nupkg

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: Push to NuGet.org
        id: push
        shell: bash
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
          PACKAGE_NAME: ${{ needs.build.outputs.package-name }}
          PACKAGE_VERSION: ${{ needs.build.outputs.version }}
        run: |
          echo "Pushing to NuGet.org..."

          NUPKG_FILE=$(find nupkg -name "*.nupkg" ! -name "*.symbols.nupkg" 2>/dev/null | head -1)
          SNUPKG_FILE=$(find nupkg -name "*.snupkg" 2>/dev/null | head -1)

          if [ -z "$NUPKG_FILE" ]; then
            echo "No .nupkg file found!"
            echo "pushed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "Package: $NUPKG_FILE"

          PUSH_ARGS="--source https://api.nuget.org/v3/index.json"

          if [ "${{ inputs.skip-duplicate }}" = "true" ]; then
            PUSH_ARGS="$PUSH_ARGS --skip-duplicate"
          fi

          if [ "${{ inputs.nuget-auth-method }}" = "api-key" ] && [ -n "$NUGET_API_KEY" ]; then
            echo "Using API key authentication"
            PUSH_ARGS="$PUSH_ARGS --api-key $NUGET_API_KEY"
          elif [ -n "$NUGET_API_KEY" ]; then
            echo "Using API key authentication (fallback)"
            PUSH_ARGS="$PUSH_ARGS --api-key $NUGET_API_KEY"
          else
            echo "Using Trusted Publishing (OIDC)"
            PUSH_ARGS="$PUSH_ARGS --api-key az"
          fi

          if dotnet nuget push "$NUPKG_FILE" $PUSH_ARGS; then
            echo "pushed=true" >> $GITHUB_OUTPUT
            echo "Successfully pushed to NuGet.org"

            if [ -n "$SNUPKG_FILE" ] && [ -f "$SNUPKG_FILE" ]; then
              echo "Pushing symbols package..."
              dotnet nuget push "$SNUPKG_FILE" $PUSH_ARGS || echo "Symbols push skipped"
            fi
          else
            echo "pushed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # ===========================================================================
  # Publish to GitHub Packages
  # ===========================================================================
  publish-github:
    name: Publish to GitHub Packages
    needs: [build, build-windows]
    if: |
      always() &&
      inputs.push-to-github == true &&
      needs.build.outputs.build-succeeded == 'true' &&
      (needs.build-windows.result == 'success' || needs.build-windows.result == 'skipped')
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJSON(inputs.runs-on) || inputs.runs-on }}
    timeout-minutes: 10

    outputs:
      pushed: ${{ steps.push.outputs.pushed }}

    steps:
      - name: Download NuGet Packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: nupkg

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: Push to GitHub Packages
        id: push
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Pushing to GitHub Packages..."

          NUPKG_FILE=$(find nupkg -name "*.nupkg" ! -name "*.symbols.nupkg" 2>/dev/null | head -1)

          if [ -z "$NUPKG_FILE" ]; then
            echo "No .nupkg file found!"
            echo "pushed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "Package: $NUPKG_FILE"

          OWNER="${GITHUB_REPOSITORY_OWNER}"
          GITHUB_NUGET_SOURCE="https://nuget.pkg.github.com/${OWNER}/index.json"

          PUSH_ARGS="--source $GITHUB_NUGET_SOURCE --api-key $GITHUB_TOKEN"

          if [ "${{ inputs.skip-duplicate }}" = "true" ]; then
            PUSH_ARGS="$PUSH_ARGS --skip-duplicate"
          fi

          if dotnet nuget push "$NUPKG_FILE" $PUSH_ARGS; then
            echo "pushed=true" >> $GITHUB_OUTPUT
            echo "Successfully pushed to GitHub Packages"
          else
            echo "pushed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # ===========================================================================
  # Commit Version Update
  # ===========================================================================
  commit-version:
    name: Commit Version Update
    needs: [build, publish-nuget, publish-github]
    if: |
      always() &&
      inputs.update-project-version == true &&
      needs.build.outputs.build-succeeded == 'true' &&
      (needs.publish-nuget.result == 'success' || needs.publish-nuget.result == 'skipped') &&
      (needs.publish-github.result == 'success' || needs.publish-github.result == 'skipped')
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJSON(inputs.runs-on) || inputs.runs-on }}
    timeout-minutes: 5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Commit Version Changes
        shell: bash
        env:
          PACKAGE_VERSION: ${{ needs.build.outputs.version }}
        run: |
          VERSION="$PACKAGE_VERSION"
          echo "Committing version update: $VERSION"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          git checkout "$DEFAULT_BRANCH"
          git pull origin "$DEFAULT_BRANCH" --ff-only

          CHANGED=false

          if [ -f "Directory.Build.props" ]; then
            if grep -q '<VersionPrefix>' Directory.Build.props; then
              sed -i "s|<VersionPrefix>.*</VersionPrefix>|<VersionPrefix>$VERSION</VersionPrefix>|" Directory.Build.props
              CHANGED=true
            elif grep -q '<Version>' Directory.Build.props; then
              sed -i "s|<Version>.*</Version>|<Version>$VERSION</Version>|" Directory.Build.props
              CHANGED=true
            fi
          fi

          PROJECT_FILE="${{ inputs.project-path }}"
          if [ -f "$PROJECT_FILE" ] && [[ "$PROJECT_FILE" == *.csproj ]]; then
            if grep -q '<VersionPrefix>' "$PROJECT_FILE"; then
              sed -i "s|<VersionPrefix>.*</VersionPrefix>|<VersionPrefix>$VERSION</VersionPrefix>|" "$PROJECT_FILE"
              CHANGED=true
            elif grep -q '<Version>' "$PROJECT_FILE"; then
              sed -i "s|<Version>.*</Version>|<Version>$VERSION</Version>|" "$PROJECT_FILE"
              CHANGED=true
            fi
          fi

          if [ "$CHANGED" = "true" ] && ! git diff --quiet; then
            git add -A
            git commit -m "chore(release): bump version to $VERSION"
            git push origin "$DEFAULT_BRANCH"
            echo "Version update committed"
          else
            echo "No version changes to commit"
          fi

  # ===========================================================================
  # Pipeline Summary
  # ===========================================================================
  summary:
    name: Pipeline Summary
    needs: [build, build-windows, publish-nuget, publish-github]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Generate Summary
        shell: bash
        env:
          PACKAGE_NAME: ${{ needs.build.outputs.package-name }}
          PACKAGE_VERSION: ${{ needs.build.outputs.version }}
          TEST_SKIPPED: ${{ needs.build.outputs.test-skipped }}
          TEST_PASSED: ${{ needs.build.outputs.test-passed }}
          COVERAGE: ${{ needs.build.outputs.coverage-percentage }}
        run: |
          echo "## .NET Library Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Feature | Enabled |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ inputs.run-tests && 'Yes' || 'No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Coverage | ${{ inputs.collect-coverage && 'Yes' || 'No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Assembly Signing | ${{ inputs.sign-assembly && 'Yes' || 'No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Symbol Packages | ${{ inputs.include-symbols && 'Yes' || 'No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deterministic Build | ${{ inputs.deterministic-build && 'Yes' || 'No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Platform Matrix | ${{ inputs.enable-platform-matrix && 'Yes' || 'No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build (Primary) | ${{ needs.build.result == 'success' && 'Success' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.enable-platform-matrix }}" = "true" ]; then
            echo "| Build (Windows Validation) | ${{ needs.build-windows.result == 'success' && 'Success' || needs.build-windows.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| NuGet.org | ${{ inputs.push-to-nuget != true && 'Disabled' || needs.publish-nuget.result == 'success' && 'Published' || 'Failed/Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Packages | ${{ inputs.push-to-github != true && 'Disabled' || needs.publish-github.result == 'success' && 'Published' || 'Failed/Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Package Information" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Project | \`${{ inputs.project-path }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | \`${{ inputs.configuration }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`$PACKAGE_VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Name | \`$PACKAGE_NAME\` |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.collect-coverage }}" = "true" ] && [ "$TEST_SKIPPED" != "true" ]; then
            echo "| Coverage | ${COVERAGE}% |" >> $GITHUB_STEP_SUMMARY
          fi
