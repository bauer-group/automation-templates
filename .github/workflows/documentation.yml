name: 📄 Documentation Management

# Documentation management workflow using modular components
# Replaces the legacy readme.yml workflow

on:
  push:
    branches: [main]
    paths:
      - 'docs/README.template.MD'
      - 'scripts/generate_readme.py'
      - '.github/actions/readme-generate/**'
      - '.github/workflows/documentation.yml'
  pull_request:
    branches: [main]
    paths:
      - 'docs/README.template.MD'

  workflow_dispatch:
    inputs:
      force-update:
        description: 'Force README update even without changes'
        type: boolean
        default: false
      custom-version:
        description: 'Custom version for README'
        type: string
        default: ''
  
  workflow_call:
    inputs:
      tag-name:
        description: 'Tag name that triggered the documentation update'
        type: string
        required: false
        default: ''
      force-update:
        description: 'Force README update even without changes'
        type: boolean
        required: false
        default: false
      custom-version:
        description: 'Custom version for README'
        type: string
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  # Generate README using the readme-generate action directly
  generate-documentation:
    name: Generate Documentation
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.should-run.outputs.should_run }}
      readme_updated: ${{ steps.generate.outputs.readme_updated || 'false' }}
      changes_detected: ${{ steps.generate.outputs.changes_detected || 'false' }}
      validation_passed: ${{ steps.generate.outputs.validation_passed || steps.should-run.outputs.should_run == 'false' && 'skipped' || 'false' }}
      file_size: ${{ steps.generate.outputs.file_size }}
      unresolved_placeholders: ${{ steps.generate.outputs.unresolved_placeholders }}
    
    steps:
      - name: 🚀 Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          fetch-tags: true

      - name: 🔍 Check if workflow should run
        id: should-run
        run: |
          echo "🔍 Determining if workflow should run..."
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref Type: ${{ github.ref_type }}"
          echo "Force Update: ${{ inputs.force-update }}"
          
          # Always run if force-update is true (from manual trigger)
          if [[ "${{ inputs.force-update }}" == "true" ]]; then
            echo "🔄 ✅ FORCE UPDATE ENABLED - will run regardless of other conditions"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "skip_reason=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Always run for tags - update README with new version
          if [[ "${{ github.ref }}" == refs/tags/* ]] || [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "🏷️ ✅ RUNNING FOR TAG: ${{ github.ref_name }}"
            echo "🏷️ Updating README with new version information"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "skip_reason=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Always run for workflow_call (called by other workflows)
          if [[ "${{ github.event_name }}" == "workflow_call" ]]; then
            echo "✅ Running for workflow call"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "skip_reason=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Always run for workflow_dispatch (manual trigger)
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "✅ Running for manual trigger"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "skip_reason=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Always run for pull requests
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "✅ Running for pull request"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "skip_reason=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For push events to main, workflow should trigger based on paths filter
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "✅ Running for push to main (paths filter applies automatically)"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "skip_reason=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Default fallback
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "skip_reason=" >> $GITHUB_OUTPUT

      - name: 🔍 Validate Prerequisites
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          TEMPLATE_FILE="${{ inputs.template-path || 'docs/README.template.MD' }}"
          
          if [ ! -f "$TEMPLATE_FILE" ]; then
            echo "❌ Template file not found: $TEMPLATE_FILE"
            echo "💡 Available template files:"
            find . -name "*.template.*" -type f | head -10
            exit 1
          fi
          
          echo "✅ Template file found: $TEMPLATE_FILE"

      - name: 📝 Generate Professional README
        id: generate
        if: steps.should-run.outputs.should_run == 'true'
        uses: bauer-group/automation-templates/.github/actions/readme-generate@main
        with:
          template-path: 'docs/README.template.MD'
          output-path: 'README.MD'
          project-name: 'Automation Templates'
          company-name: 'BAUER GROUP'
          project-description: 'Professional automation templates and workflows with modular, reusable components for GitHub repositories'
          contact-email: 'support@bauer-group.com'
          documentation-url: 'https://github.com/bauer-group/automation-templates/wiki'
          support-url: 'https://github.com/bauer-group/automation-templates/issues'
          force-update: ${{ inputs.force-update || startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_call' }}
          custom-version: ${{ inputs.custom-version || (startsWith(github.ref, 'refs/tags/') && github.ref_name) || (github.event_name == 'workflow_call' && inputs.tag-name) || '' }}

      - name: 📄 Commit and Push Changes
        if: steps.should-run.outputs.should_run == 'true' && steps.generate.outputs.changes_detected == 'true' && github.event_name != 'pull_request'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "📄 README Bot"
          
          COMMIT_MSG="docs: update README.MD"
          
          if [[ "${{ github.ref }}" == refs/tags/* ]] || [[ "${{ github.ref_type }}" == "tag" ]]; then
            COMMIT_MSG="$COMMIT_MSG for tag ${{ github.ref_name }} [automated]"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.force-update }}" = "true" ]; then
              COMMIT_MSG="$COMMIT_MSG (forced update)"
            fi
            if [ -n "${{ inputs.custom-version }}" ]; then
              COMMIT_MSG="$COMMIT_MSG (version ${{ inputs.custom-version }})"
            fi
          fi
          
          COMMIT_MSG="$COMMIT_MSG [automated]"
          
          # Always sync with latest main before committing
          git fetch origin main
          git pull --rebase origin main || true
          
          git add README.MD
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"
          
          # Try to push, if it fails, sync and retry
          if ! git push; then
            echo "Push failed, syncing with remote and retrying..."
            git fetch origin main
            git pull --rebase origin main
            git push
          fi

  # Validate documentation links and structure
  validate-documentation:
    name: Validate Documentation
    needs: generate-documentation
    if: needs.generate-documentation.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: 🚀 Checkout Repository
        uses: actions/checkout@v4

      - name: 🔍 Validate Documentation Structure
        run: |
          echo "🔍 Validating documentation structure..."
          
          # Check for required documentation files
          REQUIRED_DOCS=(
            "README.MD"
            "docs/README.template.MD"
          )
          
          MISSING_DOCS=()
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              MISSING_DOCS+=("$doc")
            fi
          done
          
          if [ ${#MISSING_DOCS[@]} -gt 0 ]; then
            echo "❌ Missing documentation files:"
            for doc in "${MISSING_DOCS[@]}"; do
              echo "  - $doc"
            done
            exit 1
          else
            echo "✅ All required documentation files found"
          fi

      - name: 🔗 Check Documentation Links
        run: |
          echo "🔗 Checking internal documentation links..."
          
          # Check for broken internal links in README.MD
          if [ -f "README.MD" ]; then
            echo "Checking README.MD for broken internal links..."
            
            # Extract relative links
            grep -o "]\(\./[^)]*\)" README.MD | while read -r link; do
              file_path=$(echo "$link" | sed 's/](\.\///; s/)//')
              
              # Skip anchor links for now
              if [[ "$file_path" == *"#"* ]]; then
                file_path=$(echo "$file_path" | cut -d'#' -f1)
              fi
              
              if [ -n "$file_path" ] && [ ! -f "$file_path" ] && [ ! -d "$file_path" ]; then
                echo "⚠️ Potentially broken link: $link -> $file_path"
              fi
            done || echo "No relative links found or all links valid"
          fi

      - name: 📊 Documentation Summary
        run: |
          echo "### 📄 Documentation Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if workflow should have run
          if [ "${{ needs.generate-documentation.outputs.should_run }}" = "false" ]; then
            echo "ℹ️ **Workflow skipped - no relevant files changed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No documentation-related files were modified in this push." >> $GITHUB_STEP_SUMMARY
          else
            echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| **README Generated** | ${{ needs.generate-documentation.outputs.readme_updated == 'true' && '✅ Updated' || '⏭️ No changes' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Template Validation** | ${{ needs.generate-documentation.outputs.validation_passed == 'true' && '✅ Passed' || needs.generate-documentation.outputs.validation_passed == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Link Validation** | ✅ Completed |" >> $GITHUB_STEP_SUMMARY
            echo "| **Structure Check** | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.generate-documentation.outputs.readme_updated }}" = "true" ]; then
            echo "📝 **Documentation updated successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Changes include:**" >> $GITHUB_STEP_SUMMARY
            echo "- Updated version and date information" >> $GITHUB_STEP_SUMMARY
            echo "- Current repository metadata" >> $GITHUB_STEP_SUMMARY
            echo "- Modular workflow architecture documentation" >> $GITHUB_STEP_SUMMARY
            
            if [[ "${{ github.ref }}" == refs/tags/* ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "🏷️ **Tag Details:**" >> $GITHUB_STEP_SUMMARY
              echo "- Tag: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
              echo "- Ref: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
              echo "- Triggered by: Tag push" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ℹ️ **No documentation updates required**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🧩 **Modular Components Used:**" >> $GITHUB_STEP_SUMMARY
          echo "- README Generator Workflow: [examples/readme.yml](github/workflows/examples/readme.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- README Generator Action: [actions/readme-generate](.github/actions/readme-generate/)" >> $GITHUB_STEP_SUMMARY