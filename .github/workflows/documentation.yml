name: üìÑ Documentation Management

# Documentation management workflow using modular components
# Replaces the legacy readme.yml workflow

on:
  push:
    branches: 
      - main
    tags:
      - 'v*.*.*'
      - 'v*'
      - '[0-9]+.[0-9]+.[0-9]+'
  pull_request:
    branches: [main]
    paths:
      - 'docs/README.template.MD'
  workflow_dispatch:
    inputs:
      force-update:
        description: 'Force README update even without changes'
        type: boolean
        default: false
      custom-version:
        description: 'Custom version for README'
        type: string
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  # Generate README using the readme-generate action directly
  generate-documentation:
    name: Generate Documentation
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.should-run.outputs.should_run }}
      readme_updated: ${{ steps.generate.outputs.readme_updated || 'false' }}
      changes_detected: ${{ steps.generate.outputs.changes_detected || 'false' }}
      validation_passed: ${{ steps.generate.outputs.validation_passed || steps.should-run.outputs.should_run == 'false' && 'skipped' || 'false' }}
      file_size: ${{ steps.generate.outputs.file_size }}
      unresolved_placeholders: ${{ steps.generate.outputs.unresolved_placeholders }}
    
    steps:
      - name: üöÄ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: üîç Check if workflow should run
        id: should-run
        run: |
          # Always run for tags
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "Running for tag: ${{ github.ref_name }}"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "skip_reason=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Always run for pull requests
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "Running for pull request"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "skip_reason=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Always run for workflow_dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Running for manual trigger"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "skip_reason=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For push to main, check if relevant files changed
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "Checking for relevant file changes..."
            
            # Get changed files
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only $(git rev-list --max-parents=0 HEAD) HEAD)
            
            # Check if any relevant files changed
            for file in $CHANGED_FILES; do
              if [[ "$file" == "docs/README.template.MD" ]] || \
                 [[ "$file" == .github/actions/readme-generate/* ]] || \
                 [[ "$file" == ".github/workflows/documentation.yml" ]]; then
                echo "Relevant file changed: $file"
                echo "should_run=true" >> $GITHUB_OUTPUT
                echo "skip_reason=" >> $GITHUB_OUTPUT
                exit 0
              fi
            done
            
            echo "No relevant files changed - skipping workflow"
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "skip_reason=No documentation-related files changed" >> $GITHUB_OUTPUT
            
            # Create a minimal summary for skipped runs
            echo "### üìÑ Documentation Workflow" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚è≠Ô∏è **Skipped** - No documentation-related files were modified" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Files checked:" >> $GITHUB_STEP_SUMMARY
            echo "- \`docs/README.template.MD\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`.github/actions/readme-generate/**\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`.github/workflows/documentation.yml\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üîç Validate Prerequisites
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          TEMPLATE_FILE="${{ inputs.template-path || 'docs/README.template.MD' }}"
          
          if [ ! -f "$TEMPLATE_FILE" ]; then
            echo "‚ùå Template file not found: $TEMPLATE_FILE"
            echo "üí° Available template files:"
            find . -name "*.template.*" -type f | head -10
            exit 1
          fi
          
          echo "‚úÖ Template file found: $TEMPLATE_FILE"

      - name: üìù Generate Professional README
        id: generate
        if: steps.should-run.outputs.should_run == 'true'
        uses: ./.github/actions/readme-generate
        with:
          template-path: 'docs/README.template.MD'
          output-path: 'README.MD'
          project-name: 'Automation Templates'
          company-name: 'BAUER GROUP'
          project-description: 'Professional automation templates and workflows with modular, reusable components for GitHub repositories'
          contact-email: 'support@bauer-group.com'
          documentation-url: 'https://github.com/bauer-group/automation-templates/wiki'
          support-url: 'https://github.com/bauer-group/automation-templates/issues'
          force-update: ${{ inputs.force-update || startsWith(github.ref, 'refs/tags/') }}
          custom-version: ${{ inputs.custom-version || (startsWith(github.ref, 'refs/tags/') && github.ref_name) || '' }}

      - name: üìÑ Commit and Push Changes
        if: steps.should-run.outputs.should_run == 'true' && steps.generate.outputs.changes_detected == 'true' && github.event_name != 'pull_request'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "üìÑ README Bot"
          
          COMMIT_MSG="docs: update README.MD"
          
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            COMMIT_MSG="$COMMIT_MSG for tag ${{ github.ref_name }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.force-update }}" = "true" ]; then
              COMMIT_MSG="$COMMIT_MSG (forced update)"
            fi
            if [ -n "${{ inputs.custom-version }}" ]; then
              COMMIT_MSG="$COMMIT_MSG (version ${{ inputs.custom-version }})"
            fi
          fi
          
          COMMIT_MSG="$COMMIT_MSG [automated]"
          
          git add README.MD
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"
          git push

  # Validate documentation links and structure
  validate-documentation:
    name: Validate Documentation
    needs: generate-documentation
    if: needs.generate-documentation.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: üöÄ Checkout Repository
        uses: actions/checkout@v4

      - name: üîç Validate Documentation Structure
        run: |
          echo "üîç Validating documentation structure..."
          
          # Check for required documentation files
          REQUIRED_DOCS=(
            "README.MD"
            "docs/README.template.MD"
          )
          
          MISSING_DOCS=()
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              MISSING_DOCS+=("$doc")
            fi
          done
          
          if [ ${#MISSING_DOCS[@]} -gt 0 ]; then
            echo "‚ùå Missing documentation files:"
            for doc in "${MISSING_DOCS[@]}"; do
              echo "  - $doc"
            done
            exit 1
          else
            echo "‚úÖ All required documentation files found"
          fi

      - name: üîó Check Documentation Links
        run: |
          echo "üîó Checking internal documentation links..."
          
          # Check for broken internal links in README.MD
          if [ -f "README.MD" ]; then
            echo "Checking README.MD for broken internal links..."
            
            # Extract relative links
            grep -o "]\(\./[^)]*\)" README.MD | while read -r link; do
              file_path=$(echo "$link" | sed 's/](\.\///; s/)//')
              
              # Skip anchor links for now
              if [[ "$file_path" == *"#"* ]]; then
                file_path=$(echo "$file_path" | cut -d'#' -f1)
              fi
              
              if [ -n "$file_path" ] && [ ! -f "$file_path" ] && [ ! -d "$file_path" ]; then
                echo "‚ö†Ô∏è Potentially broken link: $link -> $file_path"
              fi
            done || echo "No relative links found or all links valid"
          fi

      - name: üìä Documentation Summary
        run: |
          echo "### üìÑ Documentation Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if workflow should have run
          if [ "${{ needs.generate-documentation.outputs.should_run }}" = "false" ]; then
            echo "‚ÑπÔ∏è **Workflow skipped - no relevant files changed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No documentation-related files were modified in this push." >> $GITHUB_STEP_SUMMARY
          else
            echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| **README Generated** | ${{ needs.generate-documentation.outputs.readme_updated == 'true' && '‚úÖ Updated' || '‚è≠Ô∏è No changes' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Template Validation** | ${{ needs.generate-documentation.outputs.validation_passed == 'true' && '‚úÖ Passed' || needs.generate-documentation.outputs.validation_passed == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Link Validation** | ‚úÖ Completed |" >> $GITHUB_STEP_SUMMARY
            echo "| **Structure Check** | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.generate-documentation.outputs.readme_updated }}" = "true" ]; then
            echo "üìù **Documentation updated successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Changes include:**" >> $GITHUB_STEP_SUMMARY
            echo "- Updated version and date information" >> $GITHUB_STEP_SUMMARY
            echo "- Current repository metadata" >> $GITHUB_STEP_SUMMARY
            echo "- Modular workflow architecture documentation" >> $GITHUB_STEP_SUMMARY
            
            if [[ "${{ github.ref }}" == refs/tags/* ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "üè∑Ô∏è **Tag Details:**" >> $GITHUB_STEP_SUMMARY
              echo "- Tag: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
              echo "- Ref: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
              echo "- Triggered by: Tag push" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ÑπÔ∏è **No documentation updates required**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üß© **Modular Components Used:**" >> $GITHUB_STEP_SUMMARY
          echo "- README Generator Workflow: [examples/readme.yml](github/workflows/examples/readme.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- README Generator Action: [actions/readme-generate](.github/actions/readme-generate/)" >> $GITHUB_STEP_SUMMARY