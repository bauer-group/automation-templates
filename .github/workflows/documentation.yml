name: ðŸ“„ Documentation Management

# Documentation management workflow using modular components
# Replaces the legacy readme.yml workflow

on:
  push:
    branches: 
      - main
    tags:
      - 'v*.*.*'
      - 'v*'
      - '[0-9]+.[0-9]+.[0-9]+'
  pull_request:
    branches: [main]
    paths:
      - 'docs/README.template.MD'
  workflow_dispatch:
    inputs:
      force-update:
        description: 'Force README update even without changes'
        type: boolean
        default: false
      custom-version:
        description: 'Custom version for README'
        type: string
        default: ''
  # Triggered by other workflows when tags are created
  workflow_call:
    inputs:
      tag-name:
        description: 'Tag name that triggered the documentation update'
        type: string
        required: false
        default: ''
      force-update:
        description: 'Force README update even without changes'
        type: boolean
        required: false
        default: false
      custom-version:
        description: 'Custom version to use in documentation (overrides auto-detection)'
        type: string
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  # Generate README using the readme-generate action directly
  generate-documentation:
    name: Generate Documentation
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.should-run.outputs.should_run }}
      readme_updated: ${{ steps.generate.outputs.readme_updated || 'false' }}
      changes_detected: ${{ steps.generate.outputs.changes_detected || 'false' }}
      validation_passed: ${{ steps.generate.outputs.validation_passed || steps.should-run.outputs.should_run == 'false' && 'skipped' || 'false' }}
      file_size: ${{ steps.generate.outputs.file_size }}
      unresolved_placeholders: ${{ steps.generate.outputs.unresolved_placeholders }}
    
    steps:
      - name: ðŸš€ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          fetch-tags: true

      - name: ðŸ” Check if workflow should run
        id: should-run
        run: |
          echo "ðŸ” Determining if workflow should run..."
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref Name: ${{ github.ref_name }}"
          echo "Ref Type: ${{ github.ref_type }}"
          echo "Force Update: ${{ inputs.force-update }}"
          echo "Tag Name Input: ${{ inputs.tag-name }}"
          
          # Always run if force-update is true (from workflow_call or manual trigger)
          if [[ "${{ inputs.force-update }}" == "true" ]]; then
            echo "ðŸ”„ âœ… FORCE UPDATE ENABLED - will run regardless of other conditions"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "skip_reason=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Always run for tags - HIGHEST PRIORITY
          if [[ "${{ github.ref }}" == refs/tags/* ]] || [[ "${{ github.ref_type }}" == "tag" ]] || [[ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]]; then
            echo "ðŸ·ï¸ âœ… FORCE RUNNING FOR TAG: ${{ github.ref_name }}"
            echo "ðŸ·ï¸ This will force update documentation regardless of file changes"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "skip_reason=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Always run for workflow_call (called by other workflows)
          if [[ "${{ github.event_name }}" == "workflow_call" ]]; then
            echo "âœ… Running for workflow call (tag: ${{ inputs.tag-name || 'none' }})"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "skip_reason=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Always run for workflow_dispatch (manual trigger)
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "âœ… Running for manual trigger"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "skip_reason=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Always run for pull requests
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "âœ… Running for pull request"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "skip_reason=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For push events, check if relevant files changed (but NOT for tags)
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Double-check this isn't a tag push (should have been caught above)
            if [[ "${{ github.ref }}" == refs/tags/* ]] || [[ "${{ github.ref_type }}" == "tag" ]]; then
              echo "ðŸ·ï¸ EMERGENCY TAG DETECTION - This is a tag push that should have been caught earlier!"
              echo "ðŸ·ï¸ âœ… FORCE RUNNING FOR TAG: ${{ github.ref_name }}"
              echo "ðŸ·ï¸ This will force update documentation regardless of file changes"
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "skip_reason=" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "ðŸ“‹ Checking for relevant file changes in push to ${{ github.ref_name }}..."
            
            # Get changed files in this push
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || echo "")
            
            # Fallback if github.event.before is not available
            if [ -z "$CHANGED_FILES" ]; then
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only $(git rev-list --max-parents=0 HEAD) HEAD)
            fi
            
            echo "Changed files in this push:"
            echo "$CHANGED_FILES"
            
            # Check if any relevant files changed
            RELEVANT_CHANGED=false
            while IFS= read -r file; do
              if [ -n "$file" ]; then
                echo "Checking file: $file"
                if [[ "$file" == "docs/README.template.MD" ]] || \
                   [[ "$file" == .github/actions/readme-generate/* ]] || \
                   [[ "$file" == ".github/workflows/documentation.yml" ]]; then
                  echo "Relevant file changed: $file"
                  RELEVANT_CHANGED=true
                  break
                fi
              fi
            done <<< "$CHANGED_FILES"
            
            if [ "$RELEVANT_CHANGED" = "true" ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "skip_reason=" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "No relevant files changed - skipping workflow"
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "skip_reason=No documentation-related files changed" >> $GITHUB_OUTPUT
            
            # Create a minimal summary for skipped runs
            echo "### ðŸ“„ Documentation Workflow" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ **Skipped** - No documentation-related files were modified" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Files checked:" >> $GITHUB_STEP_SUMMARY
            echo "- \`docs/README.template.MD\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`.github/actions/readme-generate/**\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`.github/workflows/documentation.yml\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ” Validate Prerequisites
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          TEMPLATE_FILE="${{ inputs.template-path || 'docs/README.template.MD' }}"
          
          if [ ! -f "$TEMPLATE_FILE" ]; then
            echo "âŒ Template file not found: $TEMPLATE_FILE"
            echo "ðŸ’¡ Available template files:"
            find . -name "*.template.*" -type f | head -10
            exit 1
          fi
          
          echo "âœ… Template file found: $TEMPLATE_FILE"

      - name: ðŸ“ Generate Professional README
        id: generate
        if: steps.should-run.outputs.should_run == 'true'
        uses: bauer-group/automation-templates/.github/actions/readme-generate@main
        with:
          template-path: 'docs/README.template.MD'
          output-path: 'README.MD'
          project-name: 'Automation Templates'
          company-name: 'BAUER GROUP'
          project-description: 'Professional automation templates and workflows with modular, reusable components for GitHub repositories'
          contact-email: 'support@bauer-group.com'
          documentation-url: 'https://github.com/bauer-group/automation-templates/wiki'
          support-url: 'https://github.com/bauer-group/automation-templates/issues'
          force-update: ${{ inputs.force-update || startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_call' }}
          custom-version: ${{ inputs.custom-version || (startsWith(github.ref, 'refs/tags/') && github.ref_name) || (github.event_name == 'workflow_call' && inputs.tag-name) || '' }}

      - name: ðŸ“„ Commit and Push Changes
        if: steps.should-run.outputs.should_run == 'true' && steps.generate.outputs.changes_detected == 'true' && github.event_name != 'pull_request'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "ðŸ“„ README Bot"
          
          COMMIT_MSG="docs: update README.MD"
          
          if [[ "${{ github.ref }}" == refs/tags/* ]] || [[ "${{ github.ref_type }}" == "tag" ]]; then
            COMMIT_MSG="$COMMIT_MSG for tag ${{ github.ref_name }} [automated]"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.force-update }}" = "true" ]; then
              COMMIT_MSG="$COMMIT_MSG (forced update)"
            fi
            if [ -n "${{ inputs.custom-version }}" ]; then
              COMMIT_MSG="$COMMIT_MSG (version ${{ inputs.custom-version }})"
            fi
          fi
          
          COMMIT_MSG="$COMMIT_MSG [automated]"
          
          # Commit changes if any exist
          if [[ -n $(git status --porcelain README.MD) ]]; then
            git add README.MD
            git commit -m "$COMMIT_MSG"
            
            # Pull and push with retry logic
            MAX_RETRIES=3
            for i in $(seq 1 $MAX_RETRIES); do
              git pull --no-edit --strategy=merge origin main && git push origin main && break
              if [ $i -eq $MAX_RETRIES ]; then
                echo "Failed to push after $MAX_RETRIES attempts"
                exit 1
              fi
              echo "Retry $i/$MAX_RETRIES after 2s..."
              sleep 2
            done
          else
            echo "No changes to README.MD"
          fi

  # Validate documentation links and structure
  validate-documentation:
    name: Validate Documentation
    needs: generate-documentation
    if: needs.generate-documentation.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸš€ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Validate Documentation Structure
        run: |
          echo "ðŸ” Validating documentation structure..."
          
          # Check for required documentation files
          REQUIRED_DOCS=(
            "README.MD"
            "docs/README.template.MD"
          )
          
          MISSING_DOCS=()
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              MISSING_DOCS+=("$doc")
            fi
          done
          
          if [ ${#MISSING_DOCS[@]} -gt 0 ]; then
            echo "âŒ Missing documentation files:"
            for doc in "${MISSING_DOCS[@]}"; do
              echo "  - $doc"
            done
            exit 1
          else
            echo "âœ… All required documentation files found"
          fi

      - name: ðŸ”— Check Documentation Links
        run: |
          echo "ðŸ”— Checking internal documentation links..."
          
          # Check for broken internal links in README.MD
          if [ -f "README.MD" ]; then
            echo "Checking README.MD for broken internal links..."
            
            # Extract relative links
            grep -o "]\(\./[^)]*\)" README.MD | while read -r link; do
              file_path=$(echo "$link" | sed 's/](\.\///; s/)//')
              
              # Skip anchor links for now
              if [[ "$file_path" == *"#"* ]]; then
                file_path=$(echo "$file_path" | cut -d'#' -f1)
              fi
              
              if [ -n "$file_path" ] && [ ! -f "$file_path" ] && [ ! -d "$file_path" ]; then
                echo "âš ï¸ Potentially broken link: $link -> $file_path"
              fi
            done || echo "No relative links found or all links valid"
          fi

      - name: ðŸ“Š Documentation Summary
        run: |
          echo "### ðŸ“„ Documentation Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if workflow should have run
          if [ "${{ needs.generate-documentation.outputs.should_run }}" = "false" ]; then
            echo "â„¹ï¸ **Workflow skipped - no relevant files changed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No documentation-related files were modified in this push." >> $GITHUB_STEP_SUMMARY
          else
            echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| **README Generated** | ${{ needs.generate-documentation.outputs.readme_updated == 'true' && 'âœ… Updated' || 'â­ï¸ No changes' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Template Validation** | ${{ needs.generate-documentation.outputs.validation_passed == 'true' && 'âœ… Passed' || needs.generate-documentation.outputs.validation_passed == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Link Validation** | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
            echo "| **Structure Check** | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.generate-documentation.outputs.readme_updated }}" = "true" ]; then
            echo "ðŸ“ **Documentation updated successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Changes include:**" >> $GITHUB_STEP_SUMMARY
            echo "- Updated version and date information" >> $GITHUB_STEP_SUMMARY
            echo "- Current repository metadata" >> $GITHUB_STEP_SUMMARY
            echo "- Modular workflow architecture documentation" >> $GITHUB_STEP_SUMMARY
            
            if [[ "${{ github.ref }}" == refs/tags/* ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ·ï¸ **Tag Details:**" >> $GITHUB_STEP_SUMMARY
              echo "- Tag: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
              echo "- Ref: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
              echo "- Triggered by: Tag push" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ **No documentation updates required**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ§© **Modular Components Used:**" >> $GITHUB_STEP_SUMMARY
          echo "- README Generator Workflow: [examples/readme.yml](github/workflows/examples/readme.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- README Generator Action: [actions/readme-generate](.github/actions/readme-generate/)" >> $GITHUB_STEP_SUMMARY