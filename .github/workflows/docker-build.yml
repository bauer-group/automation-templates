name: ðŸ³ Docker Build & Deploy

on:
  workflow_call:
    inputs:
      # Build Configuration
      working-directory:
        description: 'Working directory for all commands'
        type: string
        required: false
        default: '.'
      
      dockerfile-path:
        description: 'Path to Dockerfile'
        type: string
        required: false
        default: './Dockerfile'
      
      docker-context:
        description: 'Docker build context'
        type: string
        required: false
        default: '.'
      
      build-args:
        description: 'Build arguments as JSON object'
        type: string
        required: false
        default: '{}'
      
      build-target:
        description: 'Docker build target stage'
        type: string
        required: false
        default: ''
      
      # Platform Configuration
      platforms:
        description: 'Target platforms (comma-separated)'
        type: string
        required: false
        default: 'linux/amd64'
      
      multi-platform:
        description: 'Enable multi-platform builds'
        type: boolean
        required: false
        default: false
      
      # Registry Configuration
      registry:
        description: 'Docker registry URL (used when publish-to is ghcr)'
        type: string
        required: false
        default: 'ghcr.io'

      # Secondary Registry (for multi-registry push - build once, push to both)
      secondary-registry:
        description: 'Secondary Docker registry URL (e.g., docker.io for Docker Hub)'
        type: string
        required: false
        default: ''

      docker-image-name:
        description: 'Docker Hub image name (e.g., username/app-name)'
        type: string
        required: false
        default: ''

      ghcr-image-name:
        description: 'GitHub Container Registry image name (e.g., org/app-name, defaults to repository name)'
        type: string
        required: false
        default: ''
      
      image-tags:
        description: 'Additional custom image tags (comma-separated)'
        type: string
        required: false
        default: ''
      
      auto-tags:
        description: 'Generate automatic tags based on Git refs'
        type: boolean
        required: false
        default: true
      
      latest-tag:
        description: 'Tag image as latest on main branch'
        type: boolean
        required: false
        default: true

      version-from-dockerfile:
        description: 'Extract version from Dockerfile LABEL org.opencontainers.image.version and use as image tag'
        type: boolean
        required: false
        default: false

      semver-from-dockerfile:
        description: 'Generate additional semver tags (major.minor, major) from Dockerfile version on branch commits'
        type: boolean
        required: false
        default: true

      update-dockerfile-version:
        description: 'Update Dockerfile LABEL org.opencontainers.image.version with version from Git tag (strips v prefix)'
        type: boolean
        required: false
        default: false

      release-version:
        description: 'Release version to use for tagging (e.g., 0.5.0). When set, generates semver tags without requiring tag context. Use this when calling from a release workflow.'
        type: string
        required: false
        default: ''

      # Publish Target Configuration
      publish-to:
        description: 'Where to publish the image: ghcr, dockerhub, or both'
        type: string
        required: false
        default: 'ghcr'

      # Push Configuration
      push:
        description: 'Push image to registry'
        type: boolean
        required: false
        default: true
      
      push-on-pr:
        description: 'Push images on pull requests'
        type: boolean
        required: false
        default: false
      
      # Testing Configuration
      run-tests:
        description: 'Run tests before building'
        type: boolean
        required: false
        default: false
      
      test-command:
        description: 'Command to run tests'
        type: string
        required: false
        default: 'docker run --rm $IMAGE_TAG test'
      
      # Security Configuration
      security-scan:
        description: 'Run security vulnerability scan'
        type: boolean
        required: false
        default: true
      
      security-scanner:
        description: 'Security scanner (trivy, grype, snyk)'
        type: string
        required: false
        default: 'trivy'
      
      security-fail-on:
        description: 'Fail on security issues (CRITICAL, HIGH, MEDIUM, LOW)'
        type: string
        required: false
        default: 'CRITICAL'
      
      security-ignore-unfixed:
        description: 'Ignore unfixed vulnerabilities'
        type: boolean
        required: false
        default: false
      
      # Image Signing & SBOM
      sign-image:
        description: 'Sign image with cosign'
        type: boolean
        required: false
        default: false
      
      generate-sbom:
        description: 'Generate Software Bill of Materials'
        type: boolean
        required: false
        default: false
      
      sbom-format:
        description: 'SBOM format (cyclonedx, spdx)'
        type: string
        required: false
        default: 'cyclonedx'
      
      # Caching
      cache-enabled:
        description: 'Enable build caching'
        type: boolean
        required: false
        default: true
      
      cache-mode:
        description: 'Cache mode (min, max, inline)'
        type: string
        required: false
        default: 'max'
      
      # Matrix Configuration
      enable-matrix:
        description: 'Enable matrix builds'
        type: boolean
        required: false
        default: false
      
      matrix-platforms:
        description: 'Platform matrix as JSON array'
        type: string
        required: false
        default: '["linux/amd64"]'
      
      matrix-tags:
        description: 'Tag matrix as JSON array'
        type: string
        required: false
        default: '["latest"]'
      
      # Deployment Configuration
      deploy-enabled:
        description: 'Enable deployment after successful build'
        type: boolean
        required: false
        default: false
      
      deploy-environment:
        description: 'Deployment environment'
        type: string
        required: false
        default: 'staging'
      
      deploy-command:
        description: 'Custom deployment command'
        type: string
        required: false
        default: ''
      
      # Performance & Resource Configuration
      builder-driver:
        description: 'Builder driver (docker, docker-container, kubernetes)'
        type: string
        required: false
        default: 'docker-container'
      
      build-timeout:
        description: 'Build timeout in minutes'
        type: number
        required: false
        default: 30
      
      runs-on:
        description: 'Runner OS (ubuntu-latest, windows-latest, macos-latest)'
        type: string
        required: false
        default: 'ubuntu-latest'
      
      # Docker Hub README Sync
      sync-dockerhub-readme:
        description: 'Sync README to Docker Hub repository'
        type: boolean
        required: false
        default: false
      
      
      readme-file:
        description: 'Custom README file path (defaults to DOCKER_README.MD or README.MD)'
        type: string
        required: false
        default: ''
    
    secrets:
      DOCKER_USERNAME:
        description: 'Docker Hub username'
        required: false

      DOCKER_PASSWORD:
        description: 'Docker Hub password/token'
        required: false

      COSIGN_PRIVATE_KEY:
        description: 'Cosign private key for image signing'
        required: false
      
      COSIGN_PASSWORD:
        description: 'Cosign key password'
        required: false
      
      DOCKER_BUILD_SECRETS:
        description: 'Docker build secrets as JSON'
        required: false
      
    
    outputs:
      image-digest:
        description: 'Built image digest'
        value: ${{ jobs.build.outputs.image-digest }}
      
      image-tags:
        description: 'Generated image tags'
        value: ${{ jobs.build.outputs.image-tags }}
      
      image-url:
        description: 'Full image URL with tag'
        value: ${{ jobs.build.outputs.image-url }}
      
      image-size:
        description: 'Image size in bytes'
        value: ${{ jobs.build.outputs.image-size }}
      
      security-report:
        description: 'Security scan report status'
        value: ${{ jobs.build.outputs.security-report }}
      
      build-duration:
        description: 'Build duration in seconds'
        value: ${{ jobs.build.outputs.build-duration }}

# Permissions required for this reusable workflow
permissions:
  contents: write        # For committing Dockerfile version updates
  packages: write        # For pushing to GHCR
  security-events: write # For uploading SARIF reports to GitHub Security

jobs:
  build:
    name: Docker Build
    runs-on: ${{ inputs.enable-matrix && matrix.platform && 'ubuntu-latest' || inputs.runs-on }}
    timeout-minutes: ${{ inputs.build-timeout }}
    
    strategy:
      matrix:
        platform: ${{ inputs.enable-matrix && fromJson(inputs.matrix-platforms) || fromJson('["linux/amd64"]') }}
        tag-suffix: ${{ inputs.enable-matrix && fromJson(inputs.matrix-tags) || fromJson('[""]') }}
      fail-fast: false
    
    outputs:
      image-digest: ${{ steps.docker-build.outputs.image-digest }}
      image-tags: ${{ steps.docker-build.outputs.image-tags }}
      image-url: ${{ steps.docker-build.outputs.image-url }}
      image-size: ${{ steps.docker-build.outputs.image-size }}
      security-report: ${{ steps.docker-build.outputs.security-report }}
      build-duration: ${{ steps.docker-build.outputs.build-duration }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
      
      - name: ðŸ§ª Run Pre-Build Tests
        if: inputs.run-tests
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "ðŸ§ª Running pre-build tests..."
          
          # Check if custom test command provided
          if [ -n "${{ inputs.test-command }}" ]; then
            # Replace placeholder with actual image tag
            TEST_CMD="${{ inputs.test-command }}"
            eval "$TEST_CMD"
          else
            # Default test commands based on file existence
            if [ -f "package.json" ]; then
              npm test
            elif [ -f "requirements.txt" ]; then
              python -m pytest
            elif [ -f "go.mod" ]; then
              go test ./...
            elif [ -f "Cargo.toml" ]; then
              cargo test
            else
              echo "No test framework detected, skipping tests"
            fi
          fi
      
      - name: ðŸ³ Build Docker Image
        id: docker-build
        uses: bauer-group/automation-templates/.github/actions/docker-build@main
        with:
          working-directory: ${{ inputs.working-directory }}
          dockerfile-path: ${{ inputs.dockerfile-path }}
          docker-context: ${{ inputs.docker-context }}
          build-args: ${{ inputs.build-args }}
          build-secrets: ${{ secrets.DOCKER_BUILD_SECRETS }}
          target: ${{ inputs.build-target }}
          platforms: ${{ inputs.enable-matrix && matrix.platform || inputs.platforms }}
          multi-platform: ${{ inputs.enable-matrix && 'false' || inputs.multi-platform }}
          # Primary registry: GHCR (if publish-to is 'ghcr' or 'both') or Docker Hub (if publish-to is 'dockerhub')
          registry: ${{ inputs.publish-to == 'dockerhub' && 'docker.io' || inputs.registry }}
          registry-username: ${{ inputs.publish-to == 'dockerhub' && secrets.DOCKER_USERNAME || github.actor }}
          registry-password: ${{ inputs.publish-to == 'dockerhub' && secrets.DOCKER_PASSWORD || secrets.GITHUB_TOKEN }}
          # Secondary registry: Docker Hub (if publish-to is 'both')
          secondary-registry: ${{ inputs.publish-to == 'both' && 'docker.io' || inputs.secondary-registry }}
          secondary-registry-username: ${{ secrets.DOCKER_USERNAME }}
          secondary-registry-password: ${{ secrets.DOCKER_PASSWORD }}
          secondary-image-name: ${{ inputs.docker-image-name }}
          image-name: ${{ inputs.ghcr-image-name }}
          image-tags: ${{ inputs.image-tags }}${{ inputs.enable-matrix && matrix.tag-suffix && format('-{0}', matrix.tag-suffix) || '' }}
          auto-tags: ${{ inputs.auto-tags }}
          latest-tag: ${{ inputs.latest-tag }}
          version-from-dockerfile: ${{ inputs.version-from-dockerfile }}
          semver-from-dockerfile: ${{ inputs.semver-from-dockerfile }}
          update-dockerfile-version: ${{ inputs.update-dockerfile-version }}
          release-version: ${{ inputs.release-version }}
          push: ${{ inputs.push }}
          push-on-pr: ${{ inputs.push-on-pr }}
          cache-enabled: ${{ inputs.cache-enabled }}
          cache-mode: ${{ inputs.cache-mode }}
          security-scan: ${{ inputs.security-scan }}
          security-scanner: ${{ inputs.security-scanner }}
          security-fail-on: ${{ inputs.security-fail-on }}
          security-ignore-unfixed: ${{ inputs.security-ignore-unfixed }}
          sign-image: ${{ inputs.sign-image }}
          cosign-key: ${{ secrets.COSIGN_PRIVATE_KEY }}
          cosign-password: ${{ secrets.COSIGN_PASSWORD }}
          generate-sbom: ${{ inputs.generate-sbom }}
          sbom-format: ${{ inputs.sbom-format }}
          builder-driver: ${{ inputs.builder-driver }}
          build-timeout: ${{ inputs.build-timeout }}
      
      - name: ðŸ§ª Run Post-Build Tests
        if: inputs.run-tests && steps.docker-build.outputs.image-url
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "ðŸ§ª Running post-build tests on image..."
          
          IMAGE_URL="${{ steps.docker-build.outputs.image-url }}"
          
          # Basic image tests
          echo "Testing image: $IMAGE_URL"
          
          # Test image can be pulled and run
          docker run --rm "$IMAGE_URL" --version 2>/dev/null || \
          docker run --rm "$IMAGE_URL" version 2>/dev/null || \
          docker run --rm "$IMAGE_URL" -v 2>/dev/null || \
          docker run --rm --entrypoint="" "$IMAGE_URL" echo "Image runs successfully" || \
          echo "âš ï¸ Could not test image execution (this might be normal)"
          
          # Test image metadata
          docker inspect "$IMAGE_URL" > /dev/null
          echo "âœ… Image metadata validation passed"
          
          # Custom post-build test command
          if [ -n "${{ inputs.test-command }}" ]; then
            TEST_CMD="${{ inputs.test-command }}"
            TEST_CMD="${TEST_CMD//\$IMAGE_TAG/$IMAGE_URL}"
            eval "$TEST_CMD"
          fi

  # Docker Hub README synchronization
  dockerhub-readme:
    name: Sync Docker Hub README
    needs: build
    if: inputs.sync-dockerhub-readme == true && (inputs.publish-to == 'dockerhub' || inputs.publish-to == 'both') && needs.build.result == 'success' && inputs.push == true
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
      
      - name: ðŸ“„ Determine README File
        id: readme
        shell: bash
        run: |
          # Priority: Custom file -> DOCKER_README.MD -> README.MD
          if [ -n "${{ inputs.readme-file }}" ] && [ -f "${{ inputs.readme-file }}" ]; then
            README_FILE="${{ inputs.readme-file }}"
            echo "ðŸ“„ Using custom README file: $README_FILE"
          elif [ -f "DOCKER_README.MD" ]; then
            README_FILE="DOCKER_README.MD"
            echo "ðŸ“„ Using Docker-specific README: $README_FILE"
          elif [ -f "README.MD" ]; then
            README_FILE="README.MD"
            echo "ðŸ“„ Using main README: $README_FILE"
          elif [ -f "README.md" ]; then
            README_FILE="README.md"
            echo "ðŸ“„ Using main README: $README_FILE"
          else
            echo "âŒ No README file found!"
            exit 1
          fi
          
          echo "file=$README_FILE" >> $GITHUB_OUTPUT
          
          # Log file size and first few lines for verification
          echo "ðŸ“Š README file info:"
          echo "  - File: $README_FILE"
          echo "  - Size: $(wc -c < "$README_FILE") bytes"
          echo "  - Lines: $(wc -l < "$README_FILE") lines"
          echo ""
          echo "ðŸ“‹ First 5 lines preview:"
          head -5 "$README_FILE" | sed 's/^/    /'
          echo ""
      
      - name: ðŸ‹ Extract Docker Hub Repository Name
        id: docker-repo
        shell: bash
        run: |
          # Determine Docker Hub image name based on publish-to setting
          # - publish-to: 'dockerhub' -> use image-name (Docker Hub is primary)
          # - publish-to: 'both' -> use secondary-image-name (Docker Hub is secondary)

          PUBLISH_TO="${{ inputs.publish-to }}"

          if [ "$PUBLISH_TO" = "both" ]; then
            # Docker Hub is secondary registry, use docker-image-name
            DOCKER_REPO="${{ inputs.docker-image-name }}"
            if [ -z "$DOCKER_REPO" ]; then
              # Fallback to ghcr-image-name if docker-image-name not set
              DOCKER_REPO="${{ inputs.ghcr-image-name }}"
            fi
          else
            # Docker Hub is primary registry (publish-to: 'dockerhub')
            DOCKER_REPO="${{ inputs.docker-image-name || inputs.ghcr-image-name }}"
          fi

          # Fallback to github repository name if still empty
          if [ -z "$DOCKER_REPO" ]; then
            DOCKER_REPO="${{ github.repository }}"
          fi

          echo "ðŸ‹ Docker Hub repository: $DOCKER_REPO"
          echo "repository=$DOCKER_REPO" >> $GITHUB_OUTPUT

          # Validate repository name format (should be username/imagename)
          if [[ ! "$DOCKER_REPO" =~ ^[a-z0-9]+([._-][a-z0-9]+)*\/[a-z0-9]+([._-][a-z0-9]+)*$ ]]; then
            echo "âš ï¸ Warning: Repository name '$DOCKER_REPO' may not follow Docker Hub naming conventions"
            echo "   Expected format: username/imagename (e.g., 'myuser/myapp')"
          fi
      
      - name: ðŸ”„ Sync README to Docker Hub
        uses: peter-evans/dockerhub-description@v5
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          repository: ${{ steps.docker-repo.outputs.repository }}
          readme-filepath: ${{ steps.readme.outputs.file }}
          short-description: 'Docker image for ${{ github.repository }} - automatically synced from GitHub'
          enable-url-completion: true
      
      - name: âœ… README Sync Completed
        shell: bash
        run: |
          echo "âœ… Successfully synchronized README to Docker Hub!"
          echo ""
          echo "ðŸ“‹ Sync Details:"
          echo "  - Repository: ${{ steps.docker-repo.outputs.repository }}"
          echo "  - README File: ${{ steps.readme.outputs.file }}"
          echo "  - Docker Hub URL: https://hub.docker.com/r/${{ steps.docker-repo.outputs.repository }}"
          echo ""
          echo "ðŸ”— View on Docker Hub: https://hub.docker.com/r/${{ steps.docker-repo.outputs.repository }}"

  # Image vulnerability analysis (separate job for better performance)
  security-analysis:
    name: Security Analysis
    needs: build
    if: inputs.security-scan && needs.build.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ›¡ï¸ Advanced Security Analysis
        shell: bash
        run: |
          echo "ðŸ›¡ï¸ Running advanced security analysis..."
          
          IMAGE_URL="${{ needs.build.outputs.image-url }}"
          
          # Multiple scanner approach for comprehensive coverage
          echo "Image: $IMAGE_URL"
          
          # Install additional security tools
          curl -sSfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          
          # Comprehensive Trivy scan
          trivy image \
            --format table \
            --severity HIGH,CRITICAL \
            "$IMAGE_URL"
          
          # Check for secrets in image
          trivy image \
            --scanners secret \
            --format table \
            "$IMAGE_URL"
          
          # Configuration scanning
          trivy image \
            --scanners config \
            --format table \
            "$IMAGE_URL"
          
          echo "âœ… Advanced security analysis completed"

  # Deployment job (if enabled)
  deploy:
    name: Deploy Image
    needs: [build, security-analysis]
    if: inputs.deploy-enabled && needs.build.result == 'success' && (needs.security-analysis.result == 'success' || needs.security-analysis.result == 'skipped')
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.deploy-environment }}
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸš€ Deploy Docker Image
        id: deploy
        shell: bash
        run: |
          echo "ðŸš€ Deploying Docker image..."
          
          IMAGE_URL="${{ needs.build.outputs.image-url }}"
          
          if [ -n "${{ inputs.deploy-command }}" ]; then
            # Custom deployment command
            DEPLOY_CMD="${{ inputs.deploy-command }}"
            DEPLOY_CMD="${DEPLOY_CMD//\$IMAGE_URL/$IMAGE_URL}"
            eval "$DEPLOY_CMD"
          else
            # Default deployment examples (customize as needed)
            echo "Deploying image: $IMAGE_URL"
            echo "Environment: ${{ inputs.deploy-environment }}"
            
            # Example deployment commands (uncomment and customize as needed):
            # kubectl set image deployment/myapp container=$IMAGE_URL
            # docker service update --image $IMAGE_URL myservice
            # helm upgrade myapp ./chart --set image.tag=${IMAGE_URL##*:}
            
            echo "âœ… Deployment completed"
          fi
          
          # Set deployment URL (customize as needed)
          case "${{ inputs.deploy-environment }}" in
            "staging")
              echo "url=https://staging.example.com" >> $GITHUB_OUTPUT
              ;;
            "production")
              echo "url=https://example.com" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "url=https://${{ inputs.deploy-environment }}.example.com" >> $GITHUB_OUTPUT
              ;;
          esac

  # Summary job
  summary:
    name: Build Summary
    needs: [build, dockerhub-readme, security-analysis, deploy]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“Š Generate Build Summary
        shell: bash
        run: |
          echo "## ðŸ³ Docker Build & Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Build Status
          echo "### ðŸ—ï¸ Build Status" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Duration | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Build** | ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} | ${{ needs.build.outputs.build-duration }}s | Image: \`${{ needs.build.outputs.image-url }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **README Sync** | ${{ needs.dockerhub-readme.result == 'success' && 'âœ… Synced' || needs.dockerhub-readme.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | - | Docker Hub README |" >> $GITHUB_STEP_SUMMARY
          echo "| **Security** | ${{ needs.security-analysis.result == 'success' && 'âœ… Passed' || needs.security-analysis.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | ${{ needs.security-analysis.outputs.scan-duration || '0' }}s | ${{ inputs.security-scanner }} scan |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deploy** | ${{ needs.deploy.result == 'success' && 'âœ… Deployed' || needs.deploy.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | ${{ needs.deploy.outputs.deploy-duration || '0' }}s | Environment: ${{ inputs.deploy-environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Image Information
          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "### ðŸ“¦ Image Information" >> $GITHUB_STEP_SUMMARY
            echo "- **Registry:** \`${{ inputs.registry }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Image:** \`${{ needs.build.outputs.image-url }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Digest:** \`${{ needs.build.outputs.image-digest }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Size:** ${{ needs.build.outputs.image-size }} bytes" >> $GITHUB_STEP_SUMMARY
            echo "- **Platforms:** \`${{ inputs.multi-platform && inputs.platforms || 'linux/amd64' }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ðŸ·ï¸ Tags" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ needs.build.outputs.image-tags }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Security Information
          if [ "${{ inputs.security-scan }}" = "true" ]; then
            echo "### ðŸ›¡ï¸ Security" >> $GITHUB_STEP_SUMMARY
            echo "- **Scanner:** ${{ inputs.security-scanner }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Fail Level:** ${{ inputs.security-fail-on }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Image Signed:** ${{ inputs.sign-image && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **SBOM Generated:** ${{ inputs.generate-sbom && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Configuration Summary
          echo "### âš™ï¸ Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Dockerfile:** \`${{ inputs.dockerfile-path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Context:** \`${{ inputs.docker-context }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Builder:** ${{ inputs.builder-driver }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cache:** ${{ inputs.cache-enabled && 'âœ… Enabled' || 'âŒ Disabled' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Multi-Platform:** ${{ inputs.multi-platform && 'âœ… Enabled' || 'âŒ Disabled' }}" >> $GITHUB_STEP_SUMMARY