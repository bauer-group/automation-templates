name: ðŸ”” Teams Notifications

on:
  # Workflow call (for cross-repo usage)
  workflow_call:
    inputs:
      notification-level:
        description: 'Notification level (all or errors-only)'
        required: false
        type: string
        default: 'errors-only'
    secrets:
      TEAMS_WEBHOOK_URL:
        description: 'Teams webhook URL'
        required: false
        
  # Workflow events
  workflow_run:
    workflows: ["*"]
    types: [completed]
  
  # Issue events
  issues:
    types: [opened, closed, reopened, assigned, labeled]
  
  # Pull request events
  pull_request:
    types: [opened, closed, synchronize, reopened, ready_for_review, converted_to_draft]
  
  # Push events
  push:
    branches: [main, develop, master]
  
  # Release events
  release:
    types: [published, created, edited]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      notification-level:
        description: 'Notification level'
        required: false
        type: choice
        options:
          - all
          - errors-only
        default: errors-only
      event-type:
        description: 'Test event type'
        required: true
        type: choice
        options:
          - workflow_success
          - workflow_failure
          - issue_opened
          - issue_closed
          - pr_opened
          - pr_closed
          - pr_merged
          - push
          - release
        default: workflow_success
      test-message:
        description: 'Test message'
        required: false
        default: 'This is a test notification'

permissions:
  contents: read
  issues: read
  pull-requests: read
  actions: read

env:
  # Notification level: 'all' sends all notifications, 'errors-only' sends only failures
  NOTIFICATION_LEVEL: ${{ inputs.notification-level || github.event.inputs.notification-level || vars.TEAMS_NOTIFICATION_LEVEL || 'errors-only' }}
  # Teams webhook URL from secret
  TEAMS_WEBHOOK: ${{ secrets.TEAMS_WEBHOOK_URL }}

jobs:
  # Handle workflow completion notifications
  workflow-notifications:
    if: github.event_name == 'workflow_run'
    runs-on: ubuntu-latest
    name: ðŸ”„ Workflow Notifications
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v5

      - name: ðŸ“Š Get Workflow Logs
        id: get-logs
        continue-on-error: true
        run: |
          # Get the last few lines of the workflow logs
          echo "logs<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Run #${{ github.event.workflow_run.run_number }}" >> $GITHUB_OUTPUT
          echo "â±ï¸ Duration: ${{ github.event.workflow_run.created_at }} - ${{ github.event.workflow_run.updated_at }}" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Conclusion: ${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ðŸ”” Send Workflow Success Notification
        if: github.event.workflow_run.conclusion == 'success' && env.NOTIFICATION_LEVEL == 'all'
        uses: bauer-group/automation-templates/.github/actions/teams-notification@main
        with:
          webhook-url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          event-type: 'workflow_success'
          title: 'âœ… Workflow Completed Successfully'
          summary: 'Workflow **${{ github.event.workflow_run.name }}** completed successfully'
          details: 'All checks passed and the workflow executed without errors.'
          repository-name: ${{ github.repository }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}
          actor: ${{ github.event.workflow_run.actor.login }}
          actor-avatar: ${{ github.event.workflow_run.actor.avatar_url }}
          ref: ${{ github.event.workflow_run.head_branch }}
          sha: ${{ github.event.workflow_run.head_sha }}
          run-id: ${{ github.event.workflow_run.id }}
          run-url: ${{ github.event.workflow_run.html_url }}
          config-file: 'success'
          show-logs: 'true'
          logs-title: 'Workflow Summary'
          workflow-logs: ${{ steps.get-logs.outputs.logs }}

      - name: ðŸ“Š Get Failure Logs
        id: get-failure-logs
        if: github.event.workflow_run.conclusion == 'failure'
        continue-on-error: true
        run: |
          # Get failure information
          echo "logs<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Run #${{ github.event.workflow_run.run_number }}" >> $GITHUB_OUTPUT
          echo "â±ï¸ Failed at: ${{ github.event.workflow_run.updated_at }}" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Conclusion: ${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT
          echo "ðŸ”— View full logs: ${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ðŸ”” Send Workflow Failure Notification
        if: github.event.workflow_run.conclusion == 'failure'
        uses: bauer-group/automation-templates/.github/actions/teams-notification@main
        with:
          webhook-url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          event-type: 'workflow_failure'
          title: 'âŒ Workflow Failed'
          summary: 'Workflow **${{ github.event.workflow_run.name }}** failed'
          details: 'The workflow encountered errors and did not complete successfully. Please check the logs for details.'
          repository-name: ${{ github.repository }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}
          actor: ${{ github.event.workflow_run.actor.login }}
          actor-avatar: ${{ github.event.workflow_run.actor.avatar_url }}
          ref: ${{ github.event.workflow_run.head_branch }}
          sha: ${{ github.event.workflow_run.head_sha }}
          run-id: ${{ github.event.workflow_run.id }}
          run-url: ${{ github.event.workflow_run.html_url }}
          config-file: 'failure'
          mention-users: ${{ vars.TEAMS_MENTION_ON_FAILURE }}
          show-logs: 'true'
          logs-title: 'Failure Information'
          workflow-logs: ${{ steps.get-failure-logs.outputs.logs }}

  # Handle issue notifications
  issue-notifications:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    name: ðŸ› Issue Notifications
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v5

      - name: ðŸ”” Send Issue Opened Notification
        if: github.event.action == 'opened' && env.NOTIFICATION_LEVEL == 'all'
        uses: bauer-group/automation-templates/.github/actions/teams-notification@main
        with:
          webhook-url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          event-type: 'issue_opened'
          title: 'ðŸ› New Issue Opened'
          summary: '**#${{ github.event.issue.number }}**: ${{ github.event.issue.title }}'
          details: ${{ github.event.issue.body }}
          repository-name: ${{ github.repository }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}
          actor: ${{ github.event.issue.user.login }}
          actor-avatar: ${{ github.event.issue.user.avatar_url }}
          issue-number: ${{ github.event.issue.number }}
          issue-url: ${{ github.event.issue.html_url }}
          config-file: 'issue'
          custom-facts: >-
            [
              {"title": "Labels", "value": "${{ join(github.event.issue.labels.*.name, ', ') }}"},
              {"title": "Assignees", "value": "${{ join(github.event.issue.assignees.*.login, ', ') }}"}
            ]

      - name: ðŸ”” Send Issue Closed Notification
        if: github.event.action == 'closed' && env.NOTIFICATION_LEVEL == 'all'
        uses: bauer-group/automation-templates/.github/actions/teams-notification@main
        with:
          webhook-url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          event-type: 'issue_closed'
          title: 'âœ… Issue Closed'
          summary: '**#${{ github.event.issue.number }}**: ${{ github.event.issue.title }}'
          details: 'Issue was closed by ${{ github.event.issue.closed_by.login }}'
          repository-name: ${{ github.repository }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}
          actor: ${{ github.actor }}
          issue-number: ${{ github.event.issue.number }}
          issue-url: ${{ github.event.issue.html_url }}
          config-file: 'issue'

  # Handle pull request notifications
  pr-notifications:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    name: ðŸ”€ Pull Request Notifications
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v5

      - name: ðŸ”” Send PR Opened Notification
        if: github.event.action == 'opened' && env.NOTIFICATION_LEVEL == 'all'
        uses: bauer-group/automation-templates/.github/actions/teams-notification@main
        with:
          webhook-url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          event-type: 'pr_opened'
          title: 'ðŸ”€ New Pull Request Opened'
          summary: '**#${{ github.event.pull_request.number }}**: ${{ github.event.pull_request.title }}'
          details: ${{ github.event.pull_request.body }}
          repository-name: ${{ github.repository }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}
          actor: ${{ github.event.pull_request.user.login }}
          actor-avatar: ${{ github.event.pull_request.user.avatar_url }}
          ref: ${{ github.event.pull_request.head.ref }}
          sha: ${{ github.event.pull_request.head.sha }}
          pr-number: ${{ github.event.pull_request.number }}
          pr-url: ${{ github.event.pull_request.html_url }}
          config-file: 'pull-request'
          custom-facts: >-
            [
              {"title": "Base Branch", "value": "${{ github.event.pull_request.base.ref }}"},
              {"title": "Head Branch", "value": "${{ github.event.pull_request.head.ref }}"},
              {"title": "Changes", "value": "+${{ github.event.pull_request.additions }} -${{ github.event.pull_request.deletions }}"}
            ]

      - name: ðŸ”” Send PR Closed Notification
        if: github.event.action == 'closed' && github.event.pull_request.merged == false && env.NOTIFICATION_LEVEL == 'all'
        uses: bauer-group/automation-templates/.github/actions/teams-notification@main
        with:
          webhook-url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          event-type: 'pr_closed'
          title: 'ðŸ”’ Pull Request Closed'
          summary: '**#${{ github.event.pull_request.number }}**: ${{ github.event.pull_request.title }}'
          details: 'Pull request was closed without merging'
          repository-name: ${{ github.repository }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}
          actor: ${{ github.actor }}
          pr-number: ${{ github.event.pull_request.number }}
          pr-url: ${{ github.event.pull_request.html_url }}
          config-file: 'pull-request'

      - name: ðŸ”” Send PR Merged Notification
        if: github.event.action == 'closed' && github.event.pull_request.merged == true && env.NOTIFICATION_LEVEL == 'all'
        uses: bauer-group/automation-templates/.github/actions/teams-notification@main
        with:
          webhook-url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          event-type: 'pr_merged'
          title: 'ðŸŽ‰ Pull Request Merged'
          summary: '**#${{ github.event.pull_request.number }}**: ${{ github.event.pull_request.title }}'
          details: 'Pull request was successfully merged into ${{ github.event.pull_request.base.ref }}'
          repository-name: ${{ github.repository }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}
          actor: ${{ github.event.pull_request.merged_by.login }}
          actor-avatar: ${{ github.event.pull_request.merged_by.avatar_url }}
          pr-number: ${{ github.event.pull_request.number }}
          pr-url: ${{ github.event.pull_request.html_url }}
          config-file: 'pull-request'
          custom-facts: >-
            [
              {"title": "Merged into", "value": "${{ github.event.pull_request.base.ref }}"},
              {"title": "Commits", "value": "${{ github.event.pull_request.commits }}"},
              {"title": "Files Changed", "value": "${{ github.event.pull_request.changed_files }}"}
            ]

      - name: ðŸ”” Send PR Ready for Review Notification
        if: github.event.action == 'ready_for_review' && env.NOTIFICATION_LEVEL == 'all'
        uses: bauer-group/automation-templates/.github/actions/teams-notification@main
        with:
          webhook-url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          event-type: 'pr_opened'
          title: 'ðŸ‘€ Pull Request Ready for Review'
          summary: '**#${{ github.event.pull_request.number }}**: ${{ github.event.pull_request.title }}'
          details: 'Pull request is now ready for review'
          repository-name: ${{ github.repository }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}
          actor: ${{ github.event.pull_request.user.login }}
          pr-number: ${{ github.event.pull_request.number }}
          pr-url: ${{ github.event.pull_request.html_url }}
          config-file: 'pull-request'
          mention-users: ${{ vars.TEAMS_MENTION_ON_PR_REVIEW }}

  # Handle push notifications
  push-notifications:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    name: ðŸš€ Push Notifications
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v5

      - name: ðŸ”” Send Push Notification
        if: env.NOTIFICATION_LEVEL == 'all'
        uses: bauer-group/automation-templates/.github/actions/teams-notification@main
        with:
          webhook-url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          event-type: 'push'
          title: 'ðŸš€ New Commits Pushed'
          summary: 'New commits pushed to **${{ github.ref_name }}**'
          details: 'ðŸ“ ${{ github.event.head_commit.message }}'
          repository-name: ${{ github.repository }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}
          actor: ${{ github.event.head_commit.author.username }}
          ref: ${{ github.ref }}
          sha: ${{ github.sha }}
          config-file: 'push'
          custom-facts: >-
            [
              {"title": "Branch", "value": "${{ github.ref_name }}"},
              {"title": "Commit SHA", "value": "${{ github.sha }}"}
            ]

  # Handle release notifications
  release-notifications:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    name: ðŸ·ï¸ Release Notifications
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v5

      - name: ðŸ”” Send Release Notification
        if: github.event.action == 'published' && env.NOTIFICATION_LEVEL == 'all'
        uses: bauer-group/automation-templates/.github/actions/teams-notification@main
        with:
          webhook-url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          event-type: 'release'
          title: 'ðŸ·ï¸ New Release Published'
          summary: '**${{ github.event.release.tag_name }}**: ${{ github.event.release.name }}'
          details: ${{ github.event.release.body }}
          repository-name: ${{ github.repository }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}
          actor: ${{ github.event.release.author.login }}
          actor-avatar: ${{ github.event.release.author.avatar_url }}
          config-file: 'release'
          custom-facts: >-
            [
              {"title": "Tag", "value": "${{ github.event.release.tag_name }}"},
              {"title": "Prerelease", "value": "${{ github.event.release.prerelease }}"},
              {"title": "Draft", "value": "${{ github.event.release.draft }}"}
            ]

  # Handle manual test notifications
  test-notifications:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    name: ðŸ§ª Test Notifications
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v5

      - name: ðŸ”” Send Test Notification
        uses: bauer-group/automation-templates/.github/actions/teams-notification@main
        with:
          webhook-url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          event-type: ${{ github.event.inputs.event-type }}
          title: 'ðŸ§ª Test Notification'
          summary: ${{ github.event.inputs.test-message }}
          details: 'This is a test notification triggered manually'
          repository-name: ${{ github.repository }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}
          actor: ${{ github.actor }}
          config-file: 'test'