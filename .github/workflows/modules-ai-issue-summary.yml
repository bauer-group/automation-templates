name: üì¶ Module | AI Issue Summary

on:
  workflow_call:
    inputs:
      summary-type:
        description: 'Type of summary to generate (brief, detailed, technical, user-friendly)'
        required: false
        type: string
        default: 'brief'
      add-labels:
        description: 'Whether to add labels based on AI analysis'
        required: false
        type: boolean
        default: true
      add-priority:
        description: 'Whether to add priority labels based on AI analysis'
        required: false
        type: boolean
        default: true
      translate:
        description: 'Translate to language (leave empty for no translation)'
        required: false
        type: string
        default: ''
      custom-prompt:
        description: 'Custom prompt template (overrides default)'
        required: false
        type: string
        default: ''
      model:
        description: 'AI model to use'
        required: false
        type: string
        default: 'gpt-4o'
      comment-template:
        description: 'Template for the comment (use {summary} placeholder)'
        required: false
        type: string
        default: |
          ## ü§ñ AI Summary
          
          {summary}
          
          ---
          *This summary was automatically generated by AI and may not be 100% accurate.*
    secrets:
      token:
        description: 'GitHub Token with issues write permission'
        required: false
      ai-api-key:
        description: 'API key for AI service (if using external service)'
        required: false

permissions:
  issues: write
  pull-requests: write
  models: read
  contents: read

jobs:
  summarize:
    name: üß† Generate AI Summary
    runs-on: ubuntu-latest
    
    steps:
      - name: üöÄ Checkout Repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.token || secrets.GITHUB_TOKEN }}
      
      - name: üìã Get Issue/PR Details
        id: details
        env:
          GITHUB_TOKEN: ${{ secrets.token || secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "üîç Extracting issue/PR details..."

          # Determine if this is an issue or PR
          if [ -n "${{ github.event.issue }}" ]; then
            echo "type=issue" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT

            # Use environment variables to safely handle special characters
            {
              echo 'title<<EOF'
              printf '%s\n' "$ISSUE_TITLE"
              echo 'EOF'
            } >> $GITHUB_OUTPUT

            # Use heredoc for body to handle special characters
            {
              echo 'body<<EOF'
              printf '%s\n' "$ISSUE_BODY"
              echo 'EOF'
            } >> $GITHUB_OUTPUT

            echo "author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT

            # Use heredoc for labels JSON
            {
              echo 'labels<<EOF'
              echo '${{ toJson(github.event.issue.labels.*.name) }}'
              echo 'EOF'
            } >> $GITHUB_OUTPUT

          elif [ -n "${{ github.event.pull_request }}" ]; then
            echo "type=pull_request" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

            # Use environment variables to safely handle special characters
            {
              echo 'title<<EOF'
              printf '%s\n' "$PR_TITLE"
              echo 'EOF'
            } >> $GITHUB_OUTPUT

            # Use heredoc for body to handle special characters
            {
              echo 'body<<EOF'
              printf '%s\n' "$PR_BODY"
              echo 'EOF'
            } >> $GITHUB_OUTPUT

            echo "author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT

            # Use heredoc for labels JSON
            {
              echo 'labels<<EOF'
              echo '${{ toJson(github.event.pull_request.labels.*.name) }}'
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi
      
      - name: üéØ Prepare Prompt
        id: prompt
        run: |
          echo "üìù Preparing AI prompt..."

          # Store body content safely in a variable
          ISSUE_BODY=$(cat <<'EOF_BODY'
          ${{ steps.details.outputs.body }}
          EOF_BODY
          )

          ISSUE_TITLE=$(cat <<'EOF_TITLE'
          ${{ steps.details.outputs.title }}
          EOF_TITLE
          )

          # Check if custom prompt is provided
          if [ -n "${{ inputs.custom-prompt }}" ]; then
            cat > /tmp/prompt.txt <<EOF_PROMPT
          ${{ inputs.custom-prompt }}
          EOF_PROMPT
          else
            # Build prompt based on summary type
            case "${{ inputs.summary-type }}" in
              "detailed")
                cat > /tmp/prompt.txt <<EOF_PROMPT
          Provide a detailed analysis of the following GitHub ${{ steps.details.outputs.type }}:

          Title: ${ISSUE_TITLE}
          Author: ${{ steps.details.outputs.author }}
          Body: ${ISSUE_BODY}

          Please include:
          1. A comprehensive summary of the issue/request
          2. Key points and requirements
          3. Potential impact and scope
          4. Suggested next steps
          5. Any missing information needed
          EOF_PROMPT
                ;;

              "technical")
                cat > /tmp/prompt.txt <<EOF_PROMPT
          Provide a technical summary of the following GitHub ${{ steps.details.outputs.type }}:

          Title: ${ISSUE_TITLE}
          Body: ${ISSUE_BODY}

          Focus on:
          - Technical requirements and constraints
          - Implementation considerations
          - Potential challenges
          - Architecture/design implications
          - Performance considerations
          EOF_PROMPT
                ;;

              "user-friendly")
                cat > /tmp/prompt.txt <<EOF_PROMPT
          Provide a simple, non-technical summary of the following GitHub ${{ steps.details.outputs.type }}:

          Title: ${ISSUE_TITLE}
          Body: ${ISSUE_BODY}

          Explain in plain language:
          - What the user is asking for
          - Why it might be important
          - What the expected outcome is
          Use simple terms and avoid technical jargon.
          EOF_PROMPT
                ;;

              *)  # brief (default)
                cat > /tmp/prompt.txt <<EOF_PROMPT
          Summarize the following GitHub ${{ steps.details.outputs.type }} in 2-3 concise sentences:

          Title: ${ISSUE_TITLE}
          Body: ${ISSUE_BODY}

          Be clear and to the point.
          EOF_PROMPT
                ;;
            esac
          fi

          # Add translation request if needed
          if [ -n "${{ inputs.translate }}" ]; then
            cat >> /tmp/prompt.txt <<EOF_TRANSLATE

          Please provide the summary in ${{ inputs.translate }} language.
          EOF_TRANSLATE
          fi

          # Add labeling request if needed
          if [ "${{ inputs.add-labels }}" = "true" ]; then
            cat >> /tmp/prompt.txt <<'EOF_LABELS'

          Additionally, suggest appropriate labels from this list: bug, enhancement, documentation, question, help-wanted, good-first-issue, breaking-change, performance, security, test
          EOF_LABELS
          fi

          # Add priority request if needed
          if [ "${{ inputs.add-priority }}" = "true" ]; then
            cat >> /tmp/prompt.txt <<'EOF_PRIORITY'

          Also, suggest a priority level: low, medium, high, critical
          EOF_PRIORITY
          fi

          # Set output
          echo "prompt-file=/tmp/prompt.txt" >> $GITHUB_OUTPUT
      
      - name: üß† Run AI Inference (GitHub Models)
        id: inference-github
        if: ${{ !inputs.custom-prompt || !contains(inputs.model, 'gpt') }}
        continue-on-error: true
        uses: actions/ai-inference@v1
        with:
          prompt-file: ${{ steps.prompt.outputs.prompt-file }}
          model: ${{ inputs.model }}
      
      - name: üß† Run AI Inference (OpenAI)
        id: inference-openai
        if: ${{ contains(inputs.model, 'gpt') }}
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.ai-api-key }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "‚ö†Ô∏è OpenAI API key not configured, skipping..."
            exit 1
          fi

          echo "ü§ñ Using OpenAI API..."

          # Read prompt and escape it properly for JSON
          PROMPT=$(cat ${{ steps.prompt.outputs.prompt-file }} | jq -Rs .)

          # Make API call to OpenAI with properly escaped content
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"${{ inputs.model }}\",
              \"messages\": [{\"role\": \"user\", \"content\": $PROMPT}],
              \"temperature\": 0.7,
              \"max_tokens\": 500
            }" | jq -r '.choices[0].message.content')

          if [ "$RESPONSE" = "null" ] || [ -z "$RESPONSE" ]; then
            echo "‚ö†Ô∏è Failed to get response from OpenAI"
            exit 1
          fi

          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
      
      - name: üß† Fallback Summary (No AI)
        id: fallback
        if: ${{ steps.inference-github.outcome != 'success' && steps.inference-openai.outcome != 'success' }}
        env:
          ITEM_TITLE: ${{ steps.details.outputs.title }}
        run: |
          echo "‚ö†Ô∏è AI inference failed, generating basic summary..."

          # Generate a basic summary without AI using heredoc
          {
            echo 'response<<EOF'
            echo "**Type:** ${{ steps.details.outputs.type }}"
            printf '**Title:** %s\n' "$ITEM_TITLE"
            echo "**Author:** @${{ steps.details.outputs.author }}"
            echo ""
            echo "This ${{ steps.details.outputs.type }} requires review. Please check the full description for details."
            echo 'EOF'
          } >> $GITHUB_OUTPUT
      
      - name: üìù Process AI Response
        id: process
        env:
          RESPONSE_GITHUB: ${{ steps.inference-github.outputs.response }}
          RESPONSE_OPENAI: ${{ steps.inference-openai.outputs.response }}
          RESPONSE_FALLBACK: ${{ steps.fallback.outputs.response }}
          GITHUB_OUTCOME: ${{ steps.inference-github.outcome }}
          OPENAI_OUTCOME: ${{ steps.inference-openai.outcome }}
          ADD_LABELS: ${{ inputs.add-labels }}
          ADD_PRIORITY: ${{ inputs.add-priority }}
        run: |
          echo "üîÑ Processing AI response..."

          # Get the response from whichever inference succeeded (using env vars to avoid backtick issues)
          if [ "$GITHUB_OUTCOME" = "success" ]; then
            RESPONSE="$RESPONSE_GITHUB"
          elif [ "$OPENAI_OUTCOME" = "success" ]; then
            RESPONSE="$RESPONSE_OPENAI"
          else
            RESPONSE="$RESPONSE_FALLBACK"
          fi

          # Save response to temp file to safely process content with special characters
          printf '%s' "$RESPONSE" > /tmp/ai_response.txt

          # Extract labels if suggested
          if [ "$ADD_LABELS" = "true" ]; then
            # Try to extract labels from the response
            SUGGESTED_LABELS=$(grep -oE "(bug|enhancement|documentation|question|help-wanted|good-first-issue|breaking-change|performance|security|test)" /tmp/ai_response.txt | tr '\n' ' ' | xargs || true)
            echo "suggested-labels=$SUGGESTED_LABELS" >> $GITHUB_OUTPUT
          fi

          # Extract priority if suggested
          if [ "$ADD_PRIORITY" = "true" ]; then
            # Try to extract priority from the response
            SUGGESTED_PRIORITY=$(grep -oE "(priority:?\s*(low|medium|high|critical))" /tmp/ai_response.txt | grep -oE "(low|medium|high|critical)" | head -1 || true)
            echo "suggested-priority=$SUGGESTED_PRIORITY" >> $GITHUB_OUTPUT
          fi

          # Clean up the summary (remove label/priority suggestions if they were requested separately)
          cp /tmp/ai_response.txt /tmp/clean_summary.txt
          if [ "$ADD_LABELS" = "true" ] || [ "$ADD_PRIORITY" = "true" ]; then
            # Remove lines that look like label or priority suggestions
            sed -i '/^Labels:/d; /^Priority:/d; /^\*\*Suggested labels:\*\*/d; /^\*\*Priority level:\*\*/d; /^Suggested labels:/d; /^Suggested priority:/d' /tmp/clean_summary.txt
          fi

          # Save clean summary using heredoc with file
          {
            echo 'summary<<EOF'
            cat /tmp/clean_summary.txt
            echo 'EOF'
          } >> $GITHUB_OUTPUT
      
      - name: üí¨ Post Summary Comment
        env:
          GITHUB_TOKEN: ${{ secrets.token || secrets.GITHUB_TOKEN }}
        run: |
          echo "üí¨ Posting summary comment..."

          # Safely capture template and summary using heredoc
          COMMENT_TEMPLATE=$(cat <<'EOF_TEMPLATE'
          ${{ inputs.comment-template }}
          EOF_TEMPLATE
          )

          SUMMARY=$(cat <<'EOF_SUMMARY'
          ${{ steps.process.outputs.summary }}
          EOF_SUMMARY
          )

          # Replace {summary} placeholder using temporary files to avoid bash expansion issues
          echo "$COMMENT_TEMPLATE" > /tmp/template.txt
          echo "$SUMMARY" > /tmp/summary.txt

          # Use sed for safer replacement
          sed 's/{summary}/SUMMARY_PLACEHOLDER/g' /tmp/template.txt > /tmp/comment.txt
          SUMMARY_ESCAPED=$(cat /tmp/summary.txt | sed 's/[&/\]/\\&/g')
          sed "s|SUMMARY_PLACEHOLDER|$SUMMARY_ESCAPED|g" /tmp/comment.txt > /tmp/final_comment.txt

          # Add label suggestions if any
          if [ -n "${{ steps.process.outputs.suggested-labels }}" ]; then
            echo "" >> /tmp/final_comment.txt
            echo "**Suggested Labels:** ${{ steps.process.outputs.suggested-labels }}" >> /tmp/final_comment.txt
          fi

          # Add priority suggestion if any
          if [ -n "${{ steps.process.outputs.suggested-priority }}" ]; then
            echo "**Suggested Priority:** ${{ steps.process.outputs.suggested-priority }}" >> /tmp/final_comment.txt
          fi

          # Post the comment using file input for safety
          gh issue comment ${{ steps.details.outputs.number }} --body-file /tmp/final_comment.txt
      
      - name: üè∑Ô∏è Apply Suggested Labels
        if: ${{ inputs.add-labels == true && steps.process.outputs.suggested-labels != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.token || secrets.GITHUB_TOKEN }}
        run: |
          echo "üè∑Ô∏è Applying suggested labels..."
          
          LABELS="${{ steps.process.outputs.suggested-labels }}"
          
          for LABEL in $LABELS; do
            echo "Adding label: $LABEL"
            gh issue edit ${{ steps.details.outputs.number }} --add-label "$LABEL" || echo "Failed to add label: $LABEL"
          done
      
      - name: üéØ Apply Priority Label
        if: ${{ inputs.add-priority == true && steps.process.outputs.suggested-priority != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.token || secrets.GITHUB_TOKEN }}
        run: |
          echo "üéØ Applying priority label..."
          
          PRIORITY="${{ steps.process.outputs.suggested-priority }}"
          
          if [ -n "$PRIORITY" ]; then
            gh issue edit ${{ steps.details.outputs.number }} --add-label "priority-$PRIORITY"
            echo "Added priority label: priority-$PRIORITY"
          fi
      
      - name: üìä Summary Report
        if: always()
        env:
          ITEM_TITLE: ${{ steps.details.outputs.title }}
        run: |
          echo "### ü§ñ AI Issue Summary Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Type** | ${{ steps.details.outputs.type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Number** | #${{ steps.details.outputs.number }} |" >> $GITHUB_STEP_SUMMARY
          printf '| **Title** | %s |\n' "$ITEM_TITLE" >> $GITHUB_STEP_SUMMARY
          echo "| **Author** | @${{ steps.details.outputs.author }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Summary Type** | ${{ inputs.summary-type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Model** | ${{ inputs.model }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **AI Service** | ${{ steps.inference-github.outcome == 'success' && 'GitHub Models' || steps.inference-openai.outcome == 'success' && 'OpenAI' || 'Fallback (No AI)' }} |" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ steps.process.outputs.suggested-labels }}" ]; then
            echo "| **Suggested Labels** | ${{ steps.process.outputs.suggested-labels }} |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "${{ steps.process.outputs.suggested-priority }}" ]; then
            echo "| **Suggested Priority** | ${{ steps.process.outputs.suggested-priority }} |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Summary posted successfully**" >> $GITHUB_STEP_SUMMARY