name: 'Docker Build & Push'
description: 'Comprehensive Docker image building, security scanning, and multi-registry publishing'
author: 'BAUER GROUP'

inputs:
  working-directory:
    description: 'Working directory for all commands'
    required: false
    default: '.'
  # Build Configuration
  dockerfile-path:
    description: 'Path to Dockerfile'
    required: false
    default: './Dockerfile'
  docker-context:
    description: 'Docker build context'
    required: false
    default: '.'
  build-args:
    description: 'Build arguments as JSON object or multiline string'
    required: false
    default: '{}'
  build-secrets:
    description: 'Build secrets as JSON object'
    required: false
    default: '{}'
  target:
    description: 'Docker build target stage'
    required: false
    default: ''
  # Platform Configuration
  platforms:
    description: 'Target platforms (comma-separated)'
    required: false
    default: 'linux/amd64'
  multi-platform:
    description: 'Enable multi-platform builds'
    required: false
    default: 'false'
  # Registry Configuration
  registry:
    description: 'Docker registry URL'
    required: false
    default: 'ghcr.io'
  registry-username:
    description: 'Registry username'
    required: false
    default: ''
  registry-password:
    description: 'Registry password/token'
    required: false
    default: ''
  # Secondary Registry (for multi-registry push)
  secondary-registry:
    description: 'Secondary Docker registry URL (e.g., docker.io for Docker Hub)'
    required: false
    default: ''
  secondary-registry-username:
    description: 'Secondary registry username'
    required: false
    default: ''
  secondary-registry-password:
    description: 'Secondary registry password/token'
    required: false
    default: ''
  secondary-image-name:
    description: 'Image name for secondary registry (without registry prefix)'
    required: false
    default: ''
  # Image Configuration
  image-name:
    description: 'Docker image name (without registry)'
    required: false
    default: ''
  image-tags:
    description: 'Image tags (comma-separated or JSON array)'
    required: false
    default: ''
  auto-tags:
    description: 'Generate automatic tags based on Git refs'
    required: false
    default: 'true'
  latest-tag:
    description: 'Tag image as latest on main branch'
    required: false
    default: 'true'
  version-from-dockerfile:
    description: 'Extract version from Dockerfile LABEL org.opencontainers.image.version and use as image tag'
    required: false
    default: 'false'
  update-dockerfile-version:
    description: 'Update Dockerfile LABEL org.opencontainers.image.version with version from Git tag (strips v prefix)'
    required: false
    default: 'false'
  # Push Configuration
  push:
    description: 'Push image to registry'
    required: false
    default: 'true'
  push-on-pr:
    description: 'Push images on pull requests'
    required: false
    default: 'false'
  # Caching
  cache-enabled:
    description: 'Enable build caching'
    required: false
    default: 'true'
  cache-mode:
    description: 'Cache mode (min, max, inline)'
    required: false
    default: 'max'
  cache-registry:
    description: 'Registry for cache'
    required: false
    default: ''
  # Security Configuration
  security-scan:
    description: 'Run security vulnerability scan'
    required: false
    default: 'true'
  security-scanner:
    description: 'Security scanner (trivy, snyk, grype)'
    required: false
    default: 'trivy'
  security-fail-on:
    description: 'Fail on security issues (CRITICAL, HIGH, MEDIUM, LOW)'
    required: false
    default: 'CRITICAL'
  security-ignore-unfixed:
    description: 'Ignore unfixed vulnerabilities'
    required: false
    default: 'false'
  # Image Signing
  sign-image:
    description: 'Sign image with cosign'
    required: false
    default: 'false'
  cosign-key:
    description: 'Cosign private key'
    required: false
    default: ''
  cosign-password:
    description: 'Cosign key password'
    required: false
    default: ''
  # SBOM Generation
  generate-sbom:
    description: 'Generate Software Bill of Materials'
    required: false
    default: 'false'
  sbom-format:
    description: 'SBOM format (cyclonedx, spdx)'
    required: false
    default: 'cyclonedx'
  # Metadata & Labels
  add-git-labels:
    description: 'Add Git metadata as labels'
    required: false
    default: 'true'
  custom-labels:
    description: 'Custom labels as JSON object'
    required: false
    default: '{}'
  # Performance
  builder-driver:
    description: 'Builder driver (docker, docker-container, kubernetes)'
    required: false
    default: 'docker-container'
  build-timeout:
    description: 'Build timeout in minutes'
    required: false
    default: '30'

outputs:
  image-digest:
    description: 'Image digest'
    value: ${{ steps.build.outputs.digest }}
  image-tags:
    description: 'Generated image tags'
    value: ${{ steps.meta.outputs.tags }}
  image-url:
    description: 'Full image URL with tag'
    value: ${{ steps.build-info.outputs.image-url }}
  image-size:
    description: 'Image size in bytes'
    value: ${{ steps.build-info.outputs.image-size }}
  security-report:
    description: 'Path to security scan report'
    value: ${{ steps.security.outputs.report-path }}
  sbom-path:
    description: 'Path to generated SBOM'
    value: ${{ steps.sbom.outputs.path }}
  build-duration:
    description: 'Build duration in seconds'
    value: ${{ steps.build-info.outputs.duration }}

runs:
  using: 'composite'
  steps:
    - name: üîß Setup Build Environment
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "üîß Setting up Docker build environment..."
        
        # Validate Dockerfile
        if [ ! -f "${{ inputs.dockerfile-path }}" ]; then
          echo "‚ùå Dockerfile not found: ${{ inputs.dockerfile-path }}"
          exit 1
        fi
        
        # Create build directory
        mkdir -p docker-build-reports
        
        # Record build start time
        echo "BUILD_START_TIME=$(date +%s)" >> $GITHUB_ENV
        
        echo "‚úÖ Docker build environment ready"

    - name: üèóÔ∏è Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: ${{ inputs.builder-driver }}
        platforms: ${{ inputs.platforms }}

    - name: üîÑ Update Dockerfile Version from Git Tag
      id: update-dockerfile-version
      if: inputs.update-dockerfile-version == 'true' && startsWith(github.ref, 'refs/tags/v')
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "üîÑ Updating Dockerfile version from Git tag..."

        DOCKERFILE="${{ inputs.dockerfile-path }}"
        GIT_TAG="${GITHUB_REF#refs/tags/}"
        VERSION="${GIT_TAG#v}"  # Strip 'v' prefix

        echo "üìå Git tag: $GIT_TAG"
        echo "üìå Version (without v): $VERSION"

        # Check if Dockerfile contains the version label
        if grep -q 'org\.opencontainers\.image\.version' "$DOCKERFILE"; then
          # Update existing version label
          sed -i -E "s/(org\.opencontainers\.image\.version\s*=\s*[\"']?)[0-9]+\.[0-9]+\.[0-9]+([-.][a-zA-Z0-9]+)*([\"']?)/\1$VERSION\3/" "$DOCKERFILE"
          echo "‚úÖ Updated org.opencontainers.image.version to $VERSION"
        else
          echo "‚ö†Ô∏è No org.opencontainers.image.version label found in Dockerfile"
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: üè∑Ô∏è Extract Version from Dockerfile
      id: dockerfile-version
      if: inputs.version-from-dockerfile == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "üè∑Ô∏è Extracting version from Dockerfile..."

        DOCKERFILE="${{ inputs.dockerfile-path }}"

        # Extract version from LABEL org.opencontainers.image.version
        VERSION=$(grep -oP 'LABEL\s+org\.opencontainers\.image\.version\s*=\s*["\x27]?\K[0-9]+\.[0-9]+\.[0-9]+(?:[-.][a-zA-Z0-9]+)*' "$DOCKERFILE" 2>/dev/null || \
                  grep -oP 'org\.opencontainers\.image\.version\s*=\s*["\x27]?\K[0-9]+\.[0-9]+\.[0-9]+(?:[-.][a-zA-Z0-9]+)*' "$DOCKERFILE" 2>/dev/null || \
                  echo "")

        if [ -z "$VERSION" ]; then
          echo "‚ö†Ô∏è No version found in Dockerfile LABEL, falling back to 'latest'"
          VERSION="latest"
        else
          echo "‚úÖ Found version in Dockerfile: $VERSION"
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version-tag=type=raw,value=$VERSION" >> $GITHUB_OUTPUT

    - name: üîê Log in to Primary Registry
      if: inputs.push == 'true' && (github.event_name != 'pull_request' || inputs.push-on-pr == 'true')
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.registry-username || github.actor }}
        password: ${{ inputs.registry-password }}

    - name: üîê Log in to Secondary Registry
      if: inputs.push == 'true' && inputs.secondary-registry != '' && (github.event_name != 'pull_request' || inputs.push-on-pr == 'true')
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.secondary-registry }}
        username: ${{ inputs.secondary-registry-username }}
        password: ${{ inputs.secondary-registry-password }}

    - name: üè∑Ô∏è Extract Metadata for Primary Registry (GHCR)
      id: meta-primary
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ inputs.registry }}/${{ inputs.image-name || github.repository }}
        tags: |
          ${{ inputs.auto-tags == 'true' && 'type=ref,event=branch' || '' }}
          ${{ inputs.auto-tags == 'true' && 'type=ref,event=pr' || '' }}
          ${{ inputs.auto-tags == 'true' && 'type=semver,pattern={{version}}' || '' }}
          ${{ inputs.auto-tags == 'true' && 'type=semver,pattern={{major}}.{{minor}}' || '' }}
          ${{ inputs.auto-tags == 'true' && 'type=semver,pattern={{major}},enable=${{ !startsWith(github.ref, 'refs/tags/v0.') }}' || '' }}
          ${{ inputs.auto-tags == 'true' && inputs.latest-tag == 'true' && startsWith(github.ref, 'refs/tags/') && 'type=raw,value=latest' || '' }}
          ${{ inputs.auto-tags == 'true' && !startsWith(github.ref, 'refs/tags/') && 'type=sha,prefix={{branch}}-' || '' }}
          ${{ inputs.version-from-dockerfile == 'true' && steps.dockerfile-version.outputs.version-tag || '' }}
          ${{ inputs.image-tags }}
        labels: |
          ${{ inputs.add-git-labels == 'true' && format('org.opencontainers.image.source={0}/{1}', github.server_url, github.repository) || '' }}
          ${{ inputs.add-git-labels == 'true' && format('org.opencontainers.image.revision={0}', github.sha) || '' }}
          ${{ inputs.add-git-labels == 'true' && 'org.opencontainers.image.created={{date "2006-01-02T15:04:05Z07:00"}}' || '' }}
          ${{ inputs.custom-labels }}

    - name: üè∑Ô∏è Extract Metadata for Secondary Registry (Docker Hub)
      id: meta-secondary
      if: inputs.secondary-registry != ''
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ inputs.secondary-registry }}/${{ inputs.secondary-image-name || inputs.image-name || github.repository }}
        # Docker Hub only gets semver tags and latest (no branch/sha tags)
        tags: |
          ${{ inputs.auto-tags == 'true' && startsWith(github.ref, 'refs/tags/') && 'type=semver,pattern={{version}}' || '' }}
          ${{ inputs.auto-tags == 'true' && startsWith(github.ref, 'refs/tags/') && 'type=semver,pattern={{major}}.{{minor}}' || '' }}
          ${{ inputs.auto-tags == 'true' && startsWith(github.ref, 'refs/tags/') && 'type=semver,pattern={{major}},enable=${{ !startsWith(github.ref, 'refs/tags/v0.') }}' || '' }}
          ${{ inputs.auto-tags == 'true' && inputs.latest-tag == 'true' && startsWith(github.ref, 'refs/tags/') && 'type=raw,value=latest' || '' }}
          ${{ inputs.version-from-dockerfile == 'true' && steps.dockerfile-version.outputs.version-tag || '' }}
        labels: |
          ${{ inputs.add-git-labels == 'true' && format('org.opencontainers.image.source={0}/{1}', github.server_url, github.repository) || '' }}
          ${{ inputs.add-git-labels == 'true' && format('org.opencontainers.image.revision={0}', github.sha) || '' }}
          ${{ inputs.add-git-labels == 'true' && 'org.opencontainers.image.created={{date "2006-01-02T15:04:05Z07:00"}}' || '' }}
          ${{ inputs.custom-labels }}

    - name: üè∑Ô∏è Combine Tags for Multi-Registry Push
      id: meta
      shell: bash
      run: |
        # Combine tags from both registries
        PRIMARY_TAGS="${{ steps.meta-primary.outputs.tags }}"
        SECONDARY_TAGS="${{ steps.meta-secondary.outputs.tags }}"

        if [ -n "$SECONDARY_TAGS" ]; then
          # Combine both sets of tags
          COMBINED_TAGS=$(printf "%s\n%s" "$PRIMARY_TAGS" "$SECONDARY_TAGS")
        else
          COMBINED_TAGS="$PRIMARY_TAGS"
        fi

        echo "tags<<EOF" >> $GITHUB_OUTPUT
        echo "$COMBINED_TAGS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        # Use primary labels
        echo "labels<<EOF" >> $GITHUB_OUTPUT
        echo "${{ steps.meta-primary.outputs.labels }}" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        echo "üìã Combined tags:"
        echo "$COMBINED_TAGS"

    - name: üê≥ Build and Push Docker Image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: ${{ inputs.docker-context }}
        file: ${{ inputs.dockerfile-path }}
        platforms: ${{ inputs.multi-platform == 'true' && inputs.platforms || 'linux/amd64' }}
        push: ${{ inputs.push == 'true' && (github.event_name != 'pull_request' || inputs.push-on-pr == 'true') }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: ${{ inputs.build-args }}
        secrets: ${{ inputs.build-secrets }}
        target: ${{ inputs.target }}
        cache-from: ${{ inputs.cache-enabled == 'true' && 'type=gha' || '' }}
        cache-to: ${{ inputs.cache-enabled == 'true' && format('type=gha,mode={0}', inputs.cache-mode) || '' }}
        provenance: false
        sbom: false

    - name: üìä Collect Build Information
      id: build-info
      shell: bash
      run: |
        BUILD_END_TIME=$(date +%s)
        BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
        
        # Get primary image tag
        PRIMARY_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -1)
        
        # Try to get image size (if image was pushed)
        IMAGE_SIZE="unknown"
        if [ "${{ inputs.push }}" = "true" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
          if command -v skopeo >/dev/null 2>&1; then
            IMAGE_SIZE=$(skopeo inspect docker://"$PRIMARY_TAG" 2>/dev/null | jq -r '.Size // "unknown"' || echo "unknown")
          fi
        fi
        
        echo "image-url=$PRIMARY_TAG" >> $GITHUB_OUTPUT
        echo "image-size=$IMAGE_SIZE" >> $GITHUB_OUTPUT
        echo "duration=$BUILD_DURATION" >> $GITHUB_OUTPUT
        
        echo "üìä Build Information:"
        echo "  ‚Ä¢ Duration: ${BUILD_DURATION}s"
        echo "  ‚Ä¢ Primary Tag: $PRIMARY_TAG"
        echo "  ‚Ä¢ Image Size: $IMAGE_SIZE bytes"

    - name: üõ°Ô∏è Security Vulnerability Scan
      id: security
      if: inputs.security-scan == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      continue-on-error: ${{ inputs.security-fail-on == 'LOW' && 'false' || 'true' }}
      run: |
        echo "üõ°Ô∏è Running security scan with ${{ inputs.security-scanner }}..."
        
        PRIMARY_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -1)
        REPORT_PATH="docker-build-reports/security-report.json"
        SARIF_PATH="docker-build-reports/security-report.sarif"
        
        case "${{ inputs.security-scanner }}" in
          trivy)
            # Install Trivy if not available
            if ! command -v trivy >/dev/null 2>&1; then
              echo "Installing Trivy..."
              curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
            fi
            
            # Run Trivy scan
            trivy image \
              --format json \
              --output "$REPORT_PATH" \
              --severity ${{ inputs.security-fail-on }},HIGH,CRITICAL \
              ${{ inputs.security-ignore-unfixed == 'true' && '--ignore-unfixed' || '' }} \
              "$PRIMARY_TAG" || echo "Trivy scan completed with issues"
            
            # Convert to SARIF if needed
            trivy image \
              --format sarif \
              --output "$SARIF_PATH" \
              --severity ${{ inputs.security-fail-on }},HIGH,CRITICAL \
              "$PRIMARY_TAG" || echo "SARIF generation completed"
            ;;
            
          grype)
            # Install Grype if not available
            if ! command -v grype >/dev/null 2>&1; then
              echo "Installing Grype..."
              curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
            fi
            
            grype "$PRIMARY_TAG" -o json --file "$REPORT_PATH" || echo "Grype scan completed"
            ;;
        esac
        
        echo "report-path=$REPORT_PATH" >> $GITHUB_OUTPUT
        echo "sarif-path=$SARIF_PATH" >> $GITHUB_OUTPUT
        
        # Check for critical vulnerabilities
        if [ -f "$REPORT_PATH" ]; then
          CRITICAL_COUNT=0
          if [ "${{ inputs.security-scanner }}" = "trivy" ]; then
            CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' "$REPORT_PATH" 2>/dev/null || echo "0")
          fi
          
          echo "üõ°Ô∏è Security scan completed:"
          echo "  ‚Ä¢ Critical vulnerabilities: $CRITICAL_COUNT"
          
          if [ "$CRITICAL_COUNT" -gt 0 ] && [ "${{ inputs.security-fail-on }}" = "CRITICAL" ]; then
            echo "‚ùå Critical vulnerabilities found - failing build"
            exit 1
          fi
        fi

    - name: üîê Sign Image with Cosign
      if: inputs.sign-image == 'true' && inputs.push == 'true' && github.event_name != 'pull_request'
      shell: bash
      env:
        COSIGN_PRIVATE_KEY: ${{ inputs.cosign-key }}
        COSIGN_PASSWORD: ${{ inputs.cosign-password }}
      run: |
        echo "üîê Signing image with Cosign..."
        
        # Install Cosign if not available
        if ! command -v cosign >/dev/null 2>&1; then
          echo "Installing Cosign..."
          go install github.com/sigstore/cosign/v2/cmd/cosign@latest
        fi
        
        # Sign all tags
        echo "${{ steps.meta.outputs.tags }}" | while read -r tag; do
          if [ -n "$tag" ]; then
            echo "Signing: $tag@${{ steps.build.outputs.digest }}"
            if [ -n "$COSIGN_PRIVATE_KEY" ]; then
              echo "$COSIGN_PRIVATE_KEY" | cosign sign --key env://COSIGN_PRIVATE_KEY --yes "$tag@${{ steps.build.outputs.digest }}"
            else
              cosign sign --yes "$tag@${{ steps.build.outputs.digest }}"
            fi
          fi
        done

    - name: üìã Generate SBOM
      id: sbom
      if: inputs.generate-sbom == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "üìã Generating Software Bill of Materials..."
        
        PRIMARY_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -1)
        SBOM_PATH="docker-build-reports/sbom.${{ inputs.sbom-format }}.json"
        
        # Install Syft for SBOM generation
        if ! command -v syft >/dev/null 2>&1; then
          echo "Installing Syft..."
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
        fi
        
        # Generate SBOM
        syft "$PRIMARY_TAG" -o "${{ inputs.sbom-format }}-json" --file "$SBOM_PATH"
        
        echo "path=$SBOM_PATH" >> $GITHUB_OUTPUT
        echo "üìã SBOM generated: $SBOM_PATH"

    - name: üì§ Upload Security Reports
      if: always() && inputs.security-scan == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: docker-security-reports
        path: ${{ inputs.working-directory }}/docker-build-reports/
        retention-days: 30

    - name: üìä Upload Security Scan to GitHub Security
      if: inputs.security-scan == 'true' && steps.security.outputs.sarif-path != ''
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: ${{ inputs.working-directory }}/${{ steps.security.outputs.sarif-path }}
        category: docker-security-scan

    - name: üìã Build Summary
      shell: bash
      run: |
        echo "## üê≥ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### üèóÔ∏è Build Details" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Dockerfile** | \`${{ inputs.dockerfile-path }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Context** | \`${{ inputs.docker-context }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Platforms** | \`${{ inputs.multi-platform == 'true' && inputs.platforms || 'linux/amd64' }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Registry** | \`${{ inputs.registry }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Duration** | ${{ steps.build-info.outputs.duration }}s |" >> $GITHUB_STEP_SUMMARY
        echo "| **Image Size** | ${{ steps.build-info.outputs.image-size }} bytes |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### üè∑Ô∏è Generated Tags" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ inputs.security-scan }}" = "true" ]; then
          echo "### üõ°Ô∏è Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "- **Scanner:** ${{ inputs.security-scanner }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Report:** Available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ inputs.sign-image }}" = "true" ]; then
          echo "### üîê Image Signing" >> $GITHUB_STEP_SUMMARY
          echo "- **Tool:** Cosign" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ github.event_name != 'pull_request' && 'Signed' || 'Skipped (PR)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

    - name: üìù Commit Dockerfile Version Update
      if: inputs.update-dockerfile-version == 'true' && startsWith(github.ref, 'refs/tags/v') && steps.update-dockerfile-version.outputs.version != ''
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "üìù Committing Dockerfile version update..."

        DOCKERFILE="${{ inputs.dockerfile-path }}"
        VERSION="${{ steps.update-dockerfile-version.outputs.version }}"
        GIT_TAG="${GITHUB_REF#refs/tags/}"

        # Check if there are actual changes
        if git diff --quiet "$DOCKERFILE"; then
          echo "‚ÑπÔ∏è No changes to commit - Dockerfile already up to date"
          exit 0
        fi

        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Get the default branch
        DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
        echo "üìå Default branch: $DEFAULT_BRANCH"

        # Fetch and checkout default branch
        git fetch origin "$DEFAULT_BRANCH"
        git checkout "$DEFAULT_BRANCH"

        # Apply the Dockerfile change to the default branch
        git checkout "${GITHUB_SHA}" -- "$DOCKERFILE"

        # Stage and commit
        git add "$DOCKERFILE"
        git commit -m "chore: update Dockerfile version to $VERSION

        Automatically updated org.opencontainers.image.version label
        from release tag $GIT_TAG

        ü§ñ Generated by docker-build action"

        # Push to default branch
        git push origin "$DEFAULT_BRANCH"

        echo "‚úÖ Dockerfile version updated and committed to $DEFAULT_BRANCH"
        echo "   Version: $VERSION"
        echo "   Tag: $GIT_TAG"

branding:
  icon: 'box'
  color: 'blue'