#cloud-config
package_update: true
package_upgrade: true
packages: [ca-certificates, curl, gnupg, jq, git]

write_files:
  - path: /etc/gha/host.env
    permissions: '0600'
    content: |
      TZ=Europe/Berlin
      RUNNER_SCOPE=org
      ORG_NAME=bauer-group
      REPO_URL=
      ENTERPRISE_NAME=
      RUNNER_COUNT=8
      # Auth â€“ entweder PAT (ACCESS_TOKEN) ODER GitHub App (empfohlen)
      GITHUB_PAT=
      APP_ID=
      APP_PRIVATE_KEY_BASE64=
      APP_LOGIN=

runcmd:
  - [ bash, -c, "set -euo pipefail;
      export $(grep -v '^#' /etc/gha/host.env | xargs -d '\n' -I{} echo {});
      BASE_DIR=/opt/gha; REPO_DIR=$BASE_DIR/runner;
      mkdir -p $BASE_DIR;
      git clone https://github.com/bauer-group/automation-templates.git $BASE_DIR/automation-templates || true;
      git -C $BASE_DIR/automation-templates pull --ff-only || true;
      rsync -a $BASE_DIR/automation-templates/github/runner/ $REPO_DIR/;
      cd $REPO_DIR;
      cp -n .env.example .env;
      sed -i "s|^TZ=.*|TZ=$TZ|" .env;
      sed -i "s|^RUNNER_SCOPE=.*|RUNNER_SCOPE=$RUNNER_SCOPE|" .env;
      sed -i "s|^ORG_NAME=.*|ORG_NAME=$ORG_NAME|" .env;
      sed -i "s|^REPO_URL=.*|REPO_URL=$REPO_URL|" .env;
      sed -i "s|^ENTERPRISE_NAME=.*|ENTERPRISE_NAME=$ENTERPRISE_NAME|" .env;
      sed -i "s|^RUNNER_COUNT=.*|RUNNER_COUNT=$RUNNER_COUNT|" .env;
      sed -i "s|^GITHUB_PAT=.*|GITHUB_PAT=$GITHUB_PAT|" .env;
      sed -i "s|^APP_ID=.*|APP_ID=$APP_ID|" .env;
      sed -i "s|^APP_LOGIN=.*|APP_LOGIN=$APP_LOGIN|" .env;
      if [ -n "$APP_PRIVATE_KEY_BASE64" ]; then
        CLEANED=$(echo "$APP_PRIVATE_KEY_BASE64" | base64 -d | sed ':a;N;$!ba;s/\n/\\n/g');
        sed -i "s|^APP_PRIVATE_KEY=.*|APP_PRIVATE_KEY=$CLEANED|" .env;
        sed -i "s|^GITHUB_PAT=.*|GITHUB_PAT=|" .env;
      fi;
      bash scripts/install.sh" ]
