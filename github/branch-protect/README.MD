# Branch Protection Automation (Python CLI)

Dieses Tool setzt oder aktualisiert **Branch-Protection-Regeln** fÃ¼r einen Ziel-Branch (Standard `main`) in allen Repositories einer GitHub-Organisation oder in einer expliziten Repo-Liste.  
Es verwendet direkte GitHub REST-API Aufrufe (Token-basiert) und kann optional Protection wieder entfernen.

---

## ðŸ“Œ Features

- PR-Pflicht vor jedem Merge
- Mindestens **2 Reviews** erforderlich (konfigurierbar)
- Alte Reviews werden ungÃ¼ltig, wenn neue Commits kommen
- Branch muss **up-to-date** mit `main` sein, bevor gemergt werden darf
- Offene Diskussionen in PRs mÃ¼ssen gelÃ¶st sein
- Optionale **Status-Checks** (Kontextnamen)
- Optionale **Push-Restrictions** (Teams/Benutzer)
- Optional **signierte Commits** erzwingen
- Option, Admins in den Schutz einzubeziehen
- Idempotentes Re-Apply (einfach erneut ausfÃ¼hren)
- Entfernen der Protection (`--delete`)
- Dry-Run zur sicheren Vorschau

---

## ðŸ“¦ Voraussetzungen

Python (protect_main.py):
- Python 3.9+
- Paket `requests` (wird vom Wrapper automatisch installiert)
- Personal Access Token: `export GITHUB_TOKEN=...` (oder `GH_TOKEN`)

Allgemein:
- Admin / Maintain Rechte auf den Repositories
- Branch muss existieren (sonst Warnung)

---

## âš™ï¸ Konfiguration

Konfiguration ausschlieÃŸlich Ã¼ber Flags / Environment. Du musst ENTWEDER Organisation ODER Repo-Liste definieren. Bei beidem gewinnt die Organisation.

| Variable                          | Beschreibung                                                                                          | Standard |
| --------------------------------- | ----------------------------------------------------------------------------------------------------- | -------- |
| `ORG` / `--org`                   | Name der GitHub Organisation. Wird ignoriert, wenn leer.                                              | â€“        |
| `REPO_LIST` / `--repos`           | Whitespace- oder zeilen-separierte Liste `owner/repo`. Nur nutzen, wenn `ORG` leer ist.               | â€“        |
| `BRANCH`                          | Zu schÃ¼tzender Branch                                                                                 | `main`   |
| `REVIEWS`                         | Anzahl benÃ¶tigter Reviews                                                                             | `2`      |
| `INCLUDE_ADMINS`                  | Admins in den Schutz einbeziehen (`true/false`)                                                       | `true`   |
| `LINEAR_HISTORY`                  | Lineare Historie erzwingen                                                                            | `true`   |
| `ALLOW_FORCE_PUSHES`              | Force-Pushes erlauben                                                                                 | `false`  |
| `ALLOW_DELETIONS`                 | Branch lÃ¶schen erlauben                                                                               | `false`  |
| `REQUIRE_CONVERSATION_RESOLUTION` | Offene PR-Diskussionen mÃ¼ssen gelÃ¶st sein                                                             | `true`   |
| `STRICT_UPTODATE`                 | PR muss vor Merge up-to-date mit Ziel-Branch sein                                                     | `true`   |
| `STATUS_CHECKS`                   | Liste von Status-Check Kontexten (z. B. `"ci/test lint build"`)                                      | â€“        |
| `RESTRICT_TEAMS`                  | Teams mit Push-/Bypass-Rechten                                                                        | â€“        |
| `RESTRICT_USERS`                  | Benutzer mit Push-/Bypass-Rechten                                                                     | â€“        |
| `REQUIRE_SIGNED_COMMITS`          | Signierte Commits erzwingen (`true/false`)                                                            | `false`  |
| `--delete`                        | Protection entfernen (statt setzen)                                                                  | â€“        |
| `--dry-run`                       | Nur anzeigen, keine Ã„nderungen                                                                       | â€“        |

### Wichtige Flags (Kurzreferenz)

| Flag / Env                         | Wirkung                                          |
| ---------------------------------- | ------------------------------------------------- |
| --org ORG                          | Alle Repos der Organisation                       |
| --repos r1 r2                      | Explizite Liste (owner/repo)                      |
| --branch main                      | Ziel-Branch                                       |
| --reviews 2                        | Anzahl benÃ¶tigter Reviews                         |
| --status-check build (repeatable)  | Status-Check Kontexte hinzufÃ¼gen                  |
| --team t1 (repeatable)             | Team mit Push-/Bypass-Rechten                     |
| --user u1 (repeatable)             | Benutzer mit Push-/Bypass-Rechten                 |
| --require-signed-commits           | Signierte Commits erzwingen                       |
| --allow-force-pushes               | Force-Pushes erlauben                             |
| --allow-deletions                  | Branch-LÃ¶schung erlauben                          |
| --no-include-admins                | Admins nicht einbeziehen                          |
| --no-linear-history                | Lineare Historie NICHT erzwingen                  |
| --no-require-conversation-resolution | GesprÃ¤chsauflÃ¶sung nicht erzwingen             |
| --no-strict-up-to-date             | Up-to-date Pflicht deaktivieren                   |
| --delete                           | Protection komplett entfernen                     |
| --dry-run                          | Nur anzeigen (keine Ã„nderungen)                   |

Hinweis: Mehrfach-Flags (`--status-check`, `--team`, `--user`) einfach wiederholen.

---

## ðŸš€ Nutzung

### 1. Alle Repos einer Organisation
```bash
export GITHUB_TOKEN=ghp_xxx
python src/protect_main.py --org mein-org
```

### 2. Organisation + Status-Checks
```bash
export GITHUB_TOKEN=ghp_xxx
python src/protect_main.py --org mein-org --status-check ci/test --status-check lint --status-check build
```

### 3. Team-EinschrÃ¤nkungen
```bash
export GITHUB_TOKEN=ghp_xxx
python src/protect_main.py --org mein-org --team maintainers --team release-managers
```

### 4. Signierte Commits erzwingen
```bash
export GITHUB_TOKEN=ghp_xxx
python src/protect_main.py --org mein-org --require-signed-commits
```

### 5. Konkrete Repo-Liste statt Organisation
```bash
export GITHUB_TOKEN=ghp_xxx
python src/protect_main.py --repos owner1/repoA owner2/repoB
```

Multiline Variante (bessere Lesbarkeit):
```bash
export GITHUB_TOKEN=ghp_xxx
python src/protect_main.py --repos owner1/repoA owner2/repoB owner3/repoC
```

### 6. Kombination: Repo-Liste + Status-Checks + Signaturen
```bash
export GITHUB_TOKEN=ghp_xxx
python src/protect_main.py --repos owner/repo1 owner/repo2 --status-check build --status-check lint --status-check test --require-signed-commits
```

### 7. Entfernen & Dry-Run
```bash
# Schutz entfernen (alle Regeln des Branches)
export GITHUB_TOKEN=ghp_xxx
python src/protect_main.py --repos owner1/repoA --delete

# Dry-Run (zeigt geplante REST-Calls)
python src/protect_main.py --org mein-org --dry-run

### 8. Wrapper verwenden (fÃ¼hrt Auto-Install aus)
```bash
./run_protection.sh --org mein-org --status-check build --status-check test
```
```

---

## ðŸ” Sicherheits-Workflow fÃ¼r das Team

Damit die Branch-Protection-Regeln auch im Alltag eingehalten werden, sollte das Team folgenden Ablauf nutzen:

1. **Feature-Branch anlegen**

   ```bash
   git checkout -b feature/neues-feature
   ```

2. **Ã„nderungen commiten**

   ```bash
   git add .
   git commit -m "feat: neues Feature hinzugefÃ¼gt"
   git push origin feature/neues-feature
   ```

3. **Pull Request erstellen**

   * Auf GitHub einen PR von `feature/neues-feature` â†’ `main` Ã¶ffnen.
   * PrÃ¼fen, ob alle **Status-Checks** (Tests, Builds, Linter) durchlaufen.

4. **Code-Review**

   * Mindestens **2 Teammitglieder** mÃ¼ssen den PR genehmigen.
   * Bei neuen Commits im PR mÃ¼ssen Reviews erneut erfolgen.

5. **Merge**

   * PR muss **up-to-date** mit `main` sein.
   * Alle Diskussionen mÃ¼ssen auf â€žresolvedâ€œ stehen.
   * Merge-Strategie: Squash & Merge oder Rebase & Merge (keine Merge-Commits, wenn mÃ¶glich).

6. **Branch lÃ¶schen**

   * Nach dem Merge den Feature-Branch lÃ¶schen (lokal und remote), um die Repo sauber zu halten.

ðŸ’¡ **Wichtig:** Direktes Pushen auf `main` ist durch die Regeln gesperrt â€“ Ã„nderungen *mÃ¼ssen* den PR-Prozess durchlaufen.

---

## ðŸ›  Hinweise

* Ohne Branch-Protection kann **jeder mit Push-Rechten** direkt auf `main` committen.
* Dieses Script erstellt eine **einheitliche Sicherheitskonfiguration** fÃ¼r alle Repos.
* Ã„nderungen an den Regeln kÃ¶nnen jederzeit erneut mit dem Script ausgerollt werden.
* Falls `ORG` leer ist, MUSS `REPO_LIST` Ã¼ber die Umgebung gesetzt werden â€“ das Script bricht sonst ab.
* Bei gleichzeitiger Angabe von `ORG` und `REPO_LIST` wird `REPO_LIST` ignoriert.
* Script-Ausgabe enthÃ¤lt Warnungen, falls ein Branch nicht existiert oder Rechte fehlen.
* Wrapper `run_protection.sh` installiert AbhÃ¤ngigkeiten automatisch.
* Entfernen einzelner Teilaspekte (z. B. nur Signaturen) wird von der GitHub API nicht granulÃ¤r angeboten â€“ `--delete` entfernt die komplette Protection-Konfiguration fÃ¼r den Branch.
* Re-Apply ist idempotent: unverÃ¤nderte Regeln verursachen keinen Fehler.
* FÃ¼r sehr groÃŸe Organisationen kann Paging > 100 Repos erforderlich sein (Python paged; Shell nutzt `gh repo list --limit 1000`).
