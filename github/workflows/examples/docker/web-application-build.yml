name: Docker Web Application Build Example
# Example: Complete web application Docker build with testing and deployment
#
# Publishes to: GitHub Container Registry (ghcr.io)
# Authentication: Automatic via GITHUB_TOKEN
#
# This example demonstrates:
# - Web-specific build optimizations
# - Node.js/React/Vue/Angular applications
# - Multi-platform support
# - Kubernetes deployment

on:
  push:
    branches: [main, develop, release/*]
    tags: ['v*.*.*']
  pull_request:
    branches: [main]
    paths:
      - 'Dockerfile'
      - 'src/**'
      - 'public/**'
      - 'package*.json'
      - 'yarn.lock'
      - '.dockerignore'

jobs:
  docker-build:
    name: Build & Deploy Web Application
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      # Publish to GHCR
      publish-to: 'ghcr'

      # Image configuration
      ghcr-image-name: 'my-web-app'

      # Build configuration
      dockerfile-path: './Dockerfile'
      docker-context: '.'
      build-target: 'production'
      platforms: 'linux/amd64,linux/arm64'
      multi-platform: true

      # Build arguments for web apps
      build-args: |
        {
          "NODE_ENV": "production",
          "APP_VERSION": "${{ github.ref_name }}",
          "COMMIT_SHA": "${{ github.sha }}"
        }

      # Tagging
      auto-tags: true
      latest-tag: true

      # Push configuration
      push: ${{ github.event_name != 'pull_request' }}

      # Security for web applications
      security-scan: true
      security-fail-on: 'HIGH'
      generate-sbom: true
      sign-image: true

      # Web application testing
      run-tests: true
      test-command: 'docker run --rm $IMAGE_TAG npm test'

      # Conditional deployment
      deploy-enabled: ${{ github.ref == 'refs/heads/main' }}
      deploy-environment: 'staging'

    # Required secrets:
    # - COSIGN_PRIVATE_KEY: For image signing
    # - COSIGN_PASSWORD: Cosign key password
    secrets: inherit
