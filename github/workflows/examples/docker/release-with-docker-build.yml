name: ðŸš€ Release & Docker Build

# Combined workflow: Creates a semantic release and then builds + publishes Docker images
# This solves the problem where GitHub Actions workflows created by GITHUB_TOKEN
# don't trigger other workflows (e.g., a release creating a tag won't trigger a tag-based Docker build)
#
# Security Note:
# The docker-build action runs security scans BEFORE pushing to the registry.
# If vulnerabilities above the threshold are found, the push is blocked.
# This prevents vulnerable images from being published.

on:
  push:
    branches: [main]
    paths-ignore:
      - '.github/**'
      - '*.md'
      - 'docs/**'
  pull_request:
    branches: [main]
    paths:
      - 'Dockerfile'
      - 'src/**'
      - 'package*.json'
      - 'tsconfig.json'
      - '.dockerignore'
  workflow_dispatch:
    inputs:
      force-release:
        description: 'Force create release'
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write
  security-events: write

jobs:
  # ============================================
  # Validation Jobs
  # ============================================

  validate-compose:
    name: ðŸ” Validate Docker Compose
    uses: bauer-group/automation-templates/.github/workflows/modules-validate-compose.yml@main
    with:
      compose-file: 'docker-compose.yml'
      # Optional: Provide environment variables for validation
      # env-template: |
      #   {
      #     "STACK_NAME": "my_app",
      #     "TIME_ZONE": "Etc/UTC"
      #   }

  validate-scripts:
    name: ðŸ” Validate Shell Scripts
    uses: bauer-group/automation-templates/.github/workflows/modules-validate-shellscript.yml@main
    with:
      scan-directory: '.'
      severity: 'warning'

  # ============================================
  # Release Job (only on main branch push)
  # ============================================

  release:
    name: ðŸ“¦ Create Semantic Release
    needs: [validate-compose, validate-scripts]
    if: |
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      needs.validate-compose.result == 'success' &&
      needs.validate-scripts.result == 'success'
    uses: bauer-group/automation-templates/.github/workflows/modules-semantic-release.yml@main
    with:
      target-branch: 'main'
      dry-run: false
      force-release: ${{ inputs.force-release || false }}
    secrets: inherit

  # ============================================
  # Docker Build Jobs
  # ============================================

  # Build & Push on successful release
  docker-build-release:
    name: ðŸ³ Build & Push Docker Image
    needs: release
    if: needs.release.outputs.release-created == 'true'
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      # Publish to both GHCR and Docker Hub
      publish-to: 'both'
      ghcr-image-name: 'your-org/your-app'
      docker-image-name: 'your-dockerhub-user/your-app'

      # KEY: Pass the release version to generate proper semver tags
      # This allows generating tags like 0.5.0, 0.5, latest without tag context
      release-version: ${{ needs.release.outputs.version }}

      # Update Dockerfile version label with the release version
      update-dockerfile-version: true

      # Tag configuration
      auto-tags: true
      latest-tag: true

      # Build configuration
      dockerfile-path: './Dockerfile'
      docker-context: '.'
      platforms: 'linux/amd64'

      # Always push on release
      push: true

      # Security scanning - runs BEFORE push
      # If CRITICAL vulnerabilities are found, the push is blocked
      security-scan: true
      security-fail-on: 'CRITICAL'
      generate-sbom: true

      # Sync README to Docker Hub
      sync-dockerhub-readme: true
    secrets: inherit

  # Validate build on PRs (no push)
  docker-build-pr:
    name: ðŸ”¨ Validate Docker Build (PR)
    needs: [validate-compose, validate-scripts]
    if: |
      github.event_name == 'pull_request' &&
      needs.validate-compose.result == 'success' &&
      needs.validate-scripts.result == 'success'
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      publish-to: 'ghcr'
      ghcr-image-name: 'your-org/your-app'

      auto-tags: true
      dockerfile-path: './Dockerfile'
      docker-context: '.'
      platforms: 'linux/amd64'

      # Don't push on PRs - just validate the build
      push: false

      # Security scan still runs to catch issues early
      security-scan: true
      security-fail-on: 'CRITICAL'
    secrets: inherit

  # ============================================
  # Pipeline Summary
  # ============================================

  summary:
    name: ðŸ“Š Pipeline Summary
    if: always() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    needs: [release, docker-build-release]
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "### ðŸš€ Release & Docker Build Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.release.outputs.release-created }}" = "true" ]; then
            echo "âœ… **Release ${{ needs.release.outputs.version }} created successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Check if image was pushed
            if [ "${{ needs.docker-build-release.outputs.image-pushed }}" = "true" ]; then
              echo "| Registry | Tags |" >> $GITHUB_STEP_SUMMARY
              echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
              echo "| GHCR | \`${{ needs.release.outputs.version }}\`, \`latest\` |" >> $GITHUB_STEP_SUMMARY
              echo "| Docker Hub | \`${{ needs.release.outputs.version }}\`, \`latest\` |" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ **Image was NOT pushed** (security scan may have failed)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Check the security scan results in the workflow artifacts." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ **No release created** (no releasable changes)" >> $GITHUB_STEP_SUMMARY
          fi
