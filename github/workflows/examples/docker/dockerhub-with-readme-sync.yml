name: Docker Hub Build with README Sync
# Example: Complete Docker workflow that builds, pushes to Docker Hub, and syncs README
#
# Security Note:
# The docker-build action runs security scans BEFORE pushing to the registry.
# If vulnerabilities above the threshold are found, the push is blocked.
# This prevents vulnerable images from being published.
#
# Publishes to: Docker Hub (docker.io)
# Authentication: DOCKER_USERNAME + DOCKER_PASSWORD secrets
#
# This example demonstrates:
# - Building and pushing Docker images to Docker Hub only
# - Automatic README synchronization
# - Multi-platform builds
# - Security scanning with configurable thresholds

on:
  push:
    branches: [main, develop]
    tags: ['v*.*.*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      force-push:
        description: 'Force push even on PR'
        type: boolean
        default: false

permissions:
  security-events: write

jobs:
  docker-build:
    name: Build & Push to Docker Hub
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      # Publish to Docker Hub only
      publish-to: 'dockerhub'

      # Image name on Docker Hub (username/image-name)
      docker-image-name: 'myuser/my-awesome-app'

      # Build Configuration
      dockerfile-path: './Dockerfile'
      docker-context: '.'
      platforms: 'linux/amd64,linux/arm64'
      multi-platform: true

      # Tagging Strategy
      auto-tags: true
      latest-tag: true

      # Push Configuration
      push: ${{ github.event_name != 'pull_request' || github.event.inputs.force-push == 'true' }}

      # Docker Hub README Sync
      sync-dockerhub-readme: true
      readme-file: '' # Auto-detect: DOCKER_README.MD -> README.MD -> README.md

      # Security & Quality - scans run BEFORE push
      # If vulnerabilities are found above the threshold, push is blocked
      security-scan: true
      security-scanner: 'trivy'
      security-fail-on: 'HIGH'
      generate-sbom: true

      # Performance
      cache-enabled: true
      cache-mode: 'max'
      build-timeout: 30

    # Required secrets:
    # - DOCKER_USERNAME: Docker Hub username
    # - DOCKER_PASSWORD: Docker Hub password/token
    secrets: inherit

  # Post-build notification with security status
  notify:
    needs: docker-build
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Build Results Summary
        run: |
          echo "## Docker Hub Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry:** Docker Hub (docker.io)" >> $GITHUB_STEP_SUMMARY
          echo "- **Image URL:** \`${{ needs.docker-build.outputs.image-url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest:** \`${{ needs.docker-build.outputs.image-digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Security Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.docker-build.outputs.security-scan-passed }}" = "true" ]; then
            echo "✅ Security scan passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.docker-build.outputs.security-scan-passed }}" = "false" ]; then
            echo "❌ Security scan failed - vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "⏭️ Security scan skipped" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Build Result" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.docker-build.outputs.image-pushed }}" = "true" ]; then
            echo "✅ Image pushed successfully!" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.docker-build.outputs.security-scan-passed }}" = "false" ]; then
            echo "❌ Image NOT pushed due to security vulnerabilities" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.docker-build.result }}" = "success" ]; then
            echo "ℹ️ Build completed (push skipped)" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Build failed! Please check the logs." >> $GITHUB_STEP_SUMMARY
          fi
