name: Docker Microservice Build Example
# Example: Microservice Docker build with comprehensive testing and Kubernetes deployment
#
# Publishes to: GitHub Container Registry (ghcr.io)
# Authentication: Automatic via GITHUB_TOKEN
#
# This example demonstrates:
# - Microservice-specific patterns
# - Go/Rust/Python service builds
# - Helm-based Kubernetes deployment
# - Multi-environment support

on:
  push:
    branches: [main, develop, feature/*]
    tags: ['v*.*.*']
  pull_request:
    branches: [main, develop]
    paths:
      - 'Dockerfile'
      - 'src/**'
      - 'api/**'
      - 'go.mod'
      - 'go.sum'
      - 'helm/**'
      - '.dockerignore'

env:
  SERVICE_NAME: 'user-service'
  NAMESPACE: 'microservices'

jobs:
  docker-build:
    name: Build & Deploy Microservice
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      # Publish to GHCR
      publish-to: 'ghcr'

      # Service configuration
      image-name: 'user-service'

      # Build configuration for microservices
      dockerfile-path: './Dockerfile'
      docker-context: '.'
      build-target: 'runtime'
      platforms: 'linux/amd64,linux/arm64'
      multi-platform: true

      # Microservice build arguments
      build-args: |
        {
          "SERVICE_NAME": "user-service",
          "SERVICE_VERSION": "${{ github.ref_name }}",
          "VERSION": "${{ github.sha }}",
          "ENVIRONMENT": "production",
          "LOG_LEVEL": "info"
        }

      # Tagging
      auto-tags: true
      latest-tag: true

      # Push configuration
      push: ${{ github.event_name != 'pull_request' }}

      # Security for microservices
      security-scan: true
      security-fail-on: 'CRITICAL'
      generate-sbom: true
      sbom-format: 'cyclonedx'
      sign-image: true

      # Microservice testing
      run-tests: true
      test-command: 'docker run --rm $IMAGE_TAG test'

      # Performance optimization
      cache-enabled: true
      cache-mode: 'max'
      build-timeout: 30

      # Microservice deployment
      deploy-enabled: ${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') }}
      deploy-environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

    # Required secrets:
    # - COSIGN_PRIVATE_KEY: For image signing
    # - COSIGN_PASSWORD: Cosign key password
    secrets: inherit
