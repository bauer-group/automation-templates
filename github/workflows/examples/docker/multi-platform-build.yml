name: Docker Multi-Platform Build Example
# Example: Multi-platform Docker build for ARM64 and AMD64 architectures
#
# Publishes to: GitHub Container Registry (ghcr.io)
# Authentication: Automatic via GITHUB_TOKEN
#
# This example demonstrates:
# - Cross-platform builds for cloud and edge deployment
# - linux/amd64, linux/arm64, linux/arm/v7 support
# - Efficient caching for multi-platform builds

on:
  push:
    branches: [main, develop]
    tags: ['v*.*.*']
  pull_request:
    branches: [main]
    paths:
      - 'Dockerfile'
      - 'src/**'
      - '.dockerignore'

jobs:
  docker-build:
    name: Multi-Platform Docker Build
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      # Publish to GHCR (default)
      publish-to: 'ghcr'

      # Image configuration
      image-name: 'multi-platform-app'

      # Multi-platform build configuration
      dockerfile-path: './Dockerfile'
      docker-context: '.'
      platforms: 'linux/amd64,linux/arm64,linux/arm/v7'
      multi-platform: true

      # Tagging
      auto-tags: true
      latest-tag: true

      # Push configuration
      push: ${{ github.event_name != 'pull_request' }}

      # Security scanning
      security-scan: true
      security-fail-on: 'CRITICAL'
      generate-sbom: true

      # Performance optimization for multi-platform
      cache-enabled: true
      cache-mode: 'max'
      build-timeout: 45

    secrets: inherit

  # Manifest verification (optional)
  verify-manifest:
    name: Verify Multi-Arch Manifest
    needs: docker-build
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
      - name: Verify Manifest
        run: |
          echo "## Multi-Platform Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Platforms Built" >> $GITHUB_STEP_SUMMARY
          echo "- linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "- linux/arm/v7" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** \`${{ needs.docker-build.outputs.image-url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest:** \`${{ needs.docker-build.outputs.image-digest }}\`" >> $GITHUB_STEP_SUMMARY
