name: Docker Enterprise Build Example
# Example: Enterprise-grade Docker build with maximum security and compliance
#
# Publishes to: Both GHCR and Docker Hub
# Authentication: GITHUB_TOKEN (automatic) + DOCKER_USERNAME/DOCKER_PASSWORD
#
# This example demonstrates:
# - Multi-registry publishing (build once, push to both)
# - Maximum security configuration
# - Image signing with Cosign
# - SBOM generation
# - Compliance validation

on:
  push:
    branches: [main, release/*]
    tags: ['v*.*.*']
  pull_request:
    branches: [main]
    paths:
      - 'Dockerfile'
      - 'src/**'
      - 'k8s/**'
      - 'helm/**'
      - '.dockerignore'
  schedule:
    # Weekly security scan
    - cron: '0 2 * * 1'

env:
  APP_NAME: 'enterprise-app'

jobs:
  compliance-check:
    name: Compliance Validation
    runs-on: ubuntu-latest
    outputs:
      approved: ${{ steps.compliance.outputs.approved }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compliance Check
        id: compliance
        run: |
          # Validate compliance requirements
          echo "approved=true" >> $GITHUB_OUTPUT

  docker-build:
    name: Enterprise Docker Build
    needs: compliance-check
    if: needs.compliance-check.outputs.approved == 'true'
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      # Publish to both registries (build once, push to both)
      publish-to: 'both'

      # Image names
      image-name: 'my-org/enterprise-app'           # GHCR image
      secondary-image-name: 'myuser/enterprise-app' # Docker Hub image

      # Build configuration
      dockerfile-path: './Dockerfile'
      docker-context: '.'
      build-target: 'production'
      platforms: 'linux/amd64,linux/arm64'
      multi-platform: true

      # Build arguments
      build-args: |
        {
          "BUILDTIME": "${{ github.event.head_commit.timestamp }}",
          "VERSION": "${{ github.sha }}",
          "ENVIRONMENT": "production"
        }

      # Version management
      update-dockerfile-version: true
      version-from-dockerfile: ${{ !startsWith(github.ref, 'refs/tags/v') }}

      # Tagging
      auto-tags: true
      latest-tag: true

      # Push configuration
      push: ${{ github.event_name != 'pull_request' }}

      # Maximum security configuration
      security-scan: true
      security-scanner: 'trivy'
      security-fail-on: 'MEDIUM'
      security-ignore-unfixed: false
      sign-image: true
      generate-sbom: true
      sbom-format: 'spdx'

      # Testing
      run-tests: true
      test-command: 'docker run --rm $IMAGE_TAG --version'

      # Performance
      cache-enabled: true
      cache-mode: 'max'
      builder-driver: 'docker-container'
      build-timeout: 60

      # Docker Hub README sync
      sync-dockerhub-readme: true

      # Deployment (only on main branch)
      deploy-enabled: ${{ github.ref == 'refs/heads/main' }}
      deploy-environment: 'production'

    # Required secrets:
    # - DOCKER_USERNAME: Docker Hub username
    # - DOCKER_PASSWORD: Docker Hub password/token
    # - COSIGN_PRIVATE_KEY: For image signing
    # - COSIGN_PASSWORD: Cosign key password
    secrets: inherit

  security-report:
    name: Security Report
    needs: docker-build
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Security Report
        run: |
          echo "## Enterprise Security Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Image URL:** \`${{ needs.docker-build.outputs.image-url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest:** \`${{ needs.docker-build.outputs.image-digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Report:** ${{ needs.docker-build.outputs.security-report }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify Security Team
        if: failure()
        run: |
          echo "Security scan failed - notifying security team"
          # Add notification logic here (Slack, email, etc.)
