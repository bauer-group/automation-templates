name: Docker Security-Focused Build Example
# Example: Security-first Docker build with comprehensive vulnerability scanning
#
# Publishes to: GitHub Container Registry (ghcr.io)
# Authentication: Automatic via GITHUB_TOKEN
#
# This example demonstrates:
# - Strict security scanning (LOW severity threshold)
# - Image signing with Cosign
# - SBOM generation
# - Pre-build security analysis

on:
  push:
    branches: [main, security/*]
    tags: ['v*.*.*']
  pull_request:
    branches: [main]
    paths:
      - 'Dockerfile'
      - 'Dockerfile.security'
      - 'src/**'
      - 'security/**'
      - '.dockerignore'
  schedule:
    # Daily security scan
    - cron: '0 6 * * *'

jobs:
  security-scan-pre-build:
    name: Pre-Build Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dockerfile Security Scan
        run: |
          echo "Scanning Dockerfile for security issues..."
          # Add hadolint or dockerfile-lint here

      - name: Source Code Security Scan
        run: |
          echo "Scanning source code for vulnerabilities..."
          # Add semgrep, bandit, or other SAST tools here

  docker-build:
    name: Secure Docker Build
    needs: security-scan-pre-build
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      # Publish to GHCR
      publish-to: 'ghcr'

      # Secure image configuration
      image-name: 'secure-app'

      # Security-hardened build
      dockerfile-path: './Dockerfile'
      docker-context: '.'
      build-target: 'production-secure'

      # Tagging
      auto-tags: true
      latest-tag: true

      # Push configuration
      push: ${{ github.event_name != 'pull_request' }}

      # Strict security configuration
      security-scan: true
      security-scanner: 'trivy'
      security-fail-on: 'LOW'  # Very strict
      security-ignore-unfixed: false
      sign-image: true
      generate-sbom: true
      sbom-format: 'cyclonedx'

      # Testing
      run-tests: true
      test-command: 'docker run --rm --read-only --tmpfs /tmp $IMAGE_TAG --version'

    # Required secrets:
    # - COSIGN_PRIVATE_KEY: For image signing
    # - COSIGN_PASSWORD: Cosign key password
    secrets: inherit

  security-report:
    name: Security Assessment Report
    needs: docker-build
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Security Report
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Fail Threshold:** LOW (strict)" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Signed:** Yes" >> $GITHUB_STEP_SUMMARY
          echo "- **SBOM Generated:** Yes (CycloneDX)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest:** \`${{ needs.docker-build.outputs.image-digest }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Notify Security Team
        if: failure()
        run: |
          echo "Security vulnerabilities found - notifying security team"
          # Add notification logic here
