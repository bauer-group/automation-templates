# Kombinierte Docker-Validierung
# Validiert Dockerfiles, Docker Compose und Shell-Scripts zusammen

name: üê≥ Complete Docker Validation

on:
  push:
    paths:
      - '**/Dockerfile*'
      - '**/*.Dockerfile'
      - '**/docker-compose*.yml'
      - '**/docker-compose*.yaml'
      - 'scripts/**/*.sh'
      - 'docker/**'
  pull_request:
    paths:
      - '**/Dockerfile*'
      - '**/*.Dockerfile'
      - '**/docker-compose*.yml'
      - '**/docker-compose*.yaml'
      - 'scripts/**/*.sh'
      - 'docker/**'

jobs:
  # Dockerfile Linting mit Hadolint
  dockerfile-lint:
    name: üê≥ Hadolint
    uses: bauer-group/automation-templates/.github/workflows/modules-validate-dockerfile.yml@main
    with:
      failure-threshold: 'warning'
      trusted-registries: '["docker.io", "ghcr.io"]'
      ignore-rules: '["DL3008", "DL3013"]'

  # Docker Compose Validierung
  compose-validate:
    name: üìã Compose
    uses: bauer-group/automation-templates/.github/workflows/modules-validate-compose.yml@main
    with:
      compose-files: '["docker-compose.yml", "docker-compose.override.yml"]'
      create-dummy-env: true
      fail-on-warning: false

  # Shell Script Validierung (f√ºr Entrypoints und Build-Scripts)
  shellcheck:
    name: üêö ShellCheck
    uses: bauer-group/automation-templates/.github/workflows/modules-validate-shellscript.yml@main
    with:
      scan-paths: '["scripts/", "docker/"]'
      severity: 'warning'
      fail-on-findings: true

  # Zusammenfassung aller Validierungen
  validation-summary:
    name: üìä Summary
    needs: [dockerfile-lint, compose-validate, shellcheck]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: üìä Generate Summary
        run: |
          echo "## üê≥ Docker Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Hadolint
          if [ "${{ needs.dockerfile-lint.outputs.passed }}" = "true" ]; then
            echo "‚úÖ **Hadolint** - ${{ needs.dockerfile-lint.outputs.files-checked }} files checked" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Hadolint** - ${{ needs.dockerfile-lint.outputs.issues-found }} issues found" >> $GITHUB_STEP_SUMMARY
          fi

          # Compose
          if [ "${{ needs.compose-validate.outputs.valid }}" = "true" ]; then
            echo "‚úÖ **Docker Compose** - ${{ needs.compose-validate.outputs.service-count }} services validated" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Docker Compose** - Invalid configuration" >> $GITHUB_STEP_SUMMARY
          fi

          # ShellCheck
          if [ "${{ needs.shellcheck.outputs.passed }}" = "true" ]; then
            echo "‚úÖ **ShellCheck** - ${{ needs.shellcheck.outputs.files-checked }} scripts checked" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **ShellCheck** - ${{ needs.shellcheck.outputs.issues-found }} issues found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall Status
          if [ "${{ needs.dockerfile-lint.outputs.passed }}" = "true" ] && \
             [ "${{ needs.compose-validate.outputs.valid }}" = "true" ] && \
             [ "${{ needs.shellcheck.outputs.passed }}" = "true" ]; then
            echo "### ‚úÖ All validations passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ö†Ô∏è Some validations failed - please review above" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ‚ùå Fail if any validation failed
        if: |
          needs.dockerfile-lint.outputs.passed != 'true' ||
          needs.compose-validate.outputs.valid != 'true' ||
          needs.shellcheck.outputs.passed != 'true'
        run: exit 1
